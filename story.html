<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>WHO VQ — 物語（制作中）</title>
<style>
  :root{ --ui: rgba(0,0,0,.45); }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;background:#000;color:#fff;font-family:system-ui,"Noto Sans JP",sans-serif}
  .wrap{position:relative;min-height:100vh;display:flex;align-items:center;justify-content:center}
  .bg{position:absolute;inset:0;background:
    radial-gradient(1000px 600px at 50% 10%, rgba(255,220,160,.35), transparent 60%),
    linear-gradient(180deg,#87ceeb 0%,#98d8e8 40%,#4682b4 100%);
    filter:brightness(0.9)}
  .card{position:relative;z-index:1;max-width:720px;margin:24px;padding:20px;border-radius:16px;border:1px solid rgba(255,255,255,.2);background:var(--ui);backdrop-filter:blur(6px)}
  h1{font-size:24px;margin-bottom:8px}
  p{opacity:.95;line-height:1.7}
  .btn{margin-top:14px;padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.3);background:rgba(255,255,255,.08);color:#fff;cursor:pointer}
  /* 立ち絵 */
  #friendWrap{position:absolute;right:6vw;bottom:6vh;width:min(24vh,220px);aspect-ratio:1/1;filter:drop-shadow(0 8px 12px rgba(0,0,0,.45))}
  #friend,#friendWrap .equip{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:100%;height:100%;object-fit:contain}
</style>
</head>
<body>
<div class="wrap">
  <div class="bg"></div>
  <div class="card">
    <h1>会話シーンは制作中です</h1>
    <p>装備は右下の立ち絵に反映されています。制作が整うまで、交換所へ戻って装備や演出をお楽しみください。</p>
    <button class="btn" onclick="location.href='exchange.html'">交換所へ戻る</button>
  </div>

  <div id="friendWrap" aria-label="friend">
    <img id="friend" alt="friend" />
    <img class="equip equip--style" data-slot="style" alt="" />
    <img class="equip equip--head" data-slot="head" alt="" />
    <img class="equip equip--body" data-slot="body" alt="" />
    <img class="equip equip--back" data-slot="back" alt="" />
    <img class="equip equip--hands" data-slot="hands" alt="" />
    <img class="equip equip--shoes" data-slot="shoes" alt="" />
  </div>
</div>

<script>
const $=s=>document.querySelector(s);
function readJSON(k,f){ try{const v=localStorage.getItem(k);return v?JSON.parse(v):f;}catch(e){return f;} }
const ANCHOR={head:{x:0,y:-42,scale:1},body:{x:0,y:-2,scale:1},back:{x:-6,y:-6,scale:1},hands:{x:10,y:0,scale:1},shoes:{x:6,y:44,scale:1},style:{x:0,y:0,scale:1}};
function resolveFriendSrc(){ const color=(localStorage.getItem('who_character')||'pink').replace(/[^a-z]/g,'')||'pink'; return `public/assets/stage1/${color}_open.png`; }
function setEquipLayer(slot, pid){
  const el = document.querySelector(`.equip--${slot}`);
  if(!el) return;
  if(!pid){ el.style.display='none'; el.removeAttribute('src'); return; }
  const src = `public/stage1/equip/${slot}/${pid}.png`;
  const img = new Image(); img.crossOrigin='anonymous';
  img.onload=()=>{ el.src=src; el.style.display='block'; const a=ANCHOR[slot]||{x:0,y:0,scale:1}; el.style.transform=`translate(calc(-50% + ${a.x}px), calc(-50% + ${a.y}px)) scale(${a.scale})`; };
  img.onerror=()=>{ el.style.display='none'; el.removeAttribute('src'); };
  img.src=src;
}
function applyEquipment(){
  const eq = readJSON('who_equipment', {head:null,body:null,back:null,hands:null,shoes:null,style:null});
  Object.entries(eq).forEach(([slot,pid])=>setEquipLayer(slot,pid));
}
(function init(){
  const friend = $('#friend');
  friend.src = resolveFriendSrc();
  friend.crossOrigin='anonymous';
  applyEquipment();
})();
</script>
</body>
</html>
