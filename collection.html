<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>WHOAI | コレクション & アクセ装着</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg:#0b0f14; --panel:#121922; --panel-soft:#0f151d; --text:#eaf2ff;
    --muted:#9fb2c9; --accent:#7dd3fc; --ok:#22c55e; --warn:#f59e0b;
    --chip:#1e293b; --card:#0f172a; --ring:#334155; --shadow:0 10px 25px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
    font-family:system-ui,"Noto Sans JP","Hiragino Kaku Gothic ProN",Meiryo,sans-serif}
  .wrap{min-height:100dvh;display:flex;flex-direction:column}
  header{position:sticky;top:0;z-index:20;padding:10px 14px;
    background:linear-gradient(180deg,rgba(0,0,0,.7),rgba(0,0,0,0));
    border-bottom:1px solid #0b1220}
  .topbar{display:flex;gap:10px;align-items:center}
  .title{font-weight:700;letter-spacing:.02em}
  .spacer{flex:1}
  .btn{appearance:none;border:none;cursor:pointer;background:var(--panel);color:var(--text);
    padding:8px 12px;border-radius:12px;box-shadow:var(--shadow);
    border:1px solid var(--ring);transition:transform .05s ease,filter .2s ease,background .2s ease;font-weight:600}
  .btn:hover{filter:brightness(1.08)} .btn:active{transform:translateY(1px)}
  .btn.acc{background:var(--accent);color:#002235;border-color:transparent}
  .btn.ok{background:var(--ok);color:#01210f;border-color:transparent}
  .btn.warn{background:var(--warn);color:#2d1a00;border-color:transparent}
  main{padding:16px;display:grid;gap:14px;grid-template-columns: 1.1fr 1fr}
  @media (max-width:980px){ main{grid-template-columns: 1fr;}}
  .panel{background:linear-gradient(180deg,var(--panel),var(--panel-soft));
    border:1px solid var(--ring);border-radius:18px;padding:14px;box-shadow:var(--shadow)}
  .stage{position:relative;min-height:60vh;display:grid;place-items:center}
  .stage .canvasWrap{position:relative;width:min(92vw,780px);aspect-ratio:16/9;border:1px solid var(--ring);border-radius:16px;overflow:hidden;background:#08121c}
  canvas{display:block;width:100%;height:100%}
  .stage .hud{position:absolute;top:10px;left:10px;display:flex;gap:8px;align-items:center}
  .tag{font-size:.78rem;background:var(--chip);border:1px solid var(--ring);
    padding:4px 8px;border-radius:999px;color:var(--muted);font-weight:700}
  .status{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .gallery{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(180px,1fr))}
  .card{background:var(--card);border:1px solid var(--ring);border-radius:18px;overflow:hidden;display:flex;flex-direction:column}
  .thumb{aspect-ratio:1/1;background:#0b1420;display:grid;place-items:center;position:relative}
  .thumb img{width:80%;height:80%;object-fit:contain;filter:drop-shadow(0 8px 12px rgba(0,0,0,.5))}
  .thumb .ph{
    width:70%;height:70%;border-radius:16px;background:#152338;border:1px dashed var(--ring);
    display:grid;place-items:center;color:var(--muted);font-size:.8rem;padding:6px;text-align:center
  }
  .body{padding:10px 12px;display:flex;flex-direction:column;gap:6px}
  .name{font-weight:700}
  .tags{display:flex;gap:6px;flex-wrap:wrap}
  .count{font-size:1rem;font-weight:800}
  .cta{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap}
  .empty{padding:20px;border:1px dashed var(--ring);border-radius:16px;color:var(--muted);text-align:center}
  .footnav{display:flex;gap:10px;justify-content:flex-end}
  .hint{opacity:.9}
  .loading{
    position:absolute;inset:0;display:grid;place-items:center;color:var(--muted);font-size:.95rem;
    background:linear-gradient(180deg,rgba(0,0,0,.28),rgba(0,0,0,.12))
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="topbar">
      <button class="btn" id="backBtn">← 戻る</button>
      <div class="title">コレクション & 装着</div>
      <div class="spacer"></div>
      <button class="btn acc" id="toAccessory">ショップへ</button>
      <button class="btn" id="toAsari">潮干狩りへ</button>
    </div>
  </header>

  <main>
    <!-- 左：ステージ（キャラ＋装着プレビュー） -->
    <section class="panel stage">
      <div class="canvasWrap">
        <div class="hud">
          <span class="tag" id="charLabel">キャラ：-</span>
          <span class="tag">装着中: <b id="equipCount">0</b> 点</span>
        </div>
        <canvas id="scene"></canvas>
        <div id="loading" class="loading" hidden>画像を読み込み中…</div>
      </div>
      <p class="hint" style="margin-top:10px">装着ボタンでON/OFF。プレビューは一時的に表示するだけ（装着はしません）。</p>
    </section>

    <!-- 右：所持アクセ -->
    <section class="panel">
      <div class="status" style="margin-bottom:10px">
        <div>残りアクセサリーポイント: <b id="apRemain">0</b></div>
      </div>
      <div id="invGallery" class="gallery"></div>
      <div id="emptyInv" class="empty" style="display:none">所持アクセがありません。<br>ショップで購入するとここに並びます。</div>

      <div class="footnav" style="margin-top:12px">
        <button class="btn" id="toIndex">タイトルへ</button>
        <button class="btn" id="toAccessory2">ショップへ</button>
      </div>
    </section>
  </main>
</div>

<script>
/* ========= 画像パス ========= */
const BG = {
  sunrise:'public/bg/sunrise.jpg',
  day:'public/bg/beach_day.jpg',
  night:'public/bg/night_beach.jpg'
};
const CHAR_IMG = (color)=>`public/assets/stage1/${color}_open.png`; // ★チカチカ防止：1枚固定
const ACC_IMG  = (file)=>`public/accessories/${file}`;

/* ========= アクセ定義（ショップと同じID） ========= */
const ACCESSORY_DEFS = [
  { id:'knit_hat',      name:'ニット帽',     img: ACC_IMG('knit_hat.png')      },
  { id:'star_yellow',   name:'スター（黄）', img: ACC_IMG('star_yellow.png')   },
  { id:'ribbon_yellow', name:'リボン（黄）', img: ACC_IMG('ribbon_yellow.png') },
  { id:'straw_hat',     name:'麦わら帽子',   img: ACC_IMG('straw_hat.png')     },
  { id:'sunglasses',    name:'サングラス',   img: ACC_IMG('sunglasses.png')    },
];

/* ========= オフセット（キャラ画像に対する相対配置） =========
   anchorX,anchorY をキャラ画像の「中心」を基準にした相対座標として設定。
   scale はキャラ基準サイズ（W=H=120px想定）に対する倍率。
   colorごとにズレが必要なら、色キーで上書きできます。 */
const ACC_PLACEMENT = {
  knit_hat:     { x: 0,   y:-62,  scale:1.05 },
  straw_hat:    { x: 0,   y:-60,  scale:1.12 },
  ribbon_yellow:{ x: 38,  y:-38,  scale:0.80 },
  star_yellow:  { x: 0,   y:  0,  scale:0.85 },
  sunglasses:   { x: 0,   y:-36,  scale:0.90 }
};
// 色別微調整をしたい場合の例：
// const COLOR_TWEAKS = { pink: {sunglasses:{y:-34}}, blue:{straw_hat:{y:-58}} };
const COLOR_TWEAKS = {};

/* ========= LSキー ========= */
const LS = {
  apRemain:'who_accessory_points',
  inventory:'who_accessory_inventory',  // {id: count}
  equip:'who_accessory_equip',          // string[]  装着中ID
  character:'who_character',            // {type:'tane', color:'pink|...'}
  lastPage:'who_lastPage'
};
const getLS=(k,def=null)=>{try{const v=localStorage.getItem(k);return v==null?def:JSON.parse(v);}catch{return def;}};
const setLS=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

/* ========= 状態 ========= */
const state = {
  color: getColorFromCharacter(),
  apRemain: getLS(LS.apRemain,0),
  inventory: normalizeInventory(getLS(LS.inventory,{})),
  equip: new Set(getLS(LS.equip,[])), // Setで扱いやすく
  bgPhase: getSavedPhase(),
  images: { bg:null, char:null, acc:{} },
  ready: { bg:false, char:false },
  lastFrame: null // 直前のCanvas画像（キャラが一瞬消えないよう保持）
};

function getColorFromCharacter(){
  try{
    const saved = JSON.parse(localStorage.getItem(LS.character)||'null');
    const c = (saved && saved.color) ? String(saved.color).toLowerCase() : null;
    const ok = ['pink','blue','green','purple'];
    const color = ok.includes(c)? c : 'pink';
    // 互換のため旧キーにも書いておく（任意）
    localStorage.setItem('who_char_color', color);
    return color;
  }catch{ return 'pink'; }
}

function normalizeInventory(inv){
  const base = Object.fromEntries(ACCESSORY_DEFS.map(a=>[a.id,0]));
  return Object.assign(base, inv||{});
}

function getSavedPhase(){
  const p = localStorage.getItem('who_timePhase');
  return ['sunrise','day','night'].includes(p)? p : inferPhaseByClock();
}
function inferPhaseByClock(){
  const h = new Date().getHours();
  if(h>=18||h<5) return 'night';
  if(h>=5&&h<9)  return 'sunrise';
  return 'day';
}

/* ========= DOM ========= */
const apRemainEl = document.getElementById('apRemain');
const invGallery = document.getElementById('invGallery');
const emptyInvEl = document.getElementById('emptyInv');
const equipCountEl = document.getElementById('equipCount');
const charLabelEl = document.getElementById('charLabel');
const loadingEl = document.getElementById('loading');

/* ========= Canvas ========= */
const scene = document.getElementById('scene');
const ctx = scene.getContext('2d', { alpha: true });
ctx.imageSmoothingEnabled = true;

function resize(){
  const wrap = scene.parentElement; // .canvasWrap
  const rect = wrap.getBoundingClientRect();
  scene.width = Math.floor(rect.width);
  scene.height = Math.floor(rect.height);
  draw();
}
addEventListener('resize', resize);

/* ========= 画像ロード（フォールバック絵は描かない・ただし前フレーム保持） ========= */
function loadImages(){
  loadingEl.hidden = false;

  // 背景
  const bg = new Image();
  bg.src = BG[state.bgPhase];
  bg.onload = ()=>{state.images.bg=bg; state.ready.bg=true; maybeReady();};
  bg.onerror= ()=>{state.ready.bg=true; maybeReady();};

  // キャラ：1枚のみ（チカチカなし）
  const ch = new Image();
  ch.src = CHAR_IMG(state.color);
  ch.onload = ()=>{state.images.char=ch; state.ready.char=true; maybeReady();};
  ch.onerror= ()=>{console.warn('CHAR IMG missing:', ch.src); state.ready.char=true; maybeReady();};

  // 所持アクセだけ読む
  for(const def of ACCESSORY_DEFS){
    if((state.inventory[def.id]||0) <= 0) continue;
    const im = new Image();
    im.src = def.img;
    im.onload = ()=>{ state.images.acc[def.id] = im; /* no-op */ };
    im.onerror= ()=>{ console.warn('ACC IMG missing:', def.img); };
  }
}

function maybeReady(){
  if(state.ready.bg && state.ready.char){
    loadingEl.hidden = true;
    draw();
  }
}

/* ========= 描画 ========= */
function draw(){
  if(scene.width===0 || scene.height===0) return;

  // 背景
  ctx.clearRect(0,0,scene.width,scene.height);
  if(state.images.bg && state.images.bg.naturalWidth){
    ctx.drawImage(state.images.bg, 0, 0, scene.width, scene.height);
  }else{
    // 背景が無くても塗りつぶしておく（キャラが消えて見えない対策）
    ctx.fillStyle = '#08121c';
    ctx.fillRect(0,0,scene.width,scene.height);
  }

  // キャラ
  const charDrawn = drawCharacter();

  // アクセ（装着中のみ）
  drawAccessories();

  // 最後にフレームを保存（次フレームの保険）
  try{
    state.lastFrame = ctx.getImageData(0,0,scene.width,scene.height);
  }catch(e){
    // 取得に失敗しても無視
  }

  // 画像未準備でキャラが描けなかった場合は直前フレームで埋め戻し
  if(!charDrawn && state.lastFrame){
    ctx.putImageData(state.lastFrame, 0, 0);
  }
}

function drawCharacter(){
  const ch = state.images.char;
  if(!(ch && ch.complete && ch.naturalWidth)) return false;

  // キャラの基準サイズと配置（中央やや下）
  const baseSize = Math.min(scene.width, scene.height) * 0.28; // 画面比率
  const W = baseSize, H = baseSize;
  const cx = scene.width * 0.5;
  const cy = scene.height * 0.72;

  // 影
  ctx.save();
  ctx.globalAlpha = 0.25;
  ctx.fillStyle = '#000';
  ctx.beginPath();
  ctx.ellipse(cx, cy + H*0.18, W*0.33, H*0.07, 0, 0, Math.PI*2);
  ctx.fill();
  ctx.restore();

  // 本体（1枚固定でチカチカしない）
  ctx.drawImage(ch, cx - W/2, cy - H, W, H);

  // キャラの描画枠を保存（アクセ配置用）
  state._charFrame = { cx, cy, W, H };
  return true;
}

function drawAccessories(){
  if(!state._charFrame) return;
  const f = state._charFrame;
  let count = 0;

  for(const id of state.equip){
    const def = ACCESSORY_DEFS.find(a=>a.id===id);
    if(!def) continue;
    const im = state.images.acc[id];
    if(!(im && im.complete && im.naturalWidth)) continue;

    // 基本プレースメント
    const base = Object.assign({}, ACC_PLACEMENT[id] || {x:0,y:0,scale:1});
    // 色別微調整
    if(COLOR_TWEAKS[state.color] && COLOR_TWEAKS[state.color][id]){
      Object.assign(base, COLOR_TWEAKS[state.color][id]);
    }

    // スケーリング：キャラWに合わせて拡大
    const s = base.scale * (f.W / 120); // 定義は120px基準
    const w = im.naturalWidth * s;
    const h = im.naturalHeight * s;

    const x = f.cx + base.x*(f.W/120) - w/2;
    const y = f.cy - f.H + (base.y*(f.H/120)) - h/2;

    ctx.drawImage(im, Math.round(x), Math.round(y), Math.round(w), Math.round(h));
    count++;
  }
  equipCountEl.textContent = count;
}

/* ========= 所持アクセUI ========= */
function renderInventory(){
  apRemainEl.textContent = state.apRemain;

  // 所持のみ抽出
  const owned = ACCESSORY_DEFS.filter(a => (state.inventory[a.id]||0) > 0);
  invGallery.innerHTML = '';
  if(owned.length === 0){
    emptyInvEl.style.display = '';
    return;
  }
  emptyInvEl.style.display = 'none';

  for(const acc of owned){
    invGallery.appendChild(buildCard(acc));
  }
}

function buildCard(acc){
  const qty = state.inventory[acc.id] || 0;
  const el = document.createElement('div'); el.className='card';

  const thumb = buildThumb(acc);
  el.appendChild(thumb);

  const body = document.createElement('div'); body.className='body';
  body.innerHTML = `
    <div class="name">${acc.name}</div>
    <div class="tags">
      <span class="tag">所持: <b>${qty}</b></span>
      <span class="tag">ID: ${acc.id}</span>
    </div>
    <div class="cta">
      <button class="btn ok">装着/外す</button>
      <button class="btn acc">プレビュー</button>
    </div>
  `;
  el.appendChild(body);

  // 装着/外す
  body.querySelector('.btn.ok').addEventListener('click', ()=>{
    if(state.equip.has(acc.id)) state.equip.delete(acc.id);
    else state.equip.add(acc.id);
    setLS(LS.equip, Array.from(state.equip));
    draw();
  });

  // プレビュー（装着はしない・一時的に描画してから戻す）
  body.querySelector('.btn.acc').addEventListener('click', ()=>{
    const wasEquipped = state.equip.has(acc.id);
    if(!wasEquipped) state.equip.add(acc.id);
    draw();
    // 0.8秒後に元に戻す
    setTimeout(()=>{
      if(!wasEquipped) state.equip.delete(acc.id);
      draw();
    }, 800);
  });

  return el;
}

function buildThumb(acc){
  const box = document.createElement('div');
  box.className='thumb';

  const img = document.createElement('img');
  img.alt = acc.name;
  img.loading='lazy';
  img.decoding='async';
  img.src = acc.img;

  img.onerror = ()=>{
    img.remove();
    const ph = document.createElement('div');
    ph.className='ph';
    ph.innerHTML = `画像なし<br><small>${acc.id}.png</small>`;
    box.appendChild(ph);
    console.warn('[ACC IMG MISSING]', acc.img);
  };

  box.appendChild(img);
  return box;
}

/* ========= ナビ ========= */
function wireNav(){
  const go=href=>()=>location.href=href;
  document.getElementById('backBtn').addEventListener('click',()=>history.back());
  document.getElementById('toAsari').addEventListener('click',go('asari.html'));
  document.getElementById('toAccessory').addEventListener('click',go('accessory.html'));
  document.getElementById('toAccessory2').addEventListener('click',go('accessory.html'));
  document.getElementById('toIndex').addEventListener('click',go('index.html'));
}

/* ========= ループ（最小） =========
   アニメはしない（チカチカ防止）。
   ただし、ウィンドウサイズ変化だけ再描画。 */
function startRenderLoop(){
  // 初回1回だけ描画（必要時のみ）
  draw();
}

/* ========= 初期化 ========= */
(function init(){
  localStorage.setItem(LS.lastPage,'collection.html');

  charLabelEl.textContent = `キャラ：${state.color}`;
  resize();
  loadImages();
  renderInventory();
  wireNav();
  startRenderLoop();
})();
</script>
</body>
</html>
