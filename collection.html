<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>WHOAI | コレクション</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg:#0b0f14; --panel:#121922; --panel-soft:#0f151d; --text:#eaf2ff;
    --muted:#9fb2c9; --accent:#7dd3fc; --ok:#22c55e; --warn:#f59e0b; --chip:#1e293b;
    --card:#0f172a; --ring:#334155; --shadow: 0 10px 25px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,"Noto Sans JP","Hiragino Kaku Gothic ProN",Meiryo,sans-serif}
  a{color:inherit;text-decoration:none}
  .wrap{min-height:100dvh;display:flex;flex-direction:column}
  header{position:sticky;top:0;z-index:20;backdrop-filter:saturate(120%) blur(8px);
    background:linear-gradient(180deg,rgba(0,0,0,.7),rgba(0,0,0,0));padding:10px 14px;border-bottom:1px solid #0b1220}
  .topbar{display:flex;gap:10px;align-items:center}
  .title{font-weight:700;letter-spacing:.02em}
  .spacer{flex:1}
  .btn{appearance:none;border:none;cursor:pointer;background:var(--panel);color:var(--text);
    padding:10px 14px;border-radius:14px;box-shadow:var(--shadow);border:1px solid var(--ring);transition:transform .05s ease,filter .2s ease,background .2s ease;font-weight:600}
  .btn:hover{filter:brightness(1.08)} .btn:active{transform:translateY(1px)}
  .btn.ghost{background:transparent} .btn.acc{background:var(--accent);color:#002235;border-color:transparent}
  .btn.ok{background:var(--ok);color:#01210f;border-color:transparent} .btn.warn{background:var(--warn);color:#2d1a00;border-color:transparent}
  .btn.small{padding:7px 10px;border-radius:12px;font-size:.92rem}
  main{padding:16px;display:grid;gap:14px}
  .panel{background:linear-gradient(180deg,var(--panel),var(--panel-soft));border:1px solid var(--ring);border-radius:18px;padding:14px;box-shadow:var(--shadow)}
  /* --- stats --- */
  .stats{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
  .stat{grid-column:span 3;display:flex;flex-direction:column;gap:6px}
  .k{font-size:1.1rem;color:var(--muted)} .v{font-size:1.9rem;font-weight:800;letter-spacing:.02em}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--ring);color:var(--muted);font-weight:600}
  .hint{color:var(--muted);font-size:.92rem}
  .accent-dot{display:inline-block;width:10px;height:10px;border-radius:50%;vertical-align:-1px;margin-right:6px}
  /* --- tabs --- */
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:8px 12px;border-radius:999px;border:1px solid var(--ring);background:var(--chip);cursor:pointer;color:var(--muted);font-weight:700}
  .tab.active{background:var(--accent);color:#012235;border-color:transparent}
  /* --- gallery --- */
  .legend{display:flex;gap:8px;flex-wrap:wrap}
  .legend .pill b{color:var(--text)}
  .gallery{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(180px,1fr))}
  .card{background:var(--card);border:1px solid var(--ring);border-radius:18px;overflow:hidden;display:flex;flex-direction:column}
  .thumb{aspect-ratio:1/1;background:#0b1420;display:grid;place-items:center}
  .thumb img{width:80%;height:80%;object-fit:contain;filter:drop-shadow(0 10px 18px rgba(0,0,0,.55))}
  .body{padding:10px 12px;display:flex;flex-direction:column;gap:8px}
  .name{font-weight:700}
  .tags{display:flex;gap:6px;flex-wrap:wrap}
  .tag{font-size:.78rem;background:var(--chip);border:1px solid var(--ring);padding:4px 8px;border-radius:999px;color:var(--muted);font-weight:700}
  .count{font-size:1.1rem;font-weight:800}
  .cta{display:flex;gap:8px;margin-top:4px}
  .empty{padding:20px;border:1px dashed var(--ring);border-radius:16px;color:var(--muted)}
  .footnav{display:flex;gap:10px;justify-content:flex-end}
  @media (max-width:900px){.stat{grid-column:span 6}} @media (max-width:600px){.stat{grid-column:span 12}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="topbar">
      <button class="btn ghost small" id="backBtn">← 戻る</button>
      <div class="title">コレクション</div>
      <div class="spacer"></div>
      <button class="btn small" id="toAsari">潮干狩りへ</button>
      <button class="btn small" id="toAccessory">アクセサリー</button>
      <button class="btn acc small" id="toNight">夜の会話</button>
    </div>
  </header>

  <main>
    <!-- ステータス -->
    <section class="panel stats" id="statsPanel">
      <div class="stat">
        <div class="k">合計貝数</div>
        <div class="v" id="totalShells">0</div>
        <div class="row">
          <span class="pill"><b id="commonCount">0</b> Common</span>
          <span class="pill"><b id="rareCount">0</b> Rare</span>
          <span class="pill"><b id="epicCount">0</b> Epic</span>
          <span class="pill"><b id="legendCount">0</b> Legendary</span>
        </div>
      </div>
      <div class="stat">
        <div class="k">会話チケット（残）</div>
        <div class="v" id="ticketRemain">0</div>
        <div class="hint">対象: asari3 / flame / aurora / luminous（1個=1枚）</div>
      </div>
      <div class="stat">
        <div class="k">アクセサリーポイント（残）</div>
        <div class="v" id="apRemain">0</div>
        <div class="hint">対象: mystic / night / rainbow / pearl（1個=1P）</div>
      </div>
      <div class="stat">
        <div class="k">マカロン解禁</div>
        <div class="v" id="macaronStatus">未解禁</div>
        <div class="row">
          <span class="pill"><span class="accent-dot" id="accentDot"></span><span id="accentLabel">マカロン色: 未選択</span></span>
          <span class="pill">キャラ: <b id="charLabel">未選択</b></span>
        </div>
      </div>
    </section>

    <!-- タブ -->
    <section class="panel">
      <div class="tabs">
        <button class="tab active" id="tabShells">貝コレクション</button>
        <button class="tab" id="tabAccessories">アクセサリー</button>
      </div>
    </section>

    <!-- ▼▼▼ 貝タブ ▼▼▼ -->
    <section class="panel" id="shellFilters">
      <div class="row">
        <button class="btn small" id="sortRarity">レア度順</button>
        <button class="btn small" id="sortCount">所持数順</button>
        <button class="btn small" id="sortName">名前順</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn ghost small" id="fltAll">すべて</button>
        <button class="btn ghost small" id="fltTicket">会話チケット対象</button>
        <button class="btn ghost small" id="fltAp">アクセP対象</button>
        <button class="btn ghost small" id="fltExam">検定モード</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn ok small" id="goNightQuick">チケットで会話へ</button>
        <button class="btn warn small" id="goAccessoryQuick">ポイントでアクセへ</button>
      </div>
    </section>

    <section class="legend" id="shellLegend">
      <span class="pill"><b>Common:</b> asari1 / asari2 / asari3</span>
      <span class="pill"><b>Rare:</b> flame / aurora / luminous</span>
      <span class="pill"><b>Epic:</b> mystic / night / rainbow</span>
      <span class="pill"><b>Legendary:</b> pearl</span>
    </section>

    <section class="gallery" id="shellGallery"></section>

    <!-- ▲▲▲ 貝タブここまで ▲▲▲ -->

    <!-- ▼▼▼ アクセサリータブ ▼▼▼ -->
    <section class="panel" id="accInfo" style="display:none">
      <div class="row">
        <div class="k">所持アクセサリー一覧（`who_accessory_inventory`）</div>
        <div class="spacer"></div>
        <button class="btn small" id="openAccessoryShop">アクセサリー購入へ</button>
      </div>
      <div class="hint">「アクセサリー購入へ」から貝ポイントを使って交換できます。ここでは<strong>所持しているもののみ</strong>を表示します。</div>
    </section>

    <section class="gallery" id="accGallery" style="display:none"></section>
    <!-- ▲▲▲ アクセサリータブここまで ▲▲▲ -->

    <!-- フッターナビ -->
    <section class="panel footnav">
      <button class="btn ghost" id="toIndex">タイトルへ</button>
      <button class="btn" id="toChar">キャラ選択へ</button>
      <button class="btn" id="toAsari2">潮干狩りへ</button>
      <button class="btn" id="toAccessory2">アクセサリーへ</button>
      <button class="btn acc" id="toNight2">夜の会話へ</button>
    </section>
  </main>
</div>

<script>
/* ===============================
   定義
   =============================== */
const SHELL_DEFS = [
  // Common
  { id:'asari1',   name:'あさり１',   rarity:'Common',    role:'exam',   img:'public/assets/shells/asari1.png' },
  { id:'asari2',   name:'あさり２',   rarity:'Common',    role:'exam',   img:'public/assets/shells/asari2.png' },
  { id:'asari3',   name:'あさり３',   rarity:'Common',    role:'ticket', img:'public/assets/shells/asari3.png' },
  // Rare
  { id:'flame',    name:'炎の貝',     rarity:'Rare',      role:'ticket', img:'public/assets/shells/flame.png' },
  { id:'aurora',   name:'オーロラ',   rarity:'Rare',      role:'ticket', img:'public/assets/shells/aurora.png' },
  { id:'luminous', name:'ルミナス',   rarity:'Rare',      role:'ticket', img:'public/assets/shells/luminous.png' },
  // Epic
  { id:'mystic',   name:'ミスティック',rarity:'Epic',     role:'ap',     img:'public/assets/shells/mystic.png' },
  { id:'night',    name:'ナイト',     rarity:'Epic',      role:'ap',     img:'public/assets/shells/night.png' },
  { id:'rainbow',  name:'レインボー', rarity:'Epic',      role:'ap',     img:'public/assets/shells/rainbow.png' },
  // Legendary
  { id:'pearl',    name:'真珠',       rarity:'Legendary', role:'ap',     img:'public/assets/shells/pearl.png' },
];
// アクセサリー（所持一覧で使用） ※画像は public/assets/accessories/ に配置
const ACCESSORY_DEFS = [
  { id:'knit_hat',     name:'ニット帽',     img:'public/assets/accessories/knit_hat.png' },
  { id:'star_yellow',  name:'スター（黄）', img:'public/assets/accessories/star_yellow.png' },
  { id:'ribbon_yellow',name:'リボン（黄）', img:'public/assets/accessories/ribbon_yellow.png' },
  { id:'straw_hat',    name:'麦わら帽子',   img:'public/assets/accessories/straw_hat.png' },
  { id:'sunglasses',   name:'サングラス',   img:'public/assets/accessories/sunglasses.png' },
];

const RARITY_ORDER = { Legendary:4, Epic:3, Rare:2, Common:1 };
const MACARON_ACCENTS = { pink:'#f472b6', blue:'#60a5fa', green:'#34d399', purple:'#a78bfa' };

const LS_KEYS = {
  shells:'who_shells',
  lastPage:'who_last_page',
  character:'who_character',
  macaronColor:'who_macaron_color',
  ticketsRemain:'who_tickets_remaining',
  ticketsUsed:'who_tickets_used',
  apRemain:'who_accessory_points',
  inventory:'who_accessory_inventory' // { accessoryId: qty }
};

const MACARON_UNLOCK_THRESHOLD = 100;

/* ===============================
   ユーティリティ
   =============================== */
const getLS = (k, def=null)=>{ try{ const v=localStorage.getItem(k); return v==null?def:JSON.parse(v); }catch{ return def; } };
const setLS = (k,v)=>localStorage.setItem(k, JSON.stringify(v));

/* ===============================
   データ読み込み・集計
   =============================== */
function loadState(){
  const shells = Object.assign(Object.fromEntries(SHELL_DEFS.map(d=>[d.id,0])), getLS(LS_KEYS.shells,{}));
  const total = Object.values(shells).reduce((a,b)=>a+b,0);

  const groupByRarity = {Common:0,Rare:0,Epic:0,Legendary:0};
  for(const d of SHELL_DEFS){ groupByRarity[d.rarity] += (shells[d.id]||0); }

  const ticketEarned = SHELL_DEFS.filter(d=>d.role==='ticket').map(d=>shells[d.id]||0).reduce((a,b)=>a+b,0);
  const ticketsRemainLS = getLS(LS_KEYS.ticketsRemain, null);
  const ticketsUsedLS   = getLS(LS_KEYS.ticketsUsed, 0);
  const ticketsRemain   = (ticketsRemainLS!=null) ? ticketsRemainLS : Math.max(0, ticketEarned - (ticketsUsedLS||0));

  const apEarned = SHELL_DEFS.filter(d=>d.role==='ap').map(d=>shells[d.id]||0).reduce((a,b)=>a+b,0);
  const apRemainLS = getLS(LS_KEYS.apRemain, null);
  const apRemain   = (apRemainLS!=null) ? apRemainLS : apEarned;

  const character = getLS(LS_KEYS.character, null);
  const macaronColor = getLS(LS_KEYS.macaronColor, null);
  const macaronUnlocked = total >= MACARON_UNLOCK_THRESHOLD;

  const inventory = Object.assign(Object.fromEntries(ACCESSORY_DEFS.map(a=>[a.id,0])), getLS(LS_KEYS.inventory, {}));

  return { shells,total,groupByRarity,ticketsRemain,apRemain,character,macaronColor,macaronUnlocked,inventory };
}

/* ===============================
   レンダリング（共通）
   =============================== */
function applyAccent(colorKey){
  const dot=document.getElementById('accentDot'), label=document.getElementById('accentLabel');
  if(colorKey && MACARON_ACCENTS[colorKey]){
    const c=MACARON_ACCENTS[colorKey]; dot.style.background=c; label.textContent=`マカロン色: ${colorKey}`;
    document.documentElement.style.setProperty('--accent', c);
  }else{ dot.style.background='#3b3b3b'; label.textContent='マカロン色: 未選択'; }
}
function renderStats(state){
  document.getElementById('totalShells').textContent = state.total;
  document.getElementById('commonCount').textContent = state.groupByRarity.Common;
  document.getElementById('rareCount').textContent   = state.groupByRarity.Rare;
  document.getElementById('epicCount').textContent   = state.groupByRarity.Epic;
  document.getElementById('legendCount').textContent = state.groupByRarity.Legendary;
  document.getElementById('ticketRemain').textContent = state.ticketsRemain;
  document.getElementById('apRemain').textContent = state.apRemain;
  document.getElementById('macaronStatus').textContent = state.macaronUnlocked ? '解禁済み' : '未解禁';
  document.getElementById('macaronStatus').style.color = state.macaronUnlocked ? 'var(--ok)' : 'var(--muted)';
  document.getElementById('charLabel').textContent = state.character || '未選択';
  applyAccent(state.macaronColor);
}

/* ===============================
   貝タブ：描画
   =============================== */
function buildShellCard(def, count){
  const el=document.createElement('div'); el.className='card';
  el.innerHTML=`
    <div class="thumb"><img src="${def.img}" alt="${def.name}"></div>
    <div class="body">
      <div class="name">${def.name}</div>
      <div class="tags">
        <span class="tag">${def.rarity}</span>
        <span class="tag">${def.role==='ticket'?'会話チケット':def.role==='ap'?'アクセP':'検定モード'}</span>
      </div>
      <div class="count">× ${count}</div>
      <div class="cta">
        ${def.role==='ticket'?'<button class="btn small" data-act="night">この貝で会話へ</button>':''}
        ${def.role==='ap'?'<button class="btn small" data-act="accessory">この貝でアクセへ</button>':''}
      </div>
    </div>`;
  el.querySelectorAll('[data-act="night"]').forEach(b=>b.addEventListener('click',()=>location.href='night.html'));
  el.querySelectorAll('[data-act="accessory"]').forEach(b=>b.addEventListener('click',()=>location.href='accessory.html'));
  return el;
}
function renderShellGallery(state, sortBy='rarity', filter='all'){
  const g=document.getElementById('shellGallery'); g.innerHTML='';
  let list = SHELL_DEFS.map(d=>({def:d,count:state.shells[d.id]||0})).filter(x=>x.count>0);
  if(filter==='ticket') list=list.filter(x=>x.def.role==='ticket');
  if(filter==='ap')     list=list.filter(x=>x.def.role==='ap');
  if(filter==='exam')   list=list.filter(x=>x.def.role==='exam');

  if(sortBy==='rarity'){ list.sort((a,b)=> (RARITY_ORDER[b.def.rarity]-RARITY_ORDER[a.def.rarity]) || (b.count-a.count)); }
  else if(sortBy==='count'){ list.sort((a,b)=> (b.count-a.count) || (RARITY_ORDER[b.def.rarity]-RARITY_ORDER[a.def.rarity])); }
  else if(sortBy==='name'){ list.sort((a,b)=> a.def.name.localeCompare(b.def.name,'ja')); }

  if(list.length===0){ const empty=document.createElement('div'); empty.className='empty'; empty.textContent='貝はまだありません。潮干狩りへ行ってみましょう。'; g.appendChild(empty); return; }
  list.forEach(item=>g.appendChild(buildShellCard(item.def,item.count)));
}

/* ===============================
   アクセサリータブ：描画
   =============================== */
function buildAccCard(def, qty){
  const el=document.createElement('div'); el.className='card';
  el.innerHTML=`
    <div class="thumb"><img src="${def.img}" alt="${def.name}"></div>
    <div class="body">
      <div class="name">${def.name}</div>
      <div class="tags"><span class="tag">アクセサリー</span></div>
      <div class="count">× ${qty}</div>
      <div class="cta">
        <button class="btn small" data-act="shop">アクセサリーへ</button>
      </div>
    </div>`;
  el.querySelector('[data-act="shop"]').addEventListener('click',()=>location.href='accessory.html');
  return el;
}
function renderAccessoryGallery(state){
  const g=document.getElementById('accGallery'); g.innerHTML='';
  const owned = ACCESSORY_DEFS.map(a=>({def:a,qty: state.inventory[a.id]||0})).filter(x=>x.qty>0);
  if(owned.length===0){
    const empty=document.createElement('div'); empty.className='empty';
    empty.innerHTML='まだアクセサリーを持っていません。<b>アクセサリー購入へ</b>から交換できます。';
    g.appendChild(empty);
    return;
  }
  owned.forEach(item=>g.appendChild(buildAccCard(item.def,item.qty)));
}

/* ===============================
   タブ切替 & イベント
   =============================== */
function switchTab(which){
  const tabShells=document.getElementById('tabShells');
  const tabAcc=document.getElementById('tabAccessories');
  const shellParts=[document.getElementById('shellFilters'),document.getElementById('shellLegend'),document.getElementById('shellGallery')];
  const accParts=[document.getElementById('accInfo'),document.getElementById('accGallery')];

  if(which==='shells'){
    tabShells.classList.add('active'); tabAcc.classList.remove('active');
    shellParts.forEach(el=>el.style.display='');
    accParts.forEach(el=>el.style.display='none');
  }else{
    tabShells.classList.remove('active'); tabAcc.classList.add('active');
    shellParts.forEach(el=>el.style.display='none');
    accParts.forEach(el=>el.style.display='');
  }
}

function wireUI(state){
  // 共通ナビ
  const go = href => ()=>location.href=href;
  document.getElementById('backBtn').addEventListener('click', ()=>history.back());
  document.getElementById('toIndex').addEventListener('click', go('index.html'));
  document.getElementById('toChar').addEventListener('click', go('char.html'));
  document.getElementById('toAsari').addEventListener('click', go('asari.html'));
  document.getElementById('toAsari2').addEventListener('click', go('asari.html'));
  document.getElementById('toAccessory').addEventListener('click', go('accessory.html'));
  document.getElementById('toAccessory2').addEventListener('click', go('accessory.html'));
  document.getElementById('toNight').addEventListener('click', go('night.html'));
  document.getElementById('toNight2').addEventListener('click', go('night.html'));
  document.getElementById('openAccessoryShop').addEventListener('click', go('accessory.html'));

  // クイック
  document.getElementById('goNightQuick').addEventListener('click', ()=>{
    if(state.ticketsRemain>0) location.href='night.html';
    else alert('会話チケットがありません。対象の貝を集めてください。');
  });
  document.getElementById('goAccessoryQuick').addEventListener('click', ()=>{
    if(state.apRemain>0) location.href='accessory.html';
    else alert('アクセサリーポイントがありません。対象の貝を集めてください。');
  });

  // タブ
  document.getElementById('tabShells').addEventListener('click', ()=>switchTab('shells'));
  document.getElementById('tabAccessories').addEventListener('click', ()=>switchTab('acc'));
  switchTab('shells');

  // ソート/フィルタ
  let currentSort='rarity', currentFilter='all';
  const rerenderShells = ()=>renderShellGallery(state, currentSort, currentFilter);

  document.getElementById('sortRarity').addEventListener('click', ()=>{ currentSort='rarity'; rerenderShells(); });
  document.getElementById('sortCount').addEventListener('click', ()=>{ currentSort='count'; rerenderShells(); });
  document.getElementById('sortName').addEventListener('click',  ()=>{ currentSort='name';  rerenderShells(); });

  document.getElementById('fltAll').addEventListener('click',   ()=>{ currentFilter='all';    rerenderShells(); });
  document.getElementById('fltTicket').addEventListener('click',()=>{ currentFilter='ticket'; rerenderShells(); });
  document.getElementById('fltAp').addEventListener('click',    ()=>{ currentFilter='ap';     rerenderShells(); });
  document.getElementById('fltExam').addEventListener('click',  ()=>{ currentFilter='exam';   rerenderShells(); });
}

/* ===============================
   初期化
   =============================== */
(function init(){
  setLS(LS_KEYS.lastPage,'collection.html');
  const state = loadState();
  renderStats(state);
  renderShellGallery(state,'rarity','all');
  renderAccessoryGallery(state);
  wireUI(state);
  if(state.macaronUnlocked){
    document.getElementById('macaronStatus').animate(
      [{transform:'scale(1)',filter:'brightness(1)'},
       {transform:'scale(1.06)',filter:'brightness(1.2)'},
       {transform:'scale(1)',filter:'brightness(1)'}],
      {duration:900,easing:'ease-out'}
    );
  }
})();
</script>
</body>
</html>
