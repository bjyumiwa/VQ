<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>WHO VQ — コレクション図鑑</title>
  <style>
    /* ===== Base ===== */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: #0b0f14; color: #fff; font-family: system-ui, "Noto Sans JP", sans-serif; }
    a { color: inherit; text-decoration: none; }

    /* ===== App Layout ===== */
    .app { position: relative; min-height: 100vh; padding: 72px 16px 88px; }

    /* Top Bar */
    .topbar { position: fixed; inset: 0 0 auto 0; height: 56px; padding: 8px 12px; display: flex; align-items: center; gap: 8px; background: linear-gradient(180deg, rgba(0,0,0,.65), rgba(0,0,0,0)); z-index: 10; color:#fff; }
    .topbar .btn { padding: 8px 12px; border: 1px solid rgba(255,255,255,.15); background: rgba(255,255,255,.05); border-radius: 12px; backdrop-filter: blur(6px); cursor: pointer; color:#fff; }
    .spacer { flex: 1; }

    /* Header */
    .header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; color:#fff; }
    .title { font-size: 20px; font-weight: 700; letter-spacing: .02em; }
    .subtitle { opacity: .95; font-size: 12px; color:#fff; }

    /* Character Preview */
    .char-box { position: fixed; right: 12px; bottom: 100px; width: 140px; height: 140px; display: grid; place-items: center; background: radial-gradient(120px 60px at 50% 30%, rgba(255,255,255,.12), rgba(255,255,255,0)); border: 1px solid rgba(255,255,255,.08); border-radius: 16px; }
    .char-box img { max-width: 80%; height: auto; image-rendering: auto; filter: drop-shadow(0 6px 14px rgba(0,0,0,.45)); }

    /* Filters */
    .controls { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin: 12px 0 16px; color:#fff; }
    .chip { padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.06); cursor: pointer; font-size: 12px; color:#fff; }
    .chip[aria-pressed="true"] { background: rgba(255,255,255,.22); color:#fff; }
    select { padding: 6px 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.06); color: #fff; }

    /* Progress */
    .progress { display: flex; align-items: center; gap: 10px; margin: 8px 0 12px; color:#fff; }
    .bar { flex: 1; height: 8px; background: rgba(255,255,255,.08); border-radius: 8px; overflow: hidden; }
    .bar > i { display: block; height: 100%; width: 0%; background: linear-gradient(90deg, #8ee8ff, #7cf3c9); }
    .progress .label { font-size: 12px; opacity: 1; color:#fff; }

    /* Grid */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; }

    .card { position: relative; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); border-radius: 14px; padding: 10px; display: grid; justify-items: center; gap: 8px; cursor: pointer; transition: transform .1s ease; color:#fff; }
    .card:hover { transform: translateY(-2px); }
    .card img { width: 72px; height: 72px; object-fit: contain; image-rendering: auto; filter: drop-shadow(0 4px 8px rgba(0,0,0,.35)); }
    .card .nm { font-size: 12px; text-align: center; line-height: 1.25; color:#fff; }
    .badge { position: absolute; top: 6px; right: 6px; font-size: 11px; padding: 2px 6px; border-radius: 999px; background: rgba(0,0,0,.55); border: 1px solid rgba(255,255,255,.18); color:#fff; }
    .rarity { position: absolute; left: 6px; top: 6px; font-size: 11px; padding: 2px 6px; border-radius: 999px; border: 1px solid rgba(255,255,255,.18); color:#fff; }

    /* Rarity Colors (背景のみ変える) */
    .rN { background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02)); }
    .rM { background: linear-gradient(180deg, rgba(140,200,255,.25), rgba(255,255,255,.02)); }
    .rH { background: linear-gradient(180deg, rgba(255,170,90,.25), rgba(255,255,255,.02)); }
    .rU { background: linear-gradient(180deg, rgba(255,120,180,.28), rgba(255,255,255,.02)); }

    /* Empty State */
    .empty { text-align: center; padding: 40px 12px; opacity: 1; color:#fff; }

    /* Bottom Bar */
    .bottombar { position: fixed; inset: auto 0 0 0; height: 72px; padding: 10px 12px; display: flex; align-items: center; gap: 10px; background: linear-gradient(0deg, rgba(0,0,0,.75), rgba(0,0,0,0)); z-index: 10; color:#fff; }
    .cta { flex: 1; padding: 10px 14px; border: 0; border-radius: 12px; font-weight: 700; cursor: pointer; color: #06251a; background: linear-gradient(90deg, #7cf3c9, #8ee8ff); box-shadow: 0 8px 24px rgba(124,243,201,.25); }
    .ghost { padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.06); color: #fff; cursor: pointer; }

    /* Modal */
    dialog { width: min(520px, 96vw); border: 1px solid rgba(255,255,255,.18); background: rgba(22,30,39,.95); color: #fff; border-radius: 16px; padding: 16px; }
    dialog::backdrop { background: rgba(0,0,0,.6); }
    .modal-hd { display: flex; align-items: center; gap: 12px; }
    .modal-hd img { width: 72px; height: 72px; object-fit: contain; }
    .modal-ttl { font-size: 18px; font-weight: 700; color:#fff; }
    .modal-sub { font-size: 12px; opacity: 1; color:#fff; }
    .modal-main { margin: 12px 0; line-height: 1.6; font-size: 14px; color:#fff; }
    .modal-act { display: flex; gap: 8px; justify-content: flex-end; }

    /* Background decoration */
    .bg-glow { position: fixed; left: -20%; bottom: -20%; width: 70vmax; height: 70vmax; border-radius: 50%; filter: blur(60px); background: radial-gradient(circle at 50% 50%, rgba(124,243,201,.12), rgba(0,0,0,0)); pointer-events: none; }
  </style>
</head>
<body>
  <div class="topbar">
    <button class="btn" id="btnBack">← 潮干狩りへ</button>
    <button class="btn" id="btnReset" title="全削除">リセット</button>
    <div class="spacer"></div>
    <button class="btn" id="btnExport">CSV出力</button>
  </div>

  <div class="app">
    <div class="header">
      <div>
        <div class="title">コレクション図鑑 <span id="ver" class="subtitle"></span></div>
        <div class="subtitle">集めた貝を眺めて、説明やレア度をチェックできます</div>
      </div>
    </div>

    <div class="controls">
      <span class="subtitle">レア度:</span>
      <button class="chip" data-filter="all" aria-pressed="true">すべて</button>
      <button class="chip" data-filter="N">ノーマル</button>
      <button class="chip" data-filter="M">ミドル</button>
      <button class="chip" data-filter="H">ハイ</button>
      <button class="chip" data-filter="U">ウルトラ</button>
      <div class="spacer"></div>
      <label class="subtitle" for="sort">並び替え:</label>
      <select id="sort">
        <option value="rarity">レア度 → 名前</option>
        <option value="count">所持数 多い順</option>
        <option value="name">名前 A→Z</option>
      </select>
    </div>

    <div class="progress">
      <div class="bar" aria-label="complete rate"><i id="bar"></i></div>
      <div class="label"><span id="found">0</span>/<span id="total">0</span> 種コンプ</div>
    </div>

    <div id="grid" class="grid" role="list"></div>
  </div>

  <div class="char-box" aria-label="選択中キャラ">
    <img id="charImg" alt="character" />
  </div>

  <div class="bottombar">
    <button class="ghost" id="btnHow">説明</button>
    <button class="cta" id="btnNext">交換所へ →</button>
  </div>

  <div class="bg-glow"></div>

  <!-- Modal: item detail -->
  <dialog id="dlg">
    <div class="modal-hd">
      <img id="dlgImg" alt="shell" />
      <div>
        <div class="modal-ttl" id="dlgName">—</div>
        <div class="modal-sub" id="dlgMeta">—</div>
      </div>
    </div>
    <div class="modal-main" id="dlgDesc">—</div>
    <div class="modal-act">
      <button class="ghost" id="dlgClose">閉じる</button>
      <button class="cta" id="dlgToExchange">この貝で交換する</button>
    </div>
  </dialog>

  <!-- Modal: how to -->
  <dialog id="how">
    <div class="modal-ttl">コレクション図鑑について</div>
    <div class="modal-main">
      <p>潮干狩りで集めた貝がここに並びます。カードをタップすると説明とレア度が見られます。</p>
      <ul>
        <li>ノーマル（N）… 基本通貨。10個でアクセサリー交換に使えます。</li>
        <li>ミドル（M）… 会話チケット用（aurora / luminous / mystic / wave）。</li>
        <li>ハイ（H）… 限定アクセ/演出解放（flame / night_sky）。</li>
        <li>ウルトラ（U）… 特別演出とストーリー分岐キー（rainbow / pearl）。</li>
      </ul>
      <p>準備ができたら「交換所へ」ボタンで <code>exchange.html</code> に進みます。</p>
    </div>
    <div class="modal-act">
      <button class="cta" id="howOk">OK</button>
    </div>
  </dialog>

  <script>
  ;(() => {
    // ===== Config =====
    const VERSION_KEY = 'who_stage_asari_version';
    const INVENTORY_KEYS = ['who_shells', 'who_shell_inventory', 'shells'];
    const CHARACTER_KEY = 'who_character';
    const IMG_BASES = ['public/items', './public/items', '/public/items'];

    const SHELLS = [
      { id: 'asari1', name: 'アサリ（小）', rarity: 'N', desc: '小粒のアサリ。集めやすく、基本通貨として使えます。' },
      { id: 'asari2', name: 'アサリ（中）', rarity: 'N', desc: '標準サイズのアサリ。10個集めるとアクセサリー交換に一歩前進。' },
      { id: 'asari3', name: 'アサリ（大）', rarity: 'N', desc: '大きめのアサリ。見つかるとちょっと嬉しい。' },
      { id: 'aurora_shell',   name: 'オーロラ貝',   rarity: 'M', desc: '淡い光を放つ貝。会話チケットと交換可能。' },
      { id: 'luminous_shell', name: 'ルミナス貝',   rarity: 'M', desc: '夜でも輝く貝。会話チケットの材料。' },
      { id: 'mystic_shell',   name: 'ミスティック貝', rarity: 'M', desc: '神秘の模様が浮かぶ貝。会話チケット向け。' },
      { id: 'wave_shell',     name: '波の貝',       rarity: 'M', desc: '波のうねりを閉じ込めたような貝。' },
      { id: 'flame_shell',    name: '炎の貝',       rarity: 'H', desc: '燃えるような模様。限定アクセや演出のキー。' },
      { id: 'night_sky_shell',name: '夜空の貝',     rarity: 'H', desc: '満天の星を閉じ込めたよう。限定演出の解放に。' },
      { id: 'rare_rainbow',   name: 'レインボー貝', rarity: 'U', desc: '七色に輝く超レア貝。特別演出と分岐のキー。' },
      { id: 'rare_pearl',     name: '真珠',         rarity: 'U', desc: '海の宝石。超レア。新たな物語を開く。' },
    ];

    const RARITY_LABEL = { N: 'ノーマル', M: 'ミドル', H: 'ハイ', U: 'ウルトラ' };
    const RARITY_ORDER = { U: 0, H: 1, M: 2, N: 3 };

    // ===== State =====
    let inventory = Object.fromEntries(SHELLS.map(s => [s.id, 0]));

    // ===== Helpers =====
    const qs = (sel, el = document) => el.querySelector(sel);
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

    function loadVersion(){ return localStorage.getItem(VERSION_KEY) || ''; }

    function loadInventory() {
      let data = null;
      for (const k of INVENTORY_KEYS) {
        const raw = localStorage.getItem(k);
        if (!raw) continue;
        try { data = JSON.parse(raw); break; } catch {}
      }
      let obj = {};
      if (data && typeof data === 'object') obj = (data.items && typeof data.items === 'object') ? data.items : data;
      const out = { ...inventory };
      for (const s of SHELLS) {
        const n = Number(obj[s.id] || 0);
        out[s.id] = Number.isFinite(n) ? clamp(n, 0, 9999) : 0;
      }
      return out;
    }

    function saveInventory(inv) {
      const payload = { items: inv, updatedAt: new Date().toISOString(), schema: 'who_shells/v1' };
      localStorage.setItem('who_shells', JSON.stringify(payload));
    }

    function parseAddParam() {
      const add = new URL(location.href).searchParams.get('add');
      if (!add) return null;
      const list = add.split(',').map(x => x.trim()).filter(Boolean);
      const delta = {};
      for (const item of list) {
        const [id, n] = item.split(':');
        if (!id) continue;
        const num = Number(n || 1);
        if (SHELLS.some(s => s.id === id) && Number.isFinite(num)) {
          delta[id] = (delta[id] || 0) + Math.max(0, Math.min(9999, num));
        }
      }
      return Object.keys(delta).length ? delta : null;
    }

    function mergeDelta(inv, delta) {
      const out = { ...inv };
      for (const [id, n] of Object.entries(delta)) {
        out[id] = Math.max(0, Math.min(9999, (out[id] || 0) + n));
      }
      return out;
    }

    function fmtCount(n) { return `${n} 個`; }

    // 画像フォールバック
    function setShellImg(el, id, idx = 0) {
      const bases = IMG_BASES;
      if (idx >= bases.length) { el.style.opacity = '.3'; el.alt = 'no image'; return; }
      el.onerror = () => setShellImg(el, id, idx + 1);
      el.src = `${bases[idx]}/${id}.png`;
    }

    // ===== Render =====
    function renderGrid(filter = 'all', sort = 'rarity') {
      const grid = qs('#grid');
      grid.innerHTML = '';

      const items = SHELLS
        .map(s => ({ ...s, count: inventory[s.id] || 0 }))
        .filter(it => filter === 'all' ? true : it.rarity === filter);

      items.sort((a,b) => {
        if (sort === 'count') return (b.count - a.count) || (RARITY_ORDER[a.rarity] - RARITY_ORDER[b.rarity]) || a.name.localeCompare(b.name, 'ja');
        if (sort === 'name')  return a.name.localeCompare(b.name, 'ja');
        const r = RARITY_ORDER[a.rarity] - RARITY_ORDER[b.rarity];
        return r !== 0 ? r : a.name.localeCompare(b.name, 'ja');
      });

      if (!items.length) { grid.innerHTML = `<div class="empty">該当する貝がありません</div>`; return; }

      for (const it of items) {
        const card = document.createElement('button');
        card.className = `card r${it.rarity}`;
        card.setAttribute('role', 'listitem');
        card.innerHTML = `
          <span class="rarity">${RARITY_LABEL[it.rarity] || it.rarity}</span>
          <span class="badge">${fmtCount(it.count)}</span>
          <img alt="${it.name}" />
          <div class="nm">${it.name}</div>`;
        const img = card.querySelector('img');
        setShellImg(img, it.id, 0);
        card.addEventListener('click', () => openDetail(it));
        grid.appendChild(card);
      }

      const totalKinds = SHELLS.length;
      const foundKinds = SHELLS.reduce((a,s) => a + ((inventory[s.id]||0)>0?1:0), 0);
      qs('#total').textContent = String(totalKinds);
      qs('#found').textContent = String(foundKinds);
      qs('#bar').style.width = `${Math.round(foundKinds/totalKinds*100)}%`;
    }

    function openDetail(it) {
      const dlg = document.querySelector('#dlg');
      const img = document.querySelector('#dlgImg');
      setShellImg(img, it.id, 0);
      img.alt = it.name;
      document.querySelector('#dlgName').textContent = it.name;
      const stars = {N:'★', M:'★★', H:'★★★', U:'★★★★'}[it.rarity] || '';
      document.querySelector('#dlgMeta').textContent = `${RARITY_LABEL[it.rarity]} ${stars}・所持 ${fmtCount(inventory[it.id] || 0)}`;
      document.querySelector('#dlgDesc').textContent = it.desc;
      document.querySelector('#dlgToExchange').onclick = () => { location.href = `exchange.html?want=${encodeURIComponent(it.id)}`; };
      dlg.showModal();
    }

    function renderCharacter() {
      const color = (localStorage.getItem(CHARACTER_KEY) || '').replace(/[^a-z]/g,'') || 'pink';
      const img = document.querySelector('#charImg');
      const candidates = [
        `public/stage1/${color}_open.png`,
        `public/assets/stage1/${color}_open.png`,
        `./public/stage1/${color}_open.png`,
        `public/items/character_${color}.png`,
        `public/items/character.png`
      ];
      let i = 0; const next = () => {
        if (i < candidates.length) { img.onerror = () => { i++; next(); }; img.src = candidates[i]; img.alt = `character ${color}`; }
        else { img.alt = 'character'; img.style.opacity = '.3'; }
      }; next();
    }

    // ===== Wire Up =====
    function init() {
      const ver = loadVersion(); if (ver) document.querySelector('#ver').textContent = `（${ver}）`;
      inventory = loadInventory();
      const delta = parseAddParam(); if (delta) { inventory = mergeDelta(inventory, delta); saveInventory(inventory); }
      renderCharacter();
      renderGrid('all', 'rarity');

      document.querySelectorAll('.chip').forEach(btn => btn.addEventListener('click', () => {
        document.querySelectorAll('.chip').forEach(b => b.setAttribute('aria-pressed', 'false'));
        btn.setAttribute('aria-pressed', 'true');
        const filter = btn.dataset.filter || 'all';
        const sort = document.querySelector('#sort').value;
        renderGrid(filter, sort);
      }));

      document.querySelector('#sort').addEventListener('change', (e) => {
        const filter = Array.from(document.querySelectorAll('.chip')).find(b => b.getAttribute('aria-pressed') === 'true')?.dataset.filter || 'all';
        renderGrid(filter, e.target.value);
      });

      document.querySelector('#btnBack').addEventListener('click', () => location.href = 'asari.html');
      document.querySelector('#btnNext').addEventListener('click', () => location.href = 'exchange.html');
      document.querySelector('#btnHow').addEventListener('click', () => document.querySelector('#how').showModal());
      document.querySelector('#howOk').addEventListener('click', () => document.querySelector('#how').close());
      document.querySelector('#dlgClose').addEventListener('click', () => document.querySelector('#dlg').close());

      document.querySelector('#btnReset').addEventListener('click', () => {
        if (!confirm('貝のコレクションを全削除します。よろしいですか？')) return;
        inventory = Object.fromEntries(SHELLS.map(s => [s.id, 0]));
        saveInventory(inventory);
        renderGrid();
      });

      document.querySelector('#btnExport').addEventListener('click', () => exportCSV());
    }

    function exportCSV() {
      const headers = ['id','name','rarity','count'];
      const rows = SHELLS.map(s => [s.id, s.name, RARITY_LABEL[s.rarity], inventory[s.id] || 0]);
      const esc = v => String(v).replaceAll('"','""');
      const csv = [headers.join(','), ...rows.map(r => r.map(esc).join(','))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'shell_collection.csv'; a.click(); URL.revokeObjectURL(url);
    }

    document.addEventListener('DOMContentLoaded', init);
  })();
  </script>
</body>
</html>
