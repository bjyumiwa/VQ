<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>WHO VQ â€” ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å›³é‘‘</title>
  <style>
    /* ===== Base ===== */
    *, *::before, *::after { box-sizing: border-box; }<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>WHO VQ â€” äº¤æ›æ‰€ï¼ˆexchangeï¼‰</title>
<style>
  :root{ --ui-bg: rgba(0,0,0,.35); --card-bg: rgba(0,0,0,.55); }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;background:#000;color:#fff;font-family:system-ui,"Noto Sans JP",sans-serif}
  .page{display:flex;flex-direction:column;min-height:100vh}
  header{
    position:sticky;top:0;z-index:5;background:linear-gradient(180deg,rgba(0,0,0,.65),rgba(0,0,0,0));
    padding:10px 12px;display:flex;gap:10px;align-items:center;justify-content:space-between
  }
  .pill{background:var(--ui-bg);border:1px solid rgba(255,255,255,.15);padding:6px 10px;border-radius:999px;backdrop-filter:blur(6px)}
  main{flex:1;display:grid;grid-template-columns: 280px 1fr;gap:14px;padding:12px}
  aside{position:sticky;top:58px;align-self:start;background:var(--ui-bg);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px}
  .catBtn{display:block;width:100%;text-align:left;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.04);color:#fff;cursor:pointer;margin-bottom:8px}
  .catBtn.active{background:rgba(255,255,255,.12)}
  section{scroll-margin-top:66px}
  h2{font-size:18px;margin:8px 0 10px}
  .grid{display:grid;grid-template-columns: repeat(auto-fill, minmax(220px,1fr));gap:12px}
  .card{
    background:var(--card-bg);border:1px solid rgba(255,255,255,.15);border-radius:14px;padding:10px;display:flex;gap:10px
  }
  .thumb{width:64px;height:64px;border-radius:10px;background:#111;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .thumb img{max-width:100%;max-height:100%;display:block}
  .meta{flex:1;min-width:0}
  .meta h3{font-size:16px;line-height:1.2;margin-bottom:6px}
  .meta p{font-size:12px;opacity:.9}
  .tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .tag{font-size:11px;padding:2px 6px;border-radius:999px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.08)}
  .ops{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  .btn{padding:7px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);color:#fff;cursor:pointer}
  .btn[disabled]{opacity:.4;cursor:not-allowed}
  .highlight{outline:2px solid #7ec8ff; box-shadow:0 0 0 4px rgba(126,200,255,.25);}

  /* è£…å‚™ãƒ‘ãƒãƒ« */
  .equipPanel{margin-top:12px;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.05)}
  .equipRow{display:grid;grid-template-columns: 80px 1fr auto;gap:8px;align-items:center;margin:6px 0}
  .equipRow .slot{opacity:.9}
  .inlineNote{font-size:12px;opacity:.9}

  /* ãƒ•ãƒƒã‚¿ãƒ¼ãƒãƒ¼ */
  footer{
    position:sticky;bottom:0;z-index:5;background:linear-gradient(0deg,rgba(0,0,0,.65),rgba(0,0,0,0));padding:10px 12px;display:flex;justify-content:space-between;align-items:center
  }
</style>
</head>
<body>
<div class="page">
  <header>
    <div class="pill">åˆç®—ã‚¢ã‚µãƒª æ®‹ï¼š<b id="asariAny">0</b>ï¼ˆasari1/2/3ï¼‰</div>
    <div class="pill">ç¾åœ¨è£…å‚™ã‚’ç¢ºèª â†’ ä¸‹ãƒ‘ãƒãƒ«</div>
  </header>

  <main>
    <aside>
      <button class="catBtn active" data-target="#cat-gear">è£…å‚™</button>
      <button class="catBtn" data-target="#cat-accessory">ã‚¢ã‚¯ã‚»</button>
      <button class="catBtn" data-target="#cat-ticket">ãƒã‚±ãƒƒãƒˆ</button>
      <button class="catBtn" data-target="#cat-effect">æ¼”å‡º</button>

      <div class="equipPanel">
        <h3 style="margin-bottom:6px">ç¾åœ¨è£…å‚™</h3>
        <div id="equipList"></div>
        <div class="inlineNote">å¤–ã™ã«ã¯è¿½åŠ ã‚³ã‚¹ãƒˆãŒå¿…è¦ã§ã™ã€‚</div>
      </div>
    </aside>

    <div id="catalog">
      <!-- è£…å‚™ -->
      <section id="cat-gear">
        <h2>è£…å‚™ï¼ˆgearï¼‰</h2>
        <div class="grid" id="grid-gear"></div>
      </section>
      <!-- ã‚¢ã‚¯ã‚» -->
      <section id="cat-accessory">
        <h2>ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼</h2>
        <div class="grid" id="grid-accessory"></div>
      </section>
      <!-- ãƒã‚±ãƒƒãƒˆ -->
      <section id="cat-ticket">
        <h2>ä¼šè©±ãƒã‚±ãƒƒãƒˆ</h2>
        <div class="grid" id="grid-ticket"></div>
      </section>
      <!-- æ¼”å‡º -->
      <section id="cat-effect">
        <h2>æ¼”å‡º</h2>
        <div class="grid" id="grid-effect"></div>
      </section>
    </div>
  </main>

  <footer>
    <div class="pill">ãƒ†ã‚­ã‚¹ãƒˆã¯ç™½åŸºèª¿ã§å¯èª­æ€§ã‚’ç¢ºä¿</div>
    <div>
      <button class="btn" onclick="location.href='asari.html?preview=1'">ã‚­ãƒ£ãƒ©ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
      <button class="btn" onclick="location.href='asari.html'">æ½®å¹²ç‹©ã‚Šã¸</button>
    </div>
  </footer>
</div>

<script>
/* ====== å…±æœ‰ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));

function readJSON(key, fallback){ try{ const v=localStorage.getItem(key); return v?JSON.parse(v):fallback; }catch(e){ return fallback; } }
function writeJSON(key, obj){ try{ localStorage.setItem(key, JSON.stringify(obj)); }catch(e){} }

/* icon fallback: public/items/ex_<id>.png â†’ public/items/<id>.png â†’ ./public/items â†’ /public/items */
function loadIconWithFallback(id){
  const paths = [
    `public/items/ex_${id}.png`,
    `public/items/${id}.png`,
    `./public/items/${id}.png`,
    `/public/items/${id}.png`,
  ];
  return new Promise(resolve=>{
    const img=new Image(); let i=0;
    const tryNext=()=>{
      if(i>=paths.length){ resolve(null); return; }
      img.src=paths[i++]; img.onload=()=>resolve(img); img.onerror=tryNext;
    }; tryNext();
  });
}
function emojiDataURI(emoji="ğŸ§©", size=128){
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}'><text x='50%' y='50%' font-size='${size*0.8}' dominant-baseline='central' text-anchor='middle'>${emoji}</text></svg>`;
  return `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svg)}`;
}

/* ====== é€šè²¨ï¼ˆåˆç®—ã‚¢ã‚µãƒªï¼‰ ====== */
function ensureShells(){
  let s = readJSON('who_shells', null);
  if(!s || s.schema!=='who_shells/v1'){ s = {schema:'who_shells/v1',updatedAt:new Date().toISOString(),items:{}}; writeJSON('who_shells', s); }
  return s;
}
function asariAny(){
  const st = ensureShells();
  const it = st.items||{};
  // åŒä¾¡å€¤åˆç®—ï¼š1æšæ›ç®—
  return (it.asari1||0)+(it.asari2||0)+(it.asari3||0);
}
function spendAsari(n){
  const st = ensureShells();
  let need = n;
  const order = ['asari3','asari2','asari1']; // å¤§â†’ä¸­â†’å°ã‹ã‚‰æ¶ˆè²»ï¼ˆä»»æ„ãƒ«ãƒ¼ãƒ«ï¼‰
  for(const k of order){
    const have = st.items[k]||0;
    const use = Math.min(have, need);
    st.items[k] = have - use;
    need -= use;
    if(need<=0) break;
  }
  if(need>0) return false; // è¶³ã‚Šãªã„
  st.updatedAt = new Date().toISOString();
  writeJSON('who_shells', st);
  return true;
}

/* ====== æ‰€æŒãƒ»è£…å‚™ ====== */
function ensureOwned(){ const v = readJSON('who_exchange_owned', {}); writeJSON('who_exchange_owned', v); return v; }
function ensureEquip(){ const v = readJSON('who_equipment', {head:null,body:null,back:null,hands:null,shoes:null,style:null}); writeJSON('who_equipment', v); return v; }

/* ====== å•†å“ã‚«ã‚¿ãƒ­ã‚°ï¼ˆä¾‹ï¼‰ ======
  - id: productId
  - name, desc, cat
  - for gear: slot, price, equipCost, unequipCost
  - for others: price
*/
const CATS = {
  gear: {label:'è£…å‚™', emoji:'ğŸ§¢'},
  accessory: {label:'ã‚¢ã‚¯ã‚»', emoji:'âœ¨'},
  ticket: {label:'ãƒã‚±ãƒƒãƒˆ', emoji:'ğŸ«'},
  effect: {label:'æ¼”å‡º', emoji:'ğŸŒŸ'},
};
const CATALOG = [
  // ---- gear (slotåˆ¥) ----
  {id:'gear_hat_explorer', name:'æ¢æ¤œå¸½', desc:'å†’é™ºå®¶ã‚¹ã‚¿ã‚¤ãƒ«ã®å¸½å­', cat:'gear', slot:'head', price:6, equipCost:1, unequipCost:1},
  {id:'gear_robe_star',    name:'æ˜Ÿã®ãƒ­ãƒ¼ãƒ–', desc:'å¤œç©ºã®ãã‚‰ã‚ã', cat:'gear', slot:'body', price:8, equipCost:2, unequipCost:1},
  {id:'gear_back_pack',    name:'èµ¤ã„ãƒãƒƒã‚¯ãƒ‘ãƒƒã‚¯', desc:'æ—…ã®å¿…éœ€å“', cat:'gear', slot:'back', price:5, equipCost:1, unequipCost:1},
  {id:'gear_staff_mage',   name:'é­”æ³•ã®æ–', desc:'ä¸æ€è­°ãªåŠ›ã‚’å®¿ã™', cat:'gear', slot:'hands', price:7, equipCost:2, unequipCost:1},
  {id:'gear_shoes_beach',  name:'ãƒ“ãƒ¼ãƒã‚·ãƒ¥ãƒ¼ã‚º', desc:'ç ‚æµœã§ã‚‚å¿«é©', cat:'gear', slot:'shoes', price:4, equipCost:1, unequipCost:1},
  {id:'style_adventurer',  name:'ã‚¹ã‚¿ã‚¤ãƒ«ï¼šå†’é™ºå®¶', desc:'å…¨ä½“ã«æ¼”å‡ºãƒ¬ã‚¤ãƒ¤', cat:'gear', slot:'style', price:5, equipCost:1, unequipCost:1},

  // ---- accessory ----
  {id:'acc_sunglasses', name:'ã‚µãƒ³ã‚°ãƒ©ã‚¹', desc:'ã¾ã¶ã—ã„æ—¥å·®ã—ã«', cat:'accessory', price:3},
  {id:'acc_star_yellow', name:'æ˜Ÿãƒãƒƒã‚¸', desc:'èƒ¸å…ƒã«ãã‚‰ã‚Š', cat:'accessory', price:2},

  // ---- ticket ----
  {id:'ticket_chat1', name:'ä¼šè©±ãƒã‚±ãƒƒãƒˆ', desc:'ç‰¹åˆ¥ä¼šè©±ã‚’è§£æ”¾', cat:'ticket', price:3},

  // ---- effect ----
  {id:'fx_fireworks', name:'èŠ±ç«æ¼”å‡º', desc:'å¤œç©ºã«å¤§è¼ª', cat:'effect', price:5},
];

function byCategory(cat){ return CATALOG.filter(p => p.cat===cat); }

/* ====== UI ====== */
function setAsariAny(){
  $('#asariAny').textContent = String(asariAny());
}
function makeCard(p){
  const div = document.createElement('div');
  div.className = 'card';
  div.id = `prod-${p.id}`;

  const thumb = document.createElement('div');
  thumb.className = 'thumb';
  const img = document.createElement('img');
  thumb.appendChild(img);

  // ç”»åƒãƒ­ãƒ¼ãƒ‰ï¼ˆãªã‘ã‚Œã°ã‚«ãƒ†ã‚´ãƒªçµµæ–‡å­—ï¼‰
  loadIconWithFallback(p.id).then(pic=>{
    if(pic) img.src = pic.src;
    else img.src = emojiDataURI(CATS[p.cat]?.emoji || 'ğŸ§©', 128);
  });

  const meta = document.createElement('div');
  meta.className = 'meta';
  const h3 = document.createElement('h3'); h3.textContent = p.name;
  const pdesc = document.createElement('p'); pdesc.textContent = p.desc || '';
  const tags = document.createElement('div'); tags.className = 'tags';
  const t1 = document.createElement('span'); t1.className='tag'; t1.textContent = `ä¾¡æ ¼ ${p.price}æš`;
  tags.appendChild(t1);
  if(p.cat==='gear'){
    const t2 = document.createElement('span'); t2.className='tag'; t2.textContent = `slot: ${p.slot}`;
    const t3 = document.createElement('span'); t3.className='tag'; t3.textContent = `è£…å‚™+${p.equipCost} / å¤–ã™+${p.unequipCost}`;
    tags.appendChild(t2); tags.appendChild(t3);
  }

  const ops = document.createElement('div'); ops.className = 'ops';
  const btnBuy = document.createElement('button'); btnBuy.className='btn'; btnBuy.textContent = 'è³¼å…¥';
  const btnEquip = document.createElement('button'); btnEquip.className='btn'; btnEquip.textContent = 'è£…å‚™';
  const btnUnequip = document.createElement('button'); btnUnequip.className='btn'; btnUnequip.textContent = 'å¤–ã™';

  // ãƒœã‚¿ãƒ³åˆ¶å¾¡
  function refreshButtons(){
    const owned = ensureOwned(); const have = owned[p.id]||0;
    btnBuy.disabled = asariAny() < p.price;
    if(p.cat==='gear'){
      const eq = ensureEquip();
      const using = eq[p.slot] === p.id;
      btnEquip.disabled = (have<=0) || using || (asariAny() < (p.equipCost||0));
      btnUnequip.disabled = !using || (asariAny() < (p.unequipCost||0));
    }else{
      btnEquip.style.display='none'; btnUnequip.style.display='none';
    }
  }

  btnBuy.addEventListener('click', ()=>{
    if(asariAny() < p.price){ alert('ã‚¢ã‚µãƒªãŒè¶³ã‚Šã¾ã›ã‚“'); return; }
    if(!spendAsari(p.price)){ alert('æ¶ˆè²»ã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }
    const owned = ensureOwned();
    owned[p.id] = (owned[p.id]||0) + 1;
    writeJSON('who_exchange_owned', owned);
    setAsariAny(); refreshButtons();
  });

  btnEquip.addEventListener('click', ()=>{
    if(p.cat!=='gear') return;
    const cost = p.equipCost||0;
    if(asariAny() < cost){ alert('è£…å‚™ã®è¿½åŠ ã‚³ã‚¹ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“'); return; }
    if(!spendAsari(cost)){ alert('æ¶ˆè²»ã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }
    const eq = ensureEquip();
    eq[p.slot] = p.id;
    writeJSON('who_equipment', eq);
    setAsariAny(); renderEquipPanel(); refreshButtons();
  });

  btnUnequip.addEventListener('click', ()=>{
    if(p.cat!=='gear') return;
    const cost = p.unequipCost||0;
    if(asariAny() < cost){ alert('å¤–ã™ã‚³ã‚¹ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“'); return; }
    if(!spendAsari(cost)){ alert('æ¶ˆè²»ã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }
    const eq = ensureEquip();
    if(eq[p.slot] === p.id){ eq[p.slot] = null; writeJSON('who_equipment', eq); }
    setAsariAny(); renderEquipPanel(); refreshButtons();
  });

  ops.appendChild(btnBuy);
  ops.appendChild(btnEquip);
  ops.appendChild(btnUnequip);

  meta.appendChild(h3); meta.appendChild(pdesc); meta.appendChild(tags); meta.appendChild(ops);
  div.appendChild(thumb); div.appendChild(meta);
  return div;
}

function mountCatalog(){
  const slots = {gear:$('#grid-gear'), accessory:$('#grid-accessory'), ticket:$('#grid-ticket'), effect:$('#grid-effect')};
  Object.values(slots).forEach(el=>el.innerHTML='');
  for(const p of CATALOG){
    const card = makeCard(p);
    (slots[p.cat]||$('#grid-accessory')).appendChild(card);
  }
}

/* å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
$$('.catBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    $$('.catBtn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tgt = btn.dataset.target;
    if(tgt){ document.querySelector(tgt).scrollIntoView({behavior:'smooth'}); }
  });
});

/* ç¾åœ¨è£…å‚™ãƒ‘ãƒãƒ« */
function renderEquipPanel(){
  const wrap = $('#equipList'); wrap.innerHTML='';
  const eq = ensureEquip();
  const order = ['head','body','back','hands','shoes','style'];
  for(const slot of order){
    const row = document.createElement('div'); row.className='equipRow';
    const a = document.createElement('div'); a.className='slot'; a.textContent = slot;
    const b = document.createElement('div');
    const pid = eq[slot];
    b.textContent = pid ? (CATALOG.find(x=>x.id===pid)?.name || pid) : 'ï¼ˆãªã—ï¼‰';
    const c = document.createElement('div');
    if(pid){
      const prod = CATALOG.find(x=>x.id===pid);
      const btn = document.createElement('button'); btn.className='btn';
      btn.textContent = `å¤–ã™ï¼ˆ+${prod?.unequipCost||0}ï¼‰`;
      btn.disabled = asariAny() < (prod?.unequipCost||0);
      btn.addEventListener('click', ()=>{
        const cost = prod?.unequipCost||0;
        if(asariAny()<cost){ alert('å¤–ã™ã‚³ã‚¹ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“'); return; }
        if(!spendAsari(cost)){ alert('æ¶ˆè²»ã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }
        const nowEq = ensureEquip(); nowEq[slot] = null; writeJSON('who_equipment', nowEq);
        setAsariAny(); renderEquipPanel();
        // ã‚«ãƒ¼ãƒ‰å´ã®ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚‚æ›´æ–°
        CATALOG.forEach(p=>{
          const card = document.getElementById(`prod-${p.id}`);
          if(card){
            // ã–ã£ãã‚Šå†æç”»ï¼šè³¼å…¥ãƒœã‚¿ãƒ³ä»¥å¤–ã¯ã‚«ãƒ¼ãƒ‰ç”Ÿæˆæ™‚ã®ãƒ­ã‚¸ãƒƒã‚¯ã«ä¾å­˜ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ç°¡æ˜“ã«disabledã‚’ãƒªã‚»ãƒƒãƒˆ
            const btns = card.querySelectorAll('.btn'); btns.forEach(b=>b.disabled=false);
          }
        });
      });
      c.appendChild(btn);
    }else{
      c.textContent = '';
    }
    row.appendChild(a); row.appendChild(b); row.appendChild(c);
    wrap.appendChild(row);
  }
}

/* want= ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
function applyWant(){
  const want = new URLSearchParams(location.search).get('want');
  if(!want) return;
  const el = document.getElementById(`prod-${want}`);
  if(el){
    el.classList.add('highlight');
    el.scrollIntoView({behavior:'smooth', block:'center'});
    setTimeout(()=>el.classList.remove('highlight'), 2000);
  }
}

/* ====== èµ·å‹• ====== */
(function init(){
  // åˆæœŸã‚¹ãƒˆã‚¢ç¢ºä¿
  ensureShells(); ensureOwned(); ensureEquip();
  setAsariAny();
  mountCatalog();
  renderEquipPanel();
  applyWant();
})();
</script>
</body>
</html>

    html, body { height: 100%; margin: 0; background: #0b0f14; color: #ffffff; font-family: system-ui, "Noto Sans JP", sans-serif; }
    a { color: inherit; text-decoration: none; }

    /* ===== App Layout ===== */
    .app { position: relative; min-height: 100vh; padding: 72px 16px 88px; }

    /* Top Bar */
    .topbar { position: fixed; inset: 0 0 auto 0; height: 56px; padding: 8px 12px; display: flex; align-items: center; gap: 8px; background: linear-gradient(180deg, rgba(0,0,0,.65), rgba(0,0,0,0)); z-index: 10; }
    .topbar .btn { padding: 8px 12px; border: 1px solid rgba(255,255,255,.15); background: rgba(255,255,255,.08); border-radius: 12px; backdrop-filter: blur(6px); cursor: pointer; color:#fff; }
    .spacer { flex: 1; }

    /* Header */
    .header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
    .title { font-size: 20px; font-weight: 700; letter-spacing: .02em; color:#fff; }
    .subtitle { opacity: .95; font-size: 12px; color:#fff; }

    /* Character Preview */
    .char-box { position: fixed; right: 12px; bottom: 100px; width: 140px; height: 140px; display: grid; place-items: center; background: radial-gradient(120px 60px at 50% 30%, rgba(255,255,255,.12), rgba(255,255,255,0)); border: 1px solid rgba(255,255,255,.08); border-radius: 16px; }
    .char-box img { max-width: 80%; height: auto; image-rendering: auto; filter: drop-shadow(0 6px 14px rgba(0,0,0,.45)); }

    /* Filters */
    .controls { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin: 12px 0 16px; }
    .chip { padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.10); cursor: pointer; font-size: 12px; color:#fff; }
    .chip[aria-pressed="true"] { background: rgba(255,255,255,.25); }

    select { padding: 6px 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.10); color: #fff; }

    /* Progress */
    .progress { display: flex; align-items: center; gap: 10px; margin: 8px 0 12px; }
    .bar { flex: 1; height: 8px; background: rgba(255,255,255,.15); border-radius: 8px; overflow: hidden; }
    .bar > i { display: block; height: 100%; width: 0%; background: linear-gradient(90deg, #8ee8ff, #7cf3c9); }
    .progress .label { font-size: 12px; opacity: .95; color:#fff; }

    /* Grid */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; }

    .card { position: relative; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); border-radius: 14px; padding: 10px; display: grid; justify-items: center; gap: 8px; cursor: pointer; transition: transform .1s ease; }
    .card:hover { transform: translateY(-2px); }
    .card img { width: 72px; height: 72px; object-fit: contain; image-rendering: auto; filter: drop-shadow(0 4px 8px rgba(0,0,0,.35)); }
    .card .nm { font-size: 12px; text-align: center; line-height: 1.25; color:#fff; }
    .badge { position: absolute; top: 6px; right: 6px; font-size: 11px; padding: 2px 6px; border-radius: 999px; background: rgba(0,0,0,.55); border: 1px solid rgba(255,255,255,.18); color:#fff; }
    .rarity { position: absolute; left: 6px; top: 6px; font-size: 11px; padding: 2px 6px; border-radius: 999px; border: 1px solid rgba(255,255,255,.18); color:#fff; }

    /* Rarity Colors */
    .rN { background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.03)); }
    .rM { background: linear-gradient(180deg, rgba(140,200,255,.28), rgba(255,255,255,.03)); }
    .rH { background: linear-gradient(180deg, rgba(255,170,90,.28), rgba(255,255,255,.03)); }
    .rU { background: linear-gradient(180deg, rgba(255,120,180,.30), rgba(255,255,255,.03)); }

    /* Empty State */
    .empty { text-align: center; padding: 40px 12px; opacity: .9; color:#fff; }

    /* Bottom Bar */
    .bottombar { position: fixed; inset: auto 0 0 0; height: 72px; padding: 10px 12px; display: flex; align-items: center; gap: 10px; background: linear-gradient(0deg, rgba(0,0,0,.75), rgba(0,0,0,0)); z-index: 10; }
    .cta { flex: 1; padding: 10px 14px; border: 0; border-radius: 12px; font-weight: 700; cursor: pointer; color: #06251a; background: linear-gradient(90deg, #7cf3c9, #8ee8ff); box-shadow: 0 8px 24px rgba(124,243,201,.25); }
    .ghost { padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.10); color: #fff; cursor: pointer; }

    /* Modal */
    dialog { width: min(520px, 96vw); border: 1px solid rgba(255,255,255,.18); background: rgba(22,30,39,.95); color: inherit; border-radius: 16px; padding: 16px; }
    dialog::backdrop { background: rgba(0,0,0,.6); }
    .modal-hd { display: flex; align-items: center; gap: 12px; }
    .modal-hd img { width: 72px; height: 72px; object-fit: contain; }
    .modal-ttl { font-size: 18px; font-weight: 700; color:#fff; }
    .modal-sub { font-size: 12px; opacity: .95; color:#fff; }
    .modal-main { margin: 12px 0; line-height: 1.6; font-size: 14px; color:#fff; }
    .modal-act { display: flex; gap: 8px; justify-content: flex-end; }
  </style>
</head>
<body>
  <div class="topbar">
    <button class="btn" id="btnBack">â† æ½®å¹²ç‹©ã‚Šã¸</button>
    <button class="btn" id="btnReset" title="å…¨å‰Šé™¤">ãƒªã‚»ãƒƒãƒˆ</button>
    <div class="spacer"></div>
    <button class="btn" id="btnExport">CSVå‡ºåŠ›</button>
  </div>

  <div class="app">
    <div class="header">
      <div>
        <div class="title">ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å›³é‘‘ <span id="ver" class="subtitle"></span></div>
        <div class="subtitle">é›†ã‚ãŸè²ã‚’çœºã‚ã¦ã€èª¬æ˜ã‚„ãƒ¬ã‚¢åº¦ã‚’ãƒã‚§ãƒƒã‚¯ã§ãã¾ã™</div>
      </div>
    </div>

    <div class="controls">
      <span class="subtitle">ãƒ¬ã‚¢åº¦:</span>
      <button class="chip" data-filter="all" aria-pressed="true">ã™ã¹ã¦</button>
      <button class="chip" data-filter="N">ãƒãƒ¼ãƒãƒ«</button>
      <button class="chip" data-filter="M">ãƒŸãƒ‰ãƒ«</button>
      <button class="chip" data-filter="H">ãƒã‚¤</button>
      <button class="chip" data-filter="U">ã‚¦ãƒ«ãƒˆãƒ©</button>
      <div class="spacer"></div>
      <label class="subtitle" for="sort">ä¸¦ã³æ›¿ãˆ:</label>
      <select id="sort">
        <option value="rarity">ãƒ¬ã‚¢åº¦ â†’ åå‰</option>
        <option value="count">æ‰€æŒæ•° å¤šã„é †</option>
        <option value="name">åå‰ Aâ†’Z</option>
      </select>
    </div>

    <div class="progress">
      <div class="bar" aria-label="complete rate"><i id="bar"></i></div>
      <div class="label"><span id="found">0</span>/<span id="total">0</span> ç¨®ã‚³ãƒ³ãƒ—</div>
    </div>

    <div id="grid" class="grid" role="list"></div>
  </div>

  <div class="char-box" aria-label="é¸æŠä¸­ã‚­ãƒ£ãƒ©">
    <img id="charImg" alt="character" />
  </div>

  <div class="bottombar">
    <button class="ghost" id="btnHow">èª¬æ˜</button>
    <button class="cta" id="btnNext">äº¤æ›æ‰€ã¸ â†’</button>
  </div>

  <!-- Modal: item detail -->
  <dialog id="dlg">
    <div class="modal-hd">
      <img id="dlgImg" alt="shell" />
      <div>
        <div class="modal-ttl" id="dlgName">â€”</div>
        <div class="modal-sub" id="dlgMeta">â€”</div>
      </div>
    </div>
    <div class="modal-main" id="dlgDesc">â€”</div>
    <div class="modal-act">
      <button class="ghost" id="dlgClose" type="button">é–‰ã˜ã‚‹</button>
      <!-- â˜† submitåŒ–ã‚’é˜²ããŸã‚ type="button" ã‚’æ˜ç¤º -->
      <button class="cta" id="dlgToExchange" type="button">ã“ã®è²ã§äº¤æ›ã™ã‚‹</button>
    </div>
  </dialog>

  <!-- Modal: how to -->
  <dialog id="how">
    <div class="modal-ttl">ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å›³é‘‘ã«ã¤ã„ã¦</div>
    <div class="modal-main">
      <p>æ½®å¹²ç‹©ã‚Šã§é›†ã‚ãŸè²ãŒã“ã“ã«ä¸¦ã³ã¾ã™ã€‚ã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨èª¬æ˜ã¨ãƒ¬ã‚¢åº¦ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚</p>
      <ul>
        <li>ãƒãƒ¼ãƒãƒ«ï¼ˆNï¼‰â€¦ åŸºæœ¬é€šè²¨ã€‚10å€‹ã§ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼äº¤æ›ã«ä½¿ãˆã¾ã™ã€‚</li>
        <li>ãƒŸãƒ‰ãƒ«ï¼ˆMï¼‰â€¦ ä¼šè©±ãƒã‚±ãƒƒãƒˆç”¨ï¼ˆaurora / luminous / mystic / waveï¼‰ã€‚</li>
        <li>ãƒã‚¤ï¼ˆHï¼‰â€¦ é™å®šã‚¢ã‚¯ã‚»/æ¼”å‡ºè§£æ”¾ï¼ˆflame / night_skyï¼‰ã€‚</li>
        <li>ã‚¦ãƒ«ãƒˆãƒ©ï¼ˆUï¼‰â€¦ ç‰¹åˆ¥æ¼”å‡ºã¨ã‚¹ãƒˆãƒ¼ãƒªãƒ¼åˆ†å²ã‚­ãƒ¼ï¼ˆrainbow / pearlï¼‰ã€‚</li>
      </ul>
      <p>æº–å‚™ãŒã§ããŸã‚‰ã€Œäº¤æ›æ‰€ã¸ã€ãƒœã‚¿ãƒ³ã§ <code>exchange.html</code> ã«é€²ã¿ã¾ã™ã€‚</p>
    </div>
    <div class="modal-act">
      <button class="cta" id="howOk" type="button">OK</button>
    </div>
  </dialog>

  <script>
  ;(() => {
    // ===== Config =====
    const VERSION_KEY = 'who_stage_asari_version';
    const INVENTORY_KEYS = ['who_shells', 'who_shell_inventory', 'shells'];
    const CHARACTER_KEY = 'who_character';

    // ç”»åƒãƒ™ãƒ¼ã‚¹å€™è£œï¼ˆç›¸å¯¾/ãƒ«ãƒ¼ãƒˆã‚†ã‚Œå¯¾å¿œï¼‰
    const IMG_BASES = ['public/items', './public/items', '/public/items'];

    // ãƒã‚¹ã‚¿
    const SHELLS = [
      { id: 'asari1', name: 'ã‚¢ã‚µãƒªï¼ˆå°ï¼‰', rarity: 'N', desc: 'å°ç²’ã®ã‚¢ã‚µãƒªã€‚é›†ã‚ã‚„ã™ãã€åŸºæœ¬é€šè²¨ã¨ã—ã¦ä½¿ãˆã¾ã™ã€‚' },
      { id: 'asari2', name: 'ã‚¢ã‚µãƒªï¼ˆä¸­ï¼‰', rarity: 'N', desc: 'æ¨™æº–ã‚µã‚¤ã‚ºã®ã‚¢ã‚µãƒªã€‚10å€‹é›†ã‚ã‚‹ã¨ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼äº¤æ›ã«ä¸€æ­©å‰é€²ã€‚' },
      { id: 'asari3', name: 'ã‚¢ã‚µãƒªï¼ˆå¤§ï¼‰', rarity: 'N', desc: 'å¤§ãã‚ã®ã‚¢ã‚µãƒªã€‚è¦‹ã¤ã‹ã‚‹ã¨ã¡ã‚‡ã£ã¨å¬‰ã—ã„ã€‚' },

      { id: 'aurora_shell',   name: 'ã‚ªãƒ¼ãƒ­ãƒ©è²', rarity: 'M', desc: 'æ·¡ã„å…‰ã‚’æ”¾ã¤è²ã€‚ä¼šè©±ãƒã‚±ãƒƒãƒˆã¨äº¤æ›å¯èƒ½ã€‚' },
      { id: 'luminous_shell', name: 'ãƒ«ãƒŸãƒŠã‚¹è²', rarity: 'M', desc: 'å¤œã§ã‚‚è¼ãè²ã€‚ä¼šè©±ãƒã‚±ãƒƒãƒˆã®ææ–™ã€‚' },
      { id: 'mystic_shell',   name: 'ãƒŸã‚¹ãƒ†ã‚£ãƒƒã‚¯è²', rarity: 'M', desc: 'ç¥ç§˜ã®æ¨¡æ§˜ãŒæµ®ã‹ã¶è²ã€‚ä¼šè©±ãƒã‚±ãƒƒãƒˆå‘ã‘ã€‚' },
      { id: 'wave_shell',     name: 'æ³¢ã®è²', rarity: 'M', desc: 'æ³¢ã®ã†ã­ã‚Šã‚’é–‰ã˜è¾¼ã‚ãŸã‚ˆã†ãªè²ã€‚' },

      { id: 'flame_shell',    name: 'ç‚ã®è²', rarity: 'H', desc: 'ç‡ƒãˆã‚‹ã‚ˆã†ãªæ¨¡æ§˜ã€‚é™å®šã‚¢ã‚¯ã‚»ã‚„æ¼”å‡ºã®ã‚­ãƒ¼ã€‚' },
      { id: 'night_sky_shell',name: 'å¤œç©ºã®è²', rarity: 'H', desc: 'æº€å¤©ã®æ˜Ÿã‚’é–‰ã˜è¾¼ã‚ãŸã‚ˆã†ã€‚é™å®šæ¼”å‡ºã®è§£æ”¾ã«ã€‚' },

      { id: 'rare_rainbow',   name: 'ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼è²', rarity: 'U', desc: 'ä¸ƒè‰²ã«è¼ãè¶…ãƒ¬ã‚¢è²ã€‚ç‰¹åˆ¥æ¼”å‡ºã¨åˆ†å²ã®ã‚­ãƒ¼ã€‚' },
      { id: 'rare_pearl',     name: 'çœŸç ', rarity: 'U', desc: 'æµ·ã®å®çŸ³ã€‚è¶…ãƒ¬ã‚¢ã€‚æ–°ãŸãªç‰©èªã‚’é–‹ãã€‚' },
    ];

    const RARITY_LABEL = { N: 'ãƒãƒ¼ãƒãƒ«', M: 'ãƒŸãƒ‰ãƒ«', H: 'ãƒã‚¤', U: 'ã‚¦ãƒ«ãƒˆãƒ©' };
    const RARITY_ORDER = { U: 0, H: 1, M: 2, N: 3 };

    // ===== State =====
    let inventory = Object.fromEntries(SHELLS.map(s => [s.id, 0]));

    // ===== Utils =====
    const qs = (sel, el = document) => el.querySelector(sel);
    const qsa = (sel, el = document) => Array.from(el.querySelectorAll(sel));
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

    function loadVersion() { const v = localStorage.getItem(VERSION_KEY); return v ? String(v) : ''; }

    function loadInventory() {
      let data = null;
      for (const k of INVENTORY_KEYS) {
        const raw = localStorage.getItem(k);
        if (!raw) continue;
        try { data = JSON.parse(raw); break; } catch {}
      }
      let obj = {};
      if (data && typeof data === 'object') { obj = data.items && typeof data.items === 'object' ? data.items : data; }
      const out = { ...inventory };
      for (const s of SHELLS) { const n = Number(obj[s.id] || 0); out[s.id] = Number.isFinite(n) ? clamp(n, 0, 9999) : 0; }
      return out;
    }

    function saveInventory(inv) { const payload = { items: inv, updatedAt: new Date().toISOString(), schema: 'who_shells/v1' }; localStorage.setItem('who_shells', JSON.stringify(payload)); }

    function parseAddParam() {
      const u = new URL(location.href);
      const add = u.searchParams.get('add');
      if (!add) return null;
      const list = add.split(',').map(x => x.trim()).filter(Boolean);
      const delta = {};
      for (const item of list) {
        const [id, n] = item.split(':');
        if (!id) continue;
        const num = Number(n || 1);
        if (SHELLS.some(s => s.id === id) && Number.isFinite(num)) { delta[id] = (delta[id] || 0) + Math.max(0, Math.min(9999, num)); }
      }
      return Object.keys(delta).length ? delta : null;
    }

    function mergeDelta(inv, delta) { const out = { ...inv }; for (const [id, n] of Object.entries(delta)) { out[id] = Math.max(0, Math.min(9999, (out[id] || 0) + n)); } return out; }

    function fmtCount(n) { return `${n} å€‹`; }

    function setShellImg(el, id, idx = 0) {
      if (idx >= IMG_BASES.length) { el.style.opacity = '.3'; el.alt = 'no image'; return; }
      el.onerror = () => setShellImg(el, id, idx + 1);
      el.src = `${IMG_BASES[idx]}/${id}.png`;
    }

    // ===== Render =====
    function renderGrid(filter = 'all', sort = 'rarity') {
      const grid = qs('#grid');
      grid.innerHTML = '';
      const items = SHELLS.map(s => ({ ...s, count: inventory[s.id] || 0 })).filter(it => filter === 'all' ? true : it.rarity === filter);

      items.sort((a,b) => {
        if (sort === 'count') return (b.count - a.count) || (RARITY_ORDER[a.rarity] - RARITY_ORDER[b.rarity]) || a.name.localeCompare(b.name, 'ja');
        if (sort === 'name') return a.name.localeCompare(b.name, 'ja');
        const r = (RARITY_ORDER[a.rarity] - RARITY_ORDER[b.rarity]); if (r !== 0) return r; return a.name.localeCompare(b.name, 'ja');
      });

      if (!items.length) { grid.innerHTML = `<div class="empty">è©²å½“ã™ã‚‹è²ãŒã‚ã‚Šã¾ã›ã‚“</div>`; return; }

      for (const it of items) {
        const card = document.createElement('button');
        card.className = `card r${it.rarity}`;
        card.setAttribute('role', 'listitem');
        card.innerHTML = `
          <span class="rarity">${RARITY_LABEL[it.rarity] || it.rarity}</span>
          <span class="badge">${fmtCount(it.count)}</span>
          <img alt="${it.name}" />
          <div class="nm">${it.name}</div>`;
        const img = card.querySelector('img');
        setShellImg(img, it.id, 0);
        card.addEventListener('click', () => openDetail(it));
        grid.appendChild(card);
      }

      const totalKinds = SHELLS.length;
      const foundKinds = SHELLS.reduce((a,s) => a + ((inventory[s.id]||0)>0?1:0), 0);
      qs('#total').textContent = String(totalKinds);
      qs('#found').textContent = String(foundKinds);
      qs('#bar').style.width = `${Math.round(foundKinds/totalKinds*100)}%`;
    }

    function openDetail(it) {
      const dlg = document.querySelector('#dlg');
      const img = document.querySelector('#dlgImg');
      setShellImg(img, it.id, 0);
      img.alt = it.name;
      document.querySelector('#dlgName').textContent = it.name;
      const stars = {N:'â˜…', M:'â˜…â˜…', H:'â˜…â˜…â˜…', U:'â˜…â˜…â˜…â˜…'}[it.rarity] || '';
      document.querySelector('#dlgMeta').textContent = `${RARITY_LABEL[it.rarity]} ${stars}ãƒ»æ‰€æŒ ${fmtCount(inventory[it.id] || 0)}`;
      document.querySelector('#dlgDesc').textContent = it.desc;

      // é‡è¦ï¼šãƒãƒ–ãƒªãƒ³ã‚°/æ—¢å®šå‹•ä½œã‚’æ­¢ã‚ã€ç¢ºå®Ÿã«äº¤æ›æ‰€ã¸
      const btn = document.querySelector('#dlgToExchange');
      btn.onclick = null;
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const url = new URL('exchange.html', location.href);
        url.searchParams.set('want', it.id);
        window.location.assign(url.toString());
      }, { once:true });

      document.querySelector('#dlgClose').onclick = () => dlg.close();
      dlg.showModal();
    }

    function renderCharacter() {
      const color = (localStorage.getItem(CHARACTER_KEY) || '').replace(/[^a-z]/g,'') || 'pink';
      const img = document.querySelector('#charImg');
      const candidates = [
        `public/stage1/${color}_open.png`,
        `public/assets/stage1/${color}_open.png`,
        `./public/stage1/${color}_open.png`,
        `public/items/character_${color}.png`,
        `public/items/character.png`
      ];
      let i = 0; const next = () => { if (i < candidates.length) { img.onerror = () => { i++; next(); }; img.src = candidates[i]; img.alt = `character ${color}`; } else { img.alt = 'character'; img.style.opacity = '.3'; } }; next();
    }

    // ===== Wire Up =====
    function init() {
      const ver = localStorage.getItem('who_stage_asari_version'); if (ver) document.querySelector('#ver').textContent = `ï¼ˆ${ver}ï¼‰`;
      inventory = loadInventory();
      const delta = parseAddParam(); if (delta) { inventory = mergeDelta(inventory, delta); saveInventory(inventory); }
      renderCharacter();
      renderGrid('all', 'rarity');

      qsa('.chip').forEach(btn => btn.addEventListener('click', () => {
        qsa('.chip').forEach(b => b.setAttribute('aria-pressed', 'false'));
        btn.setAttribute('aria-pressed', 'true');
        const filter = btn.dataset.filter || 'all'; const sort = document.querySelector('#sort').value; renderGrid(filter, sort);
      }));

      document.querySelector('#sort').addEventListener('change', (e) => {
        const filter = qsa('.chip').find(b => b.getAttribute('aria-pressed') === 'true')?.dataset.filter || 'all';
        renderGrid(filter, e.target.value);
      });

      document.querySelector('#btnBack').addEventListener('click', () => location.href = 'asari.html');
      document.querySelector('#btnNext').addEventListener('click', () => location.href = 'exchange.html');
      document.querySelector('#btnHow').addEventListener('click', () => document.querySelector('#how').showModal());
      document.querySelector('#howOk').addEventListener('click', () => document.querySelector('#how').close());

      document.querySelector('#btnReset').addEventListener('click', () => {
        if (!confirm('è²ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å…¨å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
        inventory = Object.fromEntries(SHELLS.map(s => [s.id, 0]));
        saveInventory(inventory);
        renderGrid();
      });

      document.querySelector('#btnExport').addEventListener('click', () => exportCSV());
    }

    function exportCSV() {
      const headers = ['id','name','rarity','count'];
      const rows = SHELLS.map(s => [s.id, s.name, RARITY_LABEL[s.rarity], inventory[s.id] || 0]);
      const csv = [headers.join(','), ...rows.map(r => r.map(v => String(v).replaceAll('"','\"')).join(','))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'shell_collection.csv'; a.click(); URL.revokeObjectURL(url);
    }

    document.addEventListener('DOMContentLoaded', init);
  })();
  </script>
</body>
</html>
