<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>WHO VQ â€” äº¤æ›æ‰€ï¼ˆè£…å‚™å¯¾å¿œï¼‰</title>
  <style>
    /* ===== Base ===== */
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%;margin:0;background:#0b0f14;color:#fff;font-family:system-ui,"Noto Sans JP",sans-serif}
    a{color:inherit;text-decoration:none}
    .app{min-height:100vh;padding:72px 16px 116px;position:relative}

    /* Topbar */
    .topbar{position:fixed;inset:0 0 auto 0;height:56px;padding:8px 12px;display:flex;align-items:center;gap:8px;background:linear-gradient(180deg,rgba(0,0,0,.65),rgba(0,0,0,0));z-index:10}
    .btn{padding:8px 12px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);border-radius:12px;backdrop-filter:blur(6px);cursor:pointer;color:#fff}
    .spacer{flex:1}

    /* Header / controls */
    .title{font-weight:800;font-size:20px;letter-spacing:.02em}
    .subtitle{opacity:.95;font-size:12px}
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:12px 0 16px}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);cursor:pointer;font-size:12px}
    .chip[aria-pressed="true"]{background:rgba(255,255,255,.22)}
    .search{display:flex;gap:6px;align-items:center;margin-left:auto}
    .search input{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:#fff;min-width:160px}

    /* Summary */
    .summary{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:6px 0 14px}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06)}
    .pill img{width:18px;height:18px;object-fit:contain;filter:drop-shadow(0 2px 4px rgba(0,0,0,.35))}

    /* Equipment panel */
    .equip{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;margin:10px 0 18px}
    .slot{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);border-radius:12px;padding:10px;display:grid;gap:6px}
    .slot h4{margin:0;font-size:12px;opacity:.9}
    .slot .cur{min-height:36px;font-size:13px}
    .slot .row{display:flex;gap:6px;flex-wrap:wrap}
    .tiny{font-size:11px;opacity:.85}
    .mini{padding:6px 8px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:#fff;cursor:pointer}

    /* Grid */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
    .card{position:relative;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);border-radius:14px;padding:12px;display:grid;grid-template-rows:auto 1fr auto;gap:8px}
    .iconWrap{display:grid;place-items:center;height:110px}
    .icon{width:96px;height:96px;object-fit:contain;filter:drop-shadow(0 8px 16px rgba(0,0,0,.45))}
    .nm{font-size:14px;font-weight:700}
    .desc{font-size:12px;opacity:.95}
    .cost{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px}
    .badge{display:inline-flex;gap:4px;align-items:center;padding:4px 6px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);border-radius:999px;font-size:12px}
    .badge img{width:16px;height:16px;object-fit:contain;filter:drop-shadow(0 2px 4px rgba(0,0,0,.35))}
    .own{position:absolute;top:8px;right:8px;font-size:11px;padding:2px 6px;border-radius:999px;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.18)}
    .act{display:flex;gap:8px;flex-wrap:wrap}
    .buy{flex:1;padding:10px 12px;border:0;border-radius:12px;font-weight:700;cursor:pointer;color:#06251a;background:linear-gradient(90deg,#7cf3c9,#8ee8ff);box-shadow:0 8px 16px rgba(124,243,201,.22)}
    .buy[disabled]{cursor:not-allowed;filter:grayscale(.6) brightness(.8)}
    .ghost{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:#fff;cursor:pointer}
    .equipBtn{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.1);color:#fff;cursor:pointer}
    .tag{position:absolute;top:8px;left:8px;font-size:11px;padding:2px 6px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06)}

    /* Category colors for generated icons */
    .cat-acc{--c1:#9be7ff;--c2:#e6fbff}
    .cat-tkt{--c1:#a3ffa8;--c2:#eaffea}
    .cat-eff{--c1:#ffd19a;--c2:#fff3e2}
    .cat-spc{--c1:#ffb2da;--c2:#ffe6f3}
    .cat-gear{--c1:#c6b3ff;--c2:#f1ecff}

    /* Bottom */
    .bottombar{position:fixed;inset:auto 0 0 0;height:76px;padding:10px 12px;display:flex;align-items:center;gap:10px;background:linear-gradient(0deg,rgba(0,0,0,.75),rgba(0,0,0,0));z-index:10}
  </style>
</head>
<body>
  <div class="topbar">
    <button class="btn" id="btnBack">â† å›³é‘‘ã¸</button>
    <div class="spacer"></div>
    <button class="btn" id="btnResetOwn">è³¼å…¥å±¥æ­´ãƒªã‚»ãƒƒãƒˆ</button>
    <button class="btn" id="btnResetEquip">è£…å‚™ãƒªã‚»ãƒƒãƒˆ</button>
  </div>

  <div class="app">
    <div class="title">äº¤æ›æ‰€</div>
    <div class="subtitle">å•†å“ã‚’äº¤æ›ã—ã€è£…å‚™å“ã¯ã•ã‚‰ã«<strong>è£…ç€/è„±ç€</strong>ã«è²ã‚’ä½¿ã„ã¾ã™</div>

    <div class="controls">
      <button class="chip" data-cat="all" aria-pressed="true">ã™ã¹ã¦</button>
      <button class="chip" data-cat="acc">ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼</button>
      <button class="chip" data-cat="gear">è£…å‚™ï¼ˆé´/æœ/å¸½å­ãªã©ï¼‰</button>
      <button class="chip" data-cat="tkt">ãƒã‚±ãƒƒãƒˆ</button>
      <button class="chip" data-cat="eff">æ¼”å‡º</button>
      <button class="chip" data-cat="spc">ã‚¹ãƒšã‚·ãƒ£ãƒ«</button>
      <div class="search">
        <input id="q" type="search" placeholder="å•†å“åã§æ¤œç´¢â€¦" />
      </div>
    </div>

    <!-- æ‰€æŒã‚µãƒãƒª -->
    <div id="summary" class="summary"></div>

    <!-- è£…å‚™ã‚¹ãƒ­ãƒƒãƒˆ -->
    <div class="equip" id="equipPanel" aria-label="è£…å‚™ãƒ‘ãƒãƒ«"></div>

    <div id="grid" class="grid"></div>
  </div>

  <div class="bottombar">
    <button class="btn" id="btnHow">ä½¿ã„æ–¹</button>
    <button class="btn" id="btnToStory">ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã¸ â†’</button>
  </div>

  <!-- HowTo -->
  <dialog id="how">
    <div class="modal-ttl">äº¤æ›æ‰€ã®ä½¿ã„æ–¹</div>
    <div class="modal-main">
      <ul>
        <li>ãƒãƒ¼ãƒãƒ«ï¼ˆã‚¢ã‚µãƒª1ã€œ3ï¼‰ã¯ <b>åˆç®—</b>ã§ä½¿ãˆã¾ã™ï¼ˆè¡¨ç¤ºï¼š<i>åˆç®—</i>ï¼‰ã€‚</li>
        <li>è£…å‚™å“ã¯ã€<b>äº¤æ›ï¼ˆè³¼å…¥ï¼‰</b>ã—ãŸã†ãˆã§<b>è£…ç€</b>ã™ã‚‹ã¨åæ˜ ã•ã‚Œã¾ã™ã€‚</li>
        <li>è£…ç€/è„±ç€ãã‚Œãã‚Œã«è¿½åŠ ã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚Šã¾ã™ï¼ˆã‚«ãƒ¼ãƒ‰ã«è¡¨ç¤ºï¼‰ã€‚</li>
        <li>åŒä¸€ã‚¹ãƒ­ãƒƒãƒˆã«åˆ¥è£…å‚™ã‚’è£…ç€ã™ã‚‹ã¨ã€å…ˆã®è£…å‚™ã‚’<b>è‡ªå‹•ã§è„±ç€</b>ï¼ˆã‚³ã‚¹ãƒˆæ¶ˆè²»ï¼‰ã—ã¦ã‹ã‚‰è£…ç€ã—ã¾ã™ã€‚</li>
      </ul>
    </div>
    <div class="modal-act">
      <button class="btn" onclick="document.getElementById('how').close()">OK</button>
    </div>
  </dialog>

  <script>
  ;(() => {
    /* ===== Config / Storage Keys ===== */
    const STORAGE_INV   = 'who_shells';          // asari.html ã¨å…±é€š
    const STORAGE_OWN   = 'who_exchange_owned';  // äº¤æ›æ¸ˆã¿å€‹æ•°
    const STORAGE_EQUIP = 'who_equipment';       // è£…å‚™ã‚¹ãƒ­ãƒƒãƒˆçŠ¶æ…‹
    const IMG_BASES     = ['public/items','./public/items','/public/items'];

    // ã‚·ã‚§ãƒ«ID â†’ è¡¨ç¤ºå
    const SHELL_NAME = {
      asari1:'ã‚¢ã‚µãƒªï¼ˆå°ï¼‰', asari2:'ã‚¢ã‚µãƒªï¼ˆä¸­ï¼‰', asari3:'ã‚¢ã‚µãƒªï¼ˆå¤§ï¼‰',
      aurora_shell:'ã‚ªãƒ¼ãƒ­ãƒ©è²', luminous_shell:'ãƒ«ãƒŸãƒŠã‚¹è²', mystic_shell:'ãƒŸã‚¹ãƒ†ã‚£ãƒƒã‚¯è²', wave_shell:'æ³¢ã®è²',
      flame_shell:'ç‚ã®è²', night_sky_shell:'å¤œç©ºã®è²',
      rare_rainbow:'ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼è²', rare_pearl:'çœŸç '
    };

    // è£…å‚™ã‚¹ãƒ­ãƒƒãƒˆ
    const SLOTS = {
      head:  'é ­',
      body:  'æœ',
      back:  'èƒŒä¸­',
      hands: 'æ‰‹',
      shoes: 'é´',
      style: 'ã‚¹ã‚¿ã‚¤ãƒ«'
    };

    /* ===== å•†å“ã‚«ã‚¿ãƒ­ã‚° =====
       - type: 'item'ï¼ˆé€šå¸¸ï¼‰ or 'gear'ï¼ˆè£…å‚™ï¼‰
       - cat:  è¡¨ç¤ºã‚«ãƒ†ã‚´ãƒªï¼ˆacc/gear/tkt/eff/spcï¼‰
       - cost: è³¼å…¥ã‚³ã‚¹ãƒˆ
       - equipCost / unequipCost: gearã®ã¿è£…ç€/è„±ç€ã‚³ã‚¹ãƒˆ
       - slot: è£…å‚™ã‚¹ãƒ­ãƒƒãƒˆï¼ˆgearã®ã¿ï¼‰
    */
    const CATALOG = [
      /* --- æ—¢å­˜ï¼ˆä¾‹ï¼‰ã‚¢ã‚¯ã‚»ç³»ï¼ˆåˆç®—ï¼‰ --- */
      { id:'acc_pin',   name:'è²æ®»ãƒ˜ã‚¢ãƒ”ãƒ³',      type:'item', cat:'acc', desc:'æµœè¾ºãƒ†ã‚¤ã‚¹ãƒˆã®ãƒ¯ãƒ³ãƒã‚¤ãƒ³ãƒˆã€‚', cost:[{id:'asari_any',qty:10}] },
      { id:'acc_ear1',  name:'æ³¢ãã‚‰ã‚Šã‚¤ãƒ¤ãƒªãƒ³ã‚°',type:'item', cat:'acc', desc:'ã•ã–æ³¢ã®ãã‚‰ã‚ããƒ¢ãƒãƒ¼ãƒ•ã€‚',   cost:[{id:'asari_any',qty:12}] },

      /* --- ãƒã‚±ãƒƒãƒˆ --- */
      { id:'tkt_aurora', name:'ä¼šè©±ãƒã‚±ãƒƒãƒˆA', type:'item', cat:'tkt', desc:'å¿ƒãŒã»ã©ã‘ã‚‹è©±é¡Œã¸ã€‚', cost:[{id:'aurora_shell',qty:1}] },

      /* --- æ¼”å‡º --- */
      { id:'fx_flameTrail', name:'ç‚ã®è¶³è·¡ãƒˆãƒ¬ã‚¤ãƒ«', type:'item', cat:'eff', desc:'ç§»å‹•ã«ç‚ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã€‚', cost:[{id:'flame_shell',qty:1},{id:'asari_any',qty:10}] },

      /* --- ã‚¹ãƒšã‚·ãƒ£ãƒ« --- */
      { id:'spc_rainbow', name:'ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼æ¼”å‡ºè§£æ”¾', type:'item', cat:'spc', desc:'ä¸ƒè‰²ã®ç‰¹åˆ¥æ¼”å‡ºã€‚', cost:[{id:'rare_rainbow',qty:1}] },

      /* ===================================================== */
      /* ===================  è£…å‚™ï¼ˆæ–°è¦ï¼‰  =================== */
      /* å˜å“ï¼šé´ãƒ»æœãªã© */
      { id:'gear_shoes_beach', name:'ç ‚æµœã‚¹ãƒ‹ãƒ¼ã‚«ãƒ¼', type:'gear', cat:'gear', slot:'shoes',
        desc:'æ¿¡ã‚Œã¦ã‚‚ã¸ã£ã¡ã‚ƒã‚‰ãªè»½é‡é´ã€‚', cost:[{id:'asari_any',qty:15}],
        equipCost:[{id:'asari_any',qty:3}], unequipCost:[{id:'asari_any',qty:1}] },

      { id:'gear_boots_explorer', name:'æ¢æ¤œãƒ–ãƒ¼ãƒ„', type:'gear', cat:'gear', slot:'shoes',
        desc:'æ»‘ã‚Šã«ãã„ã‚½ãƒ¼ãƒ«ã§å®‰å¿ƒã€‚', cost:[{id:'asari_any',qty:22}],
        equipCost:[{id:'asari_any',qty:4}], unequipCost:[{id:'asari_any',qty:2}] },

      { id:'gear_hat_explorer', name:'æ¢æ¤œå¸½ï¼ˆèŒ¶ï¼‰', type:'gear', cat:'gear', slot:'head',
        desc:'æ£®ã®å†’é™ºã«ï¼', cost:[{id:'flame_shell',qty:1},{id:'asari_any',qty:8}],
        equipCost:[{id:'asari_any',qty:3}], unequipCost:[{id:'asari_any',qty:1}] },

      { id:'gear_vest_orange', name:'ã‚ªãƒ¬ãƒ³ã‚¸ã®ãƒ™ã‚¹ãƒˆ', type:'gear', cat:'gear', slot:'body',
        desc:'å®Ÿç”¨çš„ã§å‹•ãã‚„ã™ã„ã€‚', cost:[{id:'asari_any',qty:14}],
        equipCost:[{id:'asari_any',qty:2}], unequipCost:[{id:'asari_any',qty:1}] },

      { id:'gear_backpack_red', name:'èµ¤ã„ãƒãƒƒã‚¯ãƒ‘ãƒƒã‚¯', type:'gear', cat:'gear', slot:'back',
        desc:'å¿…è¦ãªé“å…·ã‚’ã—ã£ã‹ã‚Šåç´ã€‚', cost:[{id:'asari_any',qty:12}],
        equipCost:[{id:'asari_any',qty:2}], unequipCost:[{id:'asari_any',qty:1}] },

      { id:'gear_hat_wizard', name:'é­”æ³•å¸½ï¼ˆç´«ï¼‰', type:'gear', cat:'gear', slot:'head',
        desc:'å…ˆç«¯ãŒãã‚‹ã‚“ã¨æ›²ãŒã£ãŸå¸½å­ã€‚', cost:[{id:'luminous_shell',qty:1},{id:'asari_any',qty:8}],
        equipCost:[{id:'asari_any',qty:3}], unequipCost:[{id:'asari_any',qty:1}] },

      { id:'gear_robe_star', name:'æ˜Ÿã®ãƒ­ãƒ¼ãƒ–', type:'gear', cat:'gear', slot:'body',
        desc:'æ˜ŸãŒæ•£ã‚Šã°ã‚ã‚‰ã‚ŒãŸç¥ç§˜ã®ãƒ­ãƒ¼ãƒ–ã€‚', cost:[{id:'mystic_shell',qty:1},{id:'asari_any',qty:12}],
        equipCost:[{id:'asari_any',qty:4}], unequipCost:[{id:'asari_any',qty:2}] },

      { id:'gear_wand_magic', name:'é­”æ³•ã®æ–', type:'gear', cat:'gear', slot:'hands',
        desc:'æ–å…ˆãŒã»ã®ã‹ã«å…‰ã‚‹ã€‚', cost:[{id:'luminous_shell',qty:1},{id:'mystic_shell',qty:1}],
        equipCost:[{id:'asari_any',qty:5}], unequipCost:[{id:'asari_any',qty:2}] },

      /* ã‚¹ã‚¿ã‚¤ãƒ«ä¸€å¼ï¼ˆã‚»ãƒƒãƒˆã®é›°å›²æ°—ã‚’ä»˜ä¸ã™ã‚‹â€œã‚¹ã‚¿ã‚¤ãƒ«â€ã‚¹ãƒ­ãƒƒãƒˆï¼‰ */
      { id:'style_adventurer', name:'å†’é™ºå®¶ã‚¹ã‚¿ã‚¤ãƒ«', type:'gear', cat:'gear', slot:'style',
        desc:'èŒ¶ã®æ¢æ¤œå¸½ + ã‚ªãƒ¬ãƒ³ã‚¸ã®ãƒ™ã‚¹ãƒˆ + èµ¤ãƒãƒƒã‚¯ãƒ‘ãƒƒã‚¯ã®å®Ÿç”¨è£…ã„ã€‚', 
        cost:[{id:'asari_any',qty:20},{id:'flame_shell',qty:1}],
        equipCost:[{id:'asari_any',qty:5}], unequipCost:[{id:'asari_any',qty:3}] },

      { id:'style_wizard', name:'é­”æ³•ä½¿ã„ã‚¹ã‚¿ã‚¤ãƒ«', type:'gear', cat:'gear', slot:'style',
        desc:'ç´«ã®é­”æ³•å¸½ã¨æ˜Ÿãƒ­ãƒ¼ãƒ–ã€é­”æ³•ã®æ–ã®ç¥ç§˜ã‚¹ã‚¿ã‚¤ãƒ«ã€‚', 
        cost:[{id:'asari_any',qty:20},{id:'night_sky_shell',qty:1},{id:'mystic_shell',qty:1}],
        equipCost:[{id:'asari_any',qty:6}], unequipCost:[{id:'asari_any',qty:3}] },
      /* ===================================================== */
    ];

    const CATS = {acc:'ã‚¢ã‚¯ã‚»', gear:'è£…å‚™', tkt:'ãƒã‚±ãƒƒãƒˆ', eff:'æ¼”å‡º', spc:'ã‚¹ãƒšã‚·ãƒ£ãƒ«'};

    /* ===== State ===== */
    let inv = {};                        // æ‰€æŒè² {id:count}
    let owned = {};                      // äº¤æ›æ¸ˆ {productId:count}
    let equip = {};                      // è£…å‚™ {slot: productId|null}
    let filterCat = 'all', qText = '';

    /* ===== Utils ===== */
    const qs = (s,el=document)=>el.querySelector(s);
    const qsa = (s,el=document)=>Array.from(el.querySelectorAll(s));
    const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));

    function setShellImg(img, id, idx=0){
      if(idx>=IMG_BASES.length){ img.style.opacity='.35'; img.alt='no image'; return; }
      img.onerror = ()=> setShellImg(img,id,idx+1);
      img.src = `${IMG_BASES[idx]}/${id}.png`;
      img.alt = SHELL_NAME[id] || id;
    }

    function genEmojiSVG(emoji, cls){
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="180" height="180" viewBox="0 0 180 180">
          <defs><radialGradient id="g" cx="50%" cy="35%" r="70%">
            <stop offset="0%" stop-color="var(--c2)"/><stop offset="100%" stop-color="var(--c1)"/></radialGradient></defs>
          <circle cx="90" cy="90" r="78" fill="url(#g)"/>
          <text x="50%" y="50%" dominant-baseline="central" text-anchor="middle" font-size="84">${emoji}</text>
        </svg>`;
      const img = new Image(); img.className='icon '+cls; img.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
      return img;
    }

    function loadInventory(){
      inv = {};
      try{
        const raw = localStorage.getItem(STORAGE_INV); 
        const data = raw? JSON.parse(raw): null;
        const items = data && data.items ? data.items : (data||{});
        ['asari1','asari2','asari3','aurora_shell','luminous_shell','mystic_shell','wave_shell',
         'flame_shell','night_sky_shell','rare_rainbow','rare_pearl'].forEach(k=>{
          const n = Number(items[k]||0);
          inv[k] = Number.isFinite(n)? clamp(n,0,9999): 0;
        });
      }catch{}
    }
    function saveInventory(){ 
      const payload = { items: inv, updatedAt: new Date().toISOString(), schema: 'who_shells/v1' };
      localStorage.setItem(STORAGE_INV, JSON.stringify(payload));
    }
    function loadOwned(){ try{ owned = JSON.parse(localStorage.getItem(STORAGE_OWN)||'{}'); }catch{ owned = {}; } }
    function saveOwned(){ localStorage.setItem(STORAGE_OWN, JSON.stringify(owned)); }
    function loadEquip(){ 
      try{ equip = JSON.parse(localStorage.getItem(STORAGE_EQUIP)||'{}'); }catch{ equip={}; }
      for(const k of Object.keys(SLOTS)){ if(!(k in equip)) equip[k]=null; }
    }
    function saveEquip(){ localStorage.setItem(STORAGE_EQUIP, JSON.stringify(equip)); }

    function asariTotal(){ return (inv.asari1||0)+(inv.asari2||0)+(inv.asari3||0); }

    function mergeCosts(a=[], b=[]){
      const m = {};
      [...a,...b].forEach(c => { m[c.id]=(m[c.id]||0)+(c.qty||0); });
      return Object.entries(m).map(([id,qty])=>({id,qty}));
    }

    function canAfford(cost){
      const pool = { ...inv, asari_any: asariTotal() };
      return cost.every(c => (pool[c.id]||0) >= c.qty);
    }

    function spend(cost){
      for(const c of cost){
        if(c.id==='asari_any'){
          let remain = c.qty;
          const order = ['asari3','asari2','asari1']; // å¤§ãã„ã®ã‹ã‚‰ä½¿ã†
          for(const k of order){
            const use = Math.min(inv[k]||0, remain);
            inv[k] = (inv[k]||0) - use;
            remain -= use;
          }
        }else{
          inv[c.id] = (inv[c.id]||0) - c.qty;
        }
      }
      saveInventory();
    }

    /* ===== Render: summary ===== */
    function renderSummary(){
      const wrap = qs('#summary'); wrap.innerHTML='';
      const keys = [
        'asari1','asari2','asari3','aurora_shell','luminous_shell','mystic_shell','wave_shell',
        'flame_shell','night_sky_shell','rare_rainbow','rare_pearl'
      ];
      // åˆç®—
      const sum = document.createElement('span'); sum.className='pill';
      sum.innerHTML = `<b>${asariTotal()}</b><span>ã‚¢ã‚µãƒªåˆè¨ˆ</span>`;
      wrap.appendChild(sum);

      for(const id of keys){
        const pill = document.createElement('span'); pill.className='pill';
        const img = new Image(); setShellImg(img,id,0);
        const n = document.createElement('b'); n.textContent = String(inv[id]||0);
        const nm= document.createElement('span'); nm.textContent = SHELL_NAME[id]||id;
        pill.append(img,n,nm); wrap.appendChild(pill);
      }
    }

    /* ===== Render: equip panel ===== */
    function costBadge(c){
      const el = document.createElement('span'); el.className='badge';
      const img = new Image();
      if(c.id==='asari_any'){ setShellImg(img,'asari1',0); el.append(img, document.createTextNode(`Ã—${c.qty}ï¼ˆåˆç®—ï¼‰`)); }
      else { setShellImg(img,c.id,0); el.append(img, document.createTextNode('Ã—'+c.qty)); }
      return el;
    }

    function renderEquipPanel(){
      const wrap = qs('#equipPanel'); wrap.innerHTML='';
      for(const [slot, label] of Object.entries(SLOTS)){
        const box = document.createElement('div'); box.className='slot';
        const h = document.createElement('h4'); h.textContent = `${label}ï¼ˆ${slot}ï¼‰`; box.appendChild(h);

        const cur = equip[slot];
        const curDiv = document.createElement('div'); curDiv.className='cur';
        if(cur){
          const p = CATALOG.find(x=>x.id===cur);
          curDiv.textContent = p ? p.name : cur;
          const row = document.createElement('div'); row.className='row';
          const note = document.createElement('span'); note.className='tiny'; note.textContent='è„±ç€ã‚³ã‚¹ãƒˆ:';
          row.appendChild(note);
          (p.unequipCost||[]).forEach(c=> row.appendChild(costBadge(c)));
          const btn = document.createElement('button'); btn.className='mini'; btn.textContent='å¤–ã™';
          btn.addEventListener('click', ()=> onUnequip(slot));
          box.append(curDiv,row,btn);
        }else{
          curDiv.textContent = 'â€” è£…å‚™ãªã— â€”';
          box.appendChild(curDiv);
        }
        wrap.appendChild(box);
      }
    }

    /* ===== Render: product grid ===== */
    function render(){
      renderSummary();
      renderEquipPanel();

      const grid = qs('#grid'); grid.innerHTML='';
      const text = qText.trim();

      const list = CATALOG.filter(p => 
        (filterCat==='all' || p.cat===filterCat) &&
        (text==='' || p.name.includes(text))
      );

      for(const p of list){
        const card = document.createElement('div'); card.className='card';

        const own = owned[p.id]||0;
        const ownTag = document.createElement('span'); ownTag.className='own'; ownTag.textContent = `æ‰€æŒ ${own}`;
        card.appendChild(ownTag);

        // è£…å‚™ã‚¿ã‚°
        if(p.type==='gear'){
          const tag = document.createElement('span'); tag.className='tag'; tag.textContent = `${SLOTS[p.slot] || 'è£…å‚™'}`;
          card.appendChild(tag);
        }

        const iconWrap = document.createElement('div'); iconWrap.className='iconWrap';
        const img = new Image(); img.className='icon';
        let usedFallback = false;
        img.onerror = ()=>{
          if(usedFallback) return;
          usedFallback = true;
          const emoji =
            p.cat==='acc' ? 'ğŸ€' :
            p.cat==='tkt' ? 'ğŸ«' :
            p.cat==='eff' ? 'âœ¨' :
            p.cat==='spc' ? 'ğŸŒˆ' :
            'ğŸ‘Ÿ';
          iconWrap.innerHTML='';
          iconWrap.appendChild(genEmojiSVG(emoji, 'cat-'+(p.cat==='gear'?'gear':p.cat)));
        };
        img.src = `public/items/ex_${p.id}.png`;
        iconWrap.appendChild(img);

        const nm = document.createElement('div'); nm.className='nm'; nm.textContent = p.name;
        const desc = document.createElement('div'); desc.className='desc'; desc.textContent = p.desc;

        // è³¼å…¥ã‚³ã‚¹ãƒˆ
        const cost = document.createElement('div'); cost.className='cost';
        p.cost.forEach(c => cost.appendChild(costBadge(c)));

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        const act = document.createElement('div'); act.className='act';
        const buyBtn = document.createElement('button'); buyBtn.className='buy'; buyBtn.textContent='äº¤æ›';
        buyBtn.disabled = !canAfford(p.cost);
        buyBtn.addEventListener('click', () => onBuy(p, buyBtn));
        act.appendChild(buyBtn);

        // è£…å‚™ãƒœã‚¿ãƒ³ï¼ˆgearã®ã¿ï¼‰
        if(p.type==='gear'){
          const equipBtn = document.createElement('button'); equipBtn.className='equipBtn';
          const isEquipped = equip[p.slot] === p.id;
          equipBtn.textContent = isEquipped ? 'è£…å‚™ä¸­' : 'è£…å‚™ã™ã‚‹';
          if(!owned[p.id]) equipBtn.disabled = true;

          equipBtn.addEventListener('click', () => onEquip(p));
          act.appendChild(equipBtn);

          // è£…å‚™/è„±ç€ã‚³ã‚¹ãƒˆè¡¨ç¤º
          const equipRow = document.createElement('div'); equipRow.className='cost';
          const cap1 = document.createElement('span'); cap1.className='tiny'; cap1.textContent='è£…ç€:';
          equipRow.appendChild(cap1);
          (p.equipCost||[]).forEach(c=> equipRow.appendChild(costBadge(c)));
          const equipRow2 = document.createElement('div'); equipRow2.className='cost';
          const cap2 = document.createElement('span'); cap2.className='tiny'; cap2.textContent='å¤–ã™:';
          equipRow2.appendChild(cap2);
          (p.unequipCost||[]).forEach(c=> equipRow2.appendChild(costBadge(c)));

          card.append(iconWrap,nm,desc,cost,equipRow,equipRow2,act);
        }else{
          card.append(iconWrap,nm,desc,cost,act);
        }

        grid.appendChild(card);
      }
    }

    /* ===== Actions ===== */
    function onBuy(p, btn){
      if(!canAfford(p.cost)) { btn.disabled=true; return; }
      if(!confirm(`ã€Œ${p.name}ã€ã‚’äº¤æ›ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      spend(p.cost);
      owned[p.id] = (owned[p.id]||0) + 1; saveOwned();
      btn.textContent = 'äº¤æ›ã—ã¾ã—ãŸï¼'; setTimeout(()=>{ btn.textContent='äº¤æ›'; },900);
      render();
    }

    function onEquip(p){
      if(!(owned[p.id]>0)) { alert('ã¾ãšã¯äº¤æ›ã—ã¦ãã ã•ã„ã€‚'); return; }
      const curId = equip[p.slot];
      let extra = [];
      if(curId){
        const cur = CATALOG.find(x=>x.id===curId);
        extra = mergeCosts(extra, cur.unequipCost||[]);
      }
      const total = mergeCosts(p.equipCost||[], extra);

      if(!canAfford(total)){
        alert('è£…ç€ã«å¿…è¦ãªè²ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚');
        return;
      }

      const confirmText = [
        `è£…å‚™ã‚¹ãƒ­ãƒƒãƒˆ: ${SLOTS[p.slot]}`,
        curId ? `ç¾åœ¨è£…å‚™: ${CATALOG.find(x=>x.id===curId)?.name || curId}ï¼ˆå¤–ã™ã‚³ã‚¹ãƒˆã‚ã‚Šï¼‰` : 'ç¾åœ¨è£…å‚™: ãªã—',
        'æ¶ˆè²»äºˆå®š:',
      ].join('\n');
      if(!confirm(confirmText)) return;

      spend(total);
      equip[p.slot] = p.id; saveEquip();
      render();
    }

    function onUnequip(slot){
      const curId = equip[slot];
      if(!curId) return;
      const cur = CATALOG.find(x=>x.id===curId);
      const cost = cur.unequipCost||[];
      if(!canAfford(cost)){ alert('å¤–ã™ãŸã‚ã®è²ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚'); return; }
      if(!confirm(`ã€Œ${cur.name}ã€ã‚’å¤–ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      spend(cost);
      equip[slot] = null; saveEquip();
      render();
    }

    /* ===== Wire ===== */
    function init(){
      loadInventory(); loadOwned(); loadEquip(); render();

      // Filters
      qsa('.chip').forEach(ch => ch.addEventListener('click', () => {
        qsa('.chip').forEach(b => b.setAttribute('aria-pressed','false'));
        ch.setAttribute('aria-pressed','true');
        filterCat = ch.dataset.cat || 'all';
        render();
      }));
      qs('#q').addEventListener('input', e => { qText = e.target.value; render(); });

      // Buttons
      qs('#btnBack').addEventListener('click', ()=> location.href='collection.html');
      qs('#btnToStory').addEventListener('click', ()=> location.href='story.html');
      qs('#btnHow').addEventListener('click', ()=> qs('#how').showModal());
      qs('#btnResetOwn').addEventListener('click', ()=>{
        if(!confirm('è³¼å…¥å±¥æ­´ï¼ˆäº¤æ›æ¸ˆã¿å€‹æ•°ï¼‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
        owned = {}; saveOwned(); render();
      });
      qs('#btnResetEquip').addEventListener('click', ()=>{
        if(!confirm('è£…å‚™ã‚’ã™ã¹ã¦å¤–ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
        for(const k of Object.keys(SLOTS)) equip[k]=null; saveEquip(); render();
      });
    }

    document.addEventListener('DOMContentLoaded', init);
  })();
  </script>
</body>
</html>
