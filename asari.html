<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>WHO VQ — アクセサリーショップ</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  html,body{height:100%;background:#000;color:#fff;font-family:system-ui,"Noto Sans JP","Hiragino Kaku Gothic ProN","Meiryo",sans-serif;overflow:hidden}
  .page{display:grid;grid-template-rows:auto 1fr;grid-template-columns:1fr;grid-template-areas:"top""main";height:100vh}
  .top{grid-area:top;display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:linear-gradient(180deg,rgba(0,0,0,.6),rgba(0,0,0,0))}
  .btn{border:none;border-radius:10px;padding:8px 12px;background:#ffd76a;color:#432;font-weight:700;cursor:pointer;box-shadow:0 2px 0 rgba(0,0,0,.25)}
  .btn:active{transform:translateY(1px)}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.45);backdrop-filter:blur(6px);font-size:14px}
  .main{grid-area:main;display:grid;grid-template-columns: 1fr 320px;gap:10px;height:100%}
  .store{position:relative;overflow:auto;padding:10px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px}
  .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:8px}
  .thumb{height:120px;border-radius:8px;background:rgba(255,255,255,.05);display:grid;place-items:center;overflow:hidden}
  .thumb img{width:100%;height:100%;object-fit:contain}
  .name{font-weight:700}
  .price{opacity:.9}
  .buy{border:none;border-radius:8px;padding:8px 10px;background:#68e0a3;color:#103;font-weight:800;cursor:pointer}
  .buy[disabled]{background:#778095;color:#203;cursor:not-allowed}
  .side{border-left:1px solid rgba(255,255,255,.08);position:relative;overflow:hidden}
  .bg{position:absolute;inset:0;background-size:cover;background-position:center;background-repeat:no-repeat;z-index:0}
  .bg.sky{background-image:url("public/assets/stage1/sky_morning.png")}
  .bg.sea{background-image:url("public/assets/stage1/sea.png");opacity:.95}
  .bg.sand{background-image:url("public/assets/stage1/sand.png")}
  #charWrap{position:absolute;left:50%;bottom:10vh;transform:translateX(-50%);z-index:2;pointer-events:none}
  #char{display:block;width:min(42vw,460px);height:auto;filter:drop-shadow(0 4px 8px rgba(0,0,0,.55))}
  @keyframes idleFloat{0%{transform:translate(-50%,0)}50%{transform:translate(-50%,-6px)}100%{transform:translate(-50%,0)}}
  #charWrap.idle{animation:idleFloat 3.6s ease-in-out infinite}
  #accLayer{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:3}
  .acc{position:absolute;filter:drop-shadow(0 2px 2px rgba(0,0,0,.4))}
  .toast{position:absolute;left:50%;top:9.5vh;transform:translateX(-50%);z-index:6;background:rgba(0,0,0,.7);padding:10px 14px;border-radius:10px;opacity:0;transition:opacity .25s}
  .toast.show{opacity:1}
  @media (max-width: 920px){
    .main{grid-template-columns:1fr}
    #char{width:64vw}
    .side{height:46vh}
  }
</style>
</head>
<body>
<div class="page">
  <div class="top">
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn" id="btnBack">← コレクションへ</button>
      <div class="pill">所持アクセ：<b id="ownedCount">0</b></div>
      <div class="pill">装着中：<b id="equipCount">0</b></div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <div class="pill">アクセP：<b id="accPoint">0</b></div>
    </div>
  </div>

  <div class="main">
    <section class="store">
      <div class="grid" id="grid"></div>
    </section>

    <aside class="side">
      <div class="bg sky"></div>
      <div class="bg sea"></div>
      <div class="bg sand"></div>
      <div id="charWrap" class="idle">
        <img id="char" alt="character" src="public/assets/stage1/pink_open.png">
        <div id="accLayer"></div>
      </div>
      <div class="toast" id="toast">Purchased</div>
    </aside>
  </div>
</div>

<script>
(() => {
  // ====== 共通設定（asari/collection と統一）======
  const CHAR_BASE = "public/assets/stage1/";
  const ACC_BASE  = "public/accessories/";
  const HEAD_ANCHORS = {
    pink:   { x:0.50, y:0.18, baseScale:0.18 },
    blue:   { x:0.50, y:0.18, baseScale:0.18 },
    green:  { x:0.50, y:0.18, baseScale:0.18 },
    purple: { x:0.50, y:0.18, baseScale:0.18 },
    friend: { x:0.50, y:0.18, baseScale:0.18 },
  };
  const ACCESSORY_FINE_TUNE = {
    // 例: "ribbon_red": { dx:0, dy:-4, scaleMul:0.92 },
  };

  // デモ用商品リスト（id・表示名・価格）
  const CATALOG = [
    { id:"ribbon_red", name:"レッドリボン", price:5 },
    { id:"star_small", name:"ちいさな星",   price:4 },
    { id:"shell_pearl", name:"真珠シェル",  price:6 },
    { id:"clover", name:"クローバー",       price:4 },
    { id:"crown_tiny", name:"ちいさな王冠", price:8 },
  ];

  function migrateLegacyCharacter(){
    try{
      const old = localStorage.getItem("who_char_color");
      if (!old) return;
      const val = old.replace(/"/g,"").trim();
      localStorage.setItem("who_character", JSON.stringify({type:"tane", color:val}));
    }catch(e){}
  }
  function readCharacter(){
    migrateLegacyCharacter();
    const raw = localStorage.getItem("who_character");
    if (!raw) return {type:"tane", color:"pink"};
    try{
      const o = JSON.parse(raw);
      if (!o || o.type!=="tane") return {type:"tane", color:"pink"};
      return {type:"tane", color:(o.color||"pink")};
    }catch(e){ return {type:"tane", color:"pink"} }
  }
  function ensureImage(src){
    return new Promise((res,rej)=>{ const im=new Image(); im.onload=()=>res(src); im.onerror=()=>rej(new Error("load:"+src)); im.src=src; });
  }
  async function loadSpriteWithFallback(color){
    for (const name of [`${color}_open.png`, `${color}_closed.png`, `${color}.png`]){
      const url = CHAR_BASE + name;
      try{ await ensureImage(url); return url; }catch(e){}
    }
    return null;
  }
  function readOwned(){
    const raw = localStorage.getItem("who_accessory_owned");
    if (!raw) return [];
    try{
      const v = JSON.parse(raw);
      if (Array.isArray(v)) return v;
      if (v && typeof v==="object") return Object.keys(v).filter(k=>v[k]);
    }catch(e){}
    return [];
  }
  function writeOwned(list){
    localStorage.setItem("who_accessory_owned", JSON.stringify([...new Set(list)]));
  }
  function readEquip(){
    const raw = localStorage.getItem("who_accessory_equip");
    if (!raw) return [];
    try{
      const v = JSON.parse(raw);
      if (Array.isArray(v)) return v;
      if (v && typeof v==="object") return Object.values(v).filter(Boolean);
    }catch(e){}
    return [];
  }
  function readIntLS(key, def=0){
    const v = parseInt(localStorage.getItem(key)||`${def}`,10);
    return isNaN(v)?def:v;
  }
  function writeIntLS(key, val){ localStorage.setItem(key, String(val)); }

  // ====== UI refs ======
  const gridEl = document.getElementById("grid");
  const ownedCountEl = document.getElementById("ownedCount");
  const equipCountEl = document.getElementById("equipCount");
  const accPntEl = document.getElementById("accPoint");
  const toastEl = document.getElementById("toast");

  const charWrap = document.getElementById("charWrap");
  const charImg  = document.getElementById("char");
  const accLayer = document.getElementById("accLayer");

  // ====== State ======
  let owned = readOwned();
  let equips = readEquip();
  let points = readIntLS("who_accessory_points", 0);
  let currentColor = "pink";

  // ====== Init ======
  async function init(){
    localStorage.setItem("who_lastPage", "accessory.html");
    accPntEl.textContent = points;
    ownedCountEl.textContent = owned.length;
    equipCountEl.textContent = equips.length;

    // キャラ
    const { color } = readCharacter();
    currentColor = color in HEAD_ANCHORS ? color : "pink";
    const url = await loadSpriteWithFallback(currentColor);
    if (url){ charImg.src = url; }
    charWrap.classList.add("idle");
    await drawAccessoriesPreview();

    // 商品表示
    renderCatalog();

    // 戻る
    document.getElementById("btnBack").addEventListener("click", ()=>{
      location.href = "collection.html";
    });

    // リサイズ
    window.addEventListener("resize", drawAccessoriesPreview);
  }

  function renderCatalog(){
    gridEl.innerHTML = "";
    CATALOG.forEach(item=>{
      const card = document.createElement("div");
      card.className = "card";

      const th = document.createElement("div");
      th.className = "thumb";
      const im = document.createElement("img");
      const src = `${ACC_BASE}${item.id}.png`;
      im.alt = item.id;
      im.src = src;
      im.onerror = ()=>{ th.textContent = "Missing"; im.remove(); };
      th.appendChild(im);

      const nm = document.createElement("div");
      nm.className = "name"; nm.textContent = item.name;

      const pr = document.createElement("div");
      pr.className = "price"; pr.textContent = `${item.price} P`;

      const btn = document.createElement("button");
      btn.className = "buy";
      const already = owned.includes(item.id);
      btn.textContent = already ? "購入済み" : "購入";
      btn.disabled = already || (points < item.price);
      btn.addEventListener("click", ()=>{
        if (btn.disabled) return;
        if (points < item.price) return;
        points -= item.price;
        accPntEl.textContent = points;
        writeIntLS("who_accessory_points", points);
        owned.push(item.id);
        writeOwned(owned);
        ownedCountEl.textContent = owned.length;
        btn.textContent = "購入済み";
        btn.disabled = true;
        showToast(`「${item.name}」を購入しました`);
      });

      card.appendChild(th);
      card.appendChild(nm);
      card.appendChild(pr);
      card.appendChild(btn);
      gridEl.appendChild(card);
    });
  }

  function showToast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(()=>toastEl.classList.remove("show"), 1100);
  }

  async function drawAccessoriesPreview(){
    accLayer.innerHTML = "";
    if (!equips.length) return;

    const rect = charImg.getBoundingClientRect();
    const anchor = HEAD_ANCHORS[currentColor] || HEAD_ANCHORS.pink;
    const baseAccPx = rect.width * anchor.baseScale;
    const ax = rect.left + rect.width  * anchor.x;
    const ay = rect.top  + rect.height * anchor.y;

    for (const id of equips){
      const src = `${ACC_BASE}${id}.png`;
      try{ await ensureImage(src); }catch(e){ continue; }
      const fine = ACCESSORY_FINE_TUNE[id] || {dx:0, dy:0, scaleMul:1.0};
      const imgEl = document.createElement("img");
      imgEl.className = "acc";
      imgEl.alt = id; imgEl.src = src;

      const dim = await loadImage(src);
      const aspect = (dim.w||256)/(dim.h||256);
      const w = baseAccPx * (fine.scaleMul||1.0);
      const h = w / aspect;
      const left = (ax + (fine.dx||0)) - w/2;
      const top  = (ay + (fine.dy||0)) - h/2;

      imgEl.style.width = `${w}px`;
      imgEl.style.height = `${h}px`;
      imgEl.style.left = `${left}px`;
      imgEl.style.top  = `${top}px`;
      accLayer.appendChild(imgEl);
    }
  }
  function loadImage(src){
    return new Promise((res,rej)=>{
      const im = new Image();
      im.onload = ()=>res({w:im.naturalWidth,h:im.naturalHeight});
      im.onerror = rej;
      im.src = src;
    });
  }

  // 起動
  init();
})();
</script>
</body>
</html>
