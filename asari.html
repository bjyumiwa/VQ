<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>WHO VQ â€” æ½®å¹²ç‹©ã‚Šï¼ˆasariï¼‰</title>
<style>
  :root{
    --friend-size: clamp(84px, 16vmin, 160px);
    --shell-size:  clamp(36px, 7.5vmin, 56px);
    --brush:       clamp(14px, 3.6vmin, 28px);
    --ui-font:     clamp(12px, 2.2vmin, 16px);
    --bg-brightness: 1;
    --ui-bg: rgba(0,0,0,.35);
    --card-bg: rgba(0,0,0,.5);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;background:#000;color:#fff;font-family:system-ui,"Noto Sans JP",sans-serif;overscroll-behavior:none}

  .game{position:relative;width:100vw;height:100svh;overflow:hidden;touch-action:none;
        padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)}

  .bg{
    position:absolute;inset:0;z-index:0;background-size:cover;background-position:center;
    background-image:url("public/items/bg/beach_day.jpg");
    filter:brightness(var(--bg-brightness));
    transition:filter .6s ease, background-image .8s ease;
  }

  #topbar{
    position:absolute;left:0;right:0;top:0;z-index:10;display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between;
    padding:10px env(safe-area-inset-right) 10px env(safe-area-inset-left);
    background:linear-gradient(180deg,rgba(0,0,0,.45),rgba(0,0,0,0)); font-size:var(--ui-font);
  }
  .pill{background:var(--ui-bg);border:1px solid rgba(255,255,255,.15);padding:.45em .7em;border-radius:999px;backdrop-filter:blur(6px);display:inline-flex;gap:.5em;align-items:center}
  .btn{background:var(--card-bg);border:1px solid rgba(255,255,255,.15);padding:.55em .8em;border-radius:10px;color:#fff;cursor:pointer;user-select:none;font:inherit}
  .btn:hover{background:rgba(255,255,255,.08)}
  #counter b{font-variant-numeric:tabular-nums}

  #shellLayer{position:absolute;inset:0;z-index:2;pointer-events:none}
  .shell{
    position:absolute;left:0;top:0;transform:translate(-50%,-50%);
    width:var(--shell-size);height:auto;image-rendering:auto;
    filter:drop-shadow(0 2px 4px rgba(0,0,0,.35));
    transition:transform .25s ease, opacity .25s ease; pointer-events:none;
  }
  .shell.hidden{opacity:0;transform:translate(-50%,-50%) scale(.6) translateY(-6px)}

  /* â† èƒŒæ™¯ã¯çµ¶å¯¾ã«å…¥ã‚Œãªã„ï¼ˆé€æ˜ã‚’ä¸‹ã«é€šã™ãŸã‚ï¼‰ */
  #sand{position:absolute;inset:0;z-index:3;cursor:crosshair;pointer-events:auto;touch-action:none;}

  #friendWrap{
    position:absolute;z-index:4;width:var(--friend-size);aspect-ratio:1/1;transform-origin:50% 80%;
    filter:drop-shadow(0 8px 12px rgba(0,0,0,.4))
  }
  #friendWrap.spin{animation:spin .6s ease}
  @keyframes spin{from{transform:rotate(0)}50%{transform:rotate(20deg)}to{transform:rotate(0)}}
  #friend{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:100%;height:100%;object-fit:contain}
  .equip{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:100%;height:100%;object-fit:contain;pointer-events:none}

  #bubble{
    position:absolute;z-index:9;padding:.45em .7em;background:rgba(0,0,0,.7);border:1px solid rgba(255,255,255,.2);border-radius:12px;
    transform:translate(-50%,-120%);white-space:nowrap;opacity:0;transition:opacity .2s, transform .2s; font-size:var(--ui-font);
  }
  #bubble.show{opacity:1;transform:translate(-50%,-140%)}

  #previewCurtain{position:absolute;inset:0;z-index:5;background:rgba(0,0,0,.25);backdrop-filter:blur(1px);display:none}
  #previewCurtain.show{display:block}

  #complete{position:absolute;inset:0;z-index:8;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);backdrop-filter:blur(4px)}
  #complete.show{display:flex}
  .complete-card{width:min(92vw,520px);background:rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.2);border-radius:16px;padding:16px;box-shadow:0 12px 30px rgba(0,0,0,.4);font-size:var(--ui-font)}
  .complete-card h2{margin-bottom:.4em}
  .complete-actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:.6em}

  #backBtn{display:none}
  body.preview #backBtn{display:inline-flex}

  @media (max-width: 420px){ #topbar{gap:6px} .btn{padding:.5em .7em} }
</style>
</head>
<body>
<div class="game" id="game">
  <div class="bg" id="bg"></div>

  <div id="topbar">
    <div class="pill" id="counter">è²ï¼š<b id="got">0</b>/<b id="total">0</b></div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn" id="snapBtn" title="å†™çœŸã‚’æ’®ã£ã¦è¨˜éŒ²">ğŸ“¸ è¨˜éŒ²</button>
      <button class="btn" id="backBtn" onclick="location.href='exchange.html'">äº¤æ›æ‰€ã¸æˆ»ã‚‹</button>
      <button class="btn" id="previewBtn" title="è£…å‚™ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆç ‚ã‚’éš ã™/æ“ä½œä¸å¯ï¼‰">è¦‹ãŸç›®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
    </div>
  </div>

  <div id="shellLayer" aria-hidden="true"></div>
  <canvas id="sand"></canvas>

  <div id="friendWrap" aria-label="friend">
    <img id="friend" alt="friend" />
    <img class="equip equip--style" data-slot="style" alt="" />
    <img class="equip equip--head"  data-slot="head"  alt="" />
    <img class="equip equip--body"  data-slot="body"  alt="" />
    <img class="equip equip--back"  data-slot="back"  alt="" />
    <img class="equip equip--hands" data-slot="hands" alt="" />
    <img class="equip equip--shoes" data-slot="shoes" alt="" />
  </div>

  <div id="bubble"></div>
  <div id="previewCurtain"></div>

  <div id="complete">
    <div class="complete-card">
      <h2>å…¨éƒ¨è¦‹ã¤ã‘ãŸï¼</h2>
      <p>æ¬¡ã®è¡Œãå…ˆã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>
      <div class="complete-actions">
        <button class="btn" id="toExchange">äº¤æ›æ‰€ã¸</button>
        <button class="btn" id="toCollection">å›³é‘‘ã¸</button>
        <button class="btn" id="toSnap">å†™çœŸã‚’ä¿å­˜</button>
        <button class="btn" id="toPreview">è¦‹ãŸç›®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
      </div>
    </div>
  </div>
</div>

<script>
/* === èª¿æ•´ç”¨ === */
const REVEAL_ALPHA_THRESHOLD = 64; // Î±<=ã§ã€Œé€æ˜å¯„ã‚Šã€
const REVEAL_RATIO = 0.28;         // é ˜åŸŸã®28%ä»¥ä¸ŠãŒé€æ˜å¯„ã‚Šã§éœ²å‡ºOK

/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const clampV = (v,min,max)=>Math.max(min,Math.min(max,v));
const now = ()=>performance.now();
const DPR = Math.max(1, window.devicePixelRatio || 1);
const csspx = name => parseFloat(getComputedStyle(document.documentElement).getPropertyValue(name)) || 0;

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–é€£å‹•ã‚µã‚¤ã‚º */
let FRIEND_SIZE=0, SHELL_SIZE=0, BRUSH=0;
function syncSizesFromCSS(){ FRIEND_SIZE=csspx('--friend-size'); SHELL_SIZE=csspx('--shell-size'); BRUSH=csspx('--brush'); }

/* ç”»åƒãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ */
function loadIconWithFallback(id, preferEx=true){
  const paths=[]; if(preferEx) paths.push(`public/items/ex_${id}.png`);
  paths.push(`public/items/${id}.png`,`./public/items/${id}.png`,`/public/items/${id}.png`);
  return new Promise(res=>{
    const img=new Image(); img.crossOrigin='anonymous'; let i=0;
    const next=()=>{ if(i>=paths.length){ res(null); return; } img.src=paths[i++]; img.onload=()=>res(img); img.onerror=next; };
    next();
  });
}
function emojiDataURI(emoji="ğŸš", size=128){
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}'><text x='50%' y='50%' font-size='${size*0.8}' dominant-baseline='central' text-anchor='middle'>${emoji}</text></svg>`;
  return `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svg)}`;
}

/* ===== ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ===== */
function readJSON(k,f){ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):f; }catch(e){ return f; } }
function writeJSON(k,o){ try{ localStorage.setItem(k, JSON.stringify(o)); }catch(e){} }
function ensureShells(){
  let s = readJSON('who_shells', null);
  if(!s || s.schema!=='who_shells/v1'){ s = { schema:'who_shells/v1', updatedAt:new Date().toISOString(), items:{} }; writeJSON('who_shells', s); }
  return s;
}

/* ===== èƒŒæ™¯ï¼šæ™‚é–“å¸¯ ===== */
function pickBgByTime(){ const h=new Date().getHours(); if(h>=5 && h<=8) return "public/items/bg/sunrise.jpg"; if(h>=9 && h<=17) return "public/items/bg/beach_day.jpg"; return "public/items/bg/night_beach.jpg"; }
function applyTimeBackground(){ $('#bg').style.backgroundImage = `url("${pickBgByTime()}")`; }

/* ===== åˆæœŸè¨­å®š ===== */
const search=new URLSearchParams(location.search);
const isPreview=search.get('preview')==='1';
if(isPreview) document.body.classList.add('preview');

const FRIEND_OFFSET = { x: 40, y: 10 };
const FLOAT_AMPL = 6;
const FLOAT_SPEED = 0.0016;

/* ===== ç”»é¢ãƒ»ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆDPRå¯¾å¿œï¼‰ ===== */
const game=$('#game'), sand=$('#sand'), shellLayer=$('#shellLayer');
let cw=0,ch=0, ctx=null;

function resize(){
  syncSizesFromCSS();
  cw = game.clientWidth; ch = game.clientHeight;
  sand.style.width = cw+'px'; sand.style.height = ch+'px';
  sand.width = Math.floor(cw * DPR); sand.height = Math.floor(ch * DPR);
  ctx = sand.getContext('2d', { willReadFrequently:true });
  ctx.setTransform(DPR,0,0,DPR,0,0); // CSSåº§æ¨™ã§æç”»
  drawSand();
}
window.addEventListener('resize', resize);

/* ç ‚æç”» */
function drawSand(){
  if(!ctx) return;
  ctx.clearRect(0,0,cw,ch);
  ctx.globalCompositeOperation='source-over';
  ctx.fillStyle='#D9C7A1'; ctx.fillRect(0,0,cw,ch);
  const density=Math.floor((cw*ch)/9000);
  ctx.globalAlpha=0.15; ctx.fillStyle='#bca67e';
  for(let i=0;i<density;i++){
    const x=Math.random()*cw, y=Math.random()*ch, r=Math.random()*1.8;
    ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
  }
  ctx.globalAlpha=1;
}

/* ===== ã‚­ãƒ£ãƒ©ï¼†è£…å‚™ ===== */
const friendWrap=$('#friendWrap'), friendImg=$('#friend');
const equipImgs={ head:$('.equip--head'), body:$('.equip--body'), back:$('.equip--back'), hands:$('.equip--hands'), shoes:$('.equip--shoes'), style:$('.equip--style') };
const ANCHOR={ head:{x:0,y:-42,scale:1}, body:{x:0,y:-2,scale:1}, back:{x:-6,y:-6,scale:1}, hands:{x:10,y:0,scale:1}, shoes:{x:6,y:44,scale:1}, style:{x:0,y:0,scale:1} };
function resolveFriendSrc(){ const color=(localStorage.getItem('who_character')||'pink').replace(/[^a-z]/g,'')||'pink'; return `public/assets/stage1/${color}_open.png`; }
function setEquipLayer(slot,pid){
  const el=equipImgs[slot]; if(!el) return;
  if(!pid){ el.style.display='none'; el.removeAttribute('src'); return; }
  const src=`public/stage1/equip/${slot}/${pid}.png`;
  const img=new Image(); img.crossOrigin='anonymous';
  img.onload=()=>{ el.src=src; el.style.display='block'; const a=ANCHOR[slot]||{x:0,y:0,scale:1}; el.style.transform=`translate(calc(-50% + ${a.x}px), calc(-50% + ${a.y}px)) scale(${a.scale})`; };
  img.onerror=()=>{ el.style.display='none'; el.removeAttribute('src'); };
  img.src=src;
}
function applyEquipment(){ const eq=readJSON('who_equipment',{head:null,body:null,back:null,hands:null,shoes:null,style:null}); Object.entries(eq).forEach(([slot,pid])=>setEquipLayer(slot,pid)); }

/* ===== è¿½å¾“ï¼ˆãµã‚ãµã‚ï¼‰ ===== */
let mx=0,my=0,fx=0,fy=0,t0=now();
function initPointer(){ const r=game.getBoundingClientRect(); mx=r.left+r.width*0.5+FRIEND_OFFSET.x; my=r.top+r.height*0.6+FRIEND_OFFSET.y; fx=mx; fy=my; }
function onPointer(e){ const p=e.touches?e.touches[0]:e; lastClientX=p.clientX; lastClientY=p.clientY; mx=p.clientX+FRIEND_OFFSET.x; my=p.clientY+FRIEND_OFFSET.y; }
['pointermove','touchmove'].forEach(ev=>game.addEventListener(ev,onPointer,{passive:true}));
function loop(){ const dt=now()-t0; t0=now(); const f=Math.min(1,dt/1000*6), bob=Math.sin(performance.now()*FLOAT_SPEED)*FLOAT_AMPL; fx+=(mx-fx)*f*0.2; fy+=(my-fy)*f*0.2; friendWrap.style.left=`${clampV(fx,40,cw-40)}px`; friendWrap.style.top=`${clampV(fy+bob,40,ch-40)}px`; requestAnimationFrame(loop); }

/* ===== ã‚·ã‚§ãƒ«é…ç½®ãƒ»å–å¾— ===== */
const SHELL_POOL=[{id:'asari1',label:'ã‚¢ã‚µãƒª(å°)'},{id:'asari2',label:'ã‚¢ã‚µãƒª(ä¸­)'},{id:'asari3',label:'ã‚¢ã‚µãƒª(å¤§)'}];
let totalShells=0, gotShells=0, shells=[];
function placeShells(nEach=4){
  shellLayer.innerHTML=''; shells=[];
  const margin=Math.max(40,SHELL_SIZE);
  SHELL_POOL.forEach(s=>{
    for(let i=0;i<nEach;i++){
      const x=margin+Math.random()*(cw-margin*2);
      const y=margin+Math.random()*(ch-margin*2);
      const el=document.createElement('img');
      el.className='shell'; el.alt=s.label; el.style.left=`${x}px`; el.style.top=`${y}px`;
      loadIconWithFallback(s.id).then(img=>{ el.src=img?img.src:emojiDataURI('ğŸš'); });
      shellLayer.appendChild(el);
      shells.push({id:s.id,label:s.label,x,y,el,collected:false});
    }
  });
  totalShells=shells.length; $('#total').textContent=totalShells;
}

/* éœ²å‡ºåˆ¤å®šï¼šé ˜åŸŸå¹³å‡Î± */
function isRevealedAt(x,y){
  const cx=Math.round(x*DPR), cy=Math.round(y*DPR);
  const rpx=Math.max(6, Math.round(Math.max(SHELL_SIZE*0.36, BRUSH*0.8)*DPR));
  const x0=clampV(cx-rpx,0,sand.width-1), y0=clampV(cy-rpx,0,sand.height-1);
  const w=Math.min(rpx*2+1, sand.width-x0), h=Math.min(rpx*2+1, sand.height-y0);
  if(w<=0||h<=0) return false;
  try{
    const data=ctx.getImageData(x0,y0,w,h).data; let trans=0, tot=0;
    for(let i=3;i<data.length;i+=4){ tot++; if(data[i]<=REVEAL_ALPHA_THRESHOLD) trans++; }
    return tot>0 && (trans/tot)>=REVEAL_RATIO;
  }catch(e){ return false; }
}

/* å–å¾—åˆ¤å®š */
function tryCollectAtCanvasXY(cx,cy){
  if(isPreview) return false;
  const R=SHELL_SIZE*0.5;
  for(const it of shells){
    if(it.collected) continue;
    const dx=cx-it.x, dy=cy-it.y;
    if((dx*dx+dy*dy)<=R*R){ if(isRevealedAt(it.x,it.y)){ collectShell(it); return true; } }
  }
  return false;
}

/* UI */
function showBubble(text){ const b=$('#bubble'), r=friendWrap.getBoundingClientRect(); b.style.left=`${r.left+r.width*0.5}px`; b.style.top=`${r.top}px`; b.textContent=text; b.classList.add('show'); setTimeout(()=>b.classList.remove('show'),700); }
function brightenBackground(){ const cur=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--bg-brightness'))||1; document.documentElement.style.setProperty('--bg-brightness', String(Math.min(1.25, cur+0.08))); }
function revealTimeScene(){ $('#bg').style.backgroundImage=`url("${pickBgByTime()}")`; brightenBackground(); setTimeout(()=>$('#complete').classList.add('show'),500); }
function collectShell(it){
  if(it.collected) return;
  it.collected=true; it.el.classList.add('hidden');
  gotShells++; $('#got').textContent=gotShells;
  const st=ensureShells(); st.items[it.id]=(st.items[it.id]||0)+1; st.updatedAt=new Date().toISOString(); writeJSON('who_shells',st);
  friendWrap.classList.remove('spin'); void friendWrap.offsetWidth; friendWrap.classList.add('spin');
  showBubble(`GET! ${it.label}`);
  if(gotShells>=totalShells) revealTimeScene();
}

/* ===== æ¶ˆã—ã‚´ãƒ ï¼šç·šã‚¹ãƒˆãƒ­ãƒ¼ã‚¯æ–¹å¼ ===== */
let erasing=false, lastClientX=0,lastClientY=0, lastPt=null;

function eventToCanvasXY(e){
  if(typeof e.offsetX==='number' && typeof e.offsetY==='number'){ return {x:e.offsetX, y:e.offsetY}; }
  const r=sand.getBoundingClientRect();
  const cx=('clientX' in e)?e.clientX:(e.touches&&e.touches[0]?e.touches[0].clientX:lastClientX);
  const cy=('clientY' in e)?e.clientY:(e.touches&&e.touches[0]?e.touches[0].clientY:lastClientY);
  return { x: cx - r.left, y: cy - r.top };
}

function eraseDot(pt){
  ctx.save();
  ctx.globalCompositeOperation='destination-out';
  ctx.beginPath(); ctx.arc(pt.x, pt.y, BRUSH, 0, Math.PI*2); ctx.fillStyle='rgba(0,0,0,1)'; ctx.fill();
  ctx.restore();
}
function eraseLine(from, to){
  ctx.save();
  ctx.globalCompositeOperation='destination-out';
  ctx.lineCap='round'; ctx.lineJoin='round';
  ctx.strokeStyle='rgba(0,0,0,1)';
  ctx.lineWidth=BRUSH*2;
  ctx.beginPath();
  ctx.moveTo(from.x, from.y);
  ctx.lineTo(to.x, to.y);
  ctx.stroke();
  ctx.restore();
}

function startErase(e){
  if(isPreview) return;
  erasing=true;
  try{ sand.setPointerCapture && e.pointerId!=null && sand.setPointerCapture(e.pointerId); }catch(_){}
  lastPt = eventToCanvasXY(e);
  eraseDot(lastPt); // åˆæœŸç‚¹ã‚’ç¢ºå®Ÿã«å‰Šã‚‹
}
function moveErase(e){
  if(!erasing || !ctx) return;
  const pt=eventToCanvasXY(e);
  if(!lastPt){ lastPt=pt; eraseDot(pt); return; }
  eraseLine(lastPt, pt);
  lastPt=pt;
}
function endErase(e){
  if(!erasing) return;
  erasing=false;
  if(e){ const pt=eventToCanvasXY(e); if(lastPt) eraseLine(lastPt, pt); lastPt=null; }
  const {x,y}=eventToCanvasXY(e||{clientX:lastClientX,clientY:lastClientY});
  tryCollectAtCanvasXY(x,y);
}

/* å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ */
sand.addEventListener('pointerdown', e=>{ lastClientX=e.clientX; lastClientY=e.clientY; startErase(e); e.preventDefault(); }, {passive:false});
sand.addEventListener('pointermove', e=>{ lastClientX=e.clientX; lastClientY=e.clientY; moveErase(e); });
sand.addEventListener('pointerup',   endErase);
sand.addEventListener('pointercancel', endErase);
sand.addEventListener('mouseleave',   endErase);

/* å¿µã®ãŸã‚ mouse/touch ã§ã‚‚ */
sand.addEventListener('mousedown', e=>{ startErase(e); }, {passive:false});
window.addEventListener('mousemove', e=>{ if(erasing) moveErase(e); }, {passive:false});
window.addEventListener('mouseup',   e=>{ if(erasing) endErase(e); }, {passive:false});
sand.addEventListener('touchstart', e=>{ startErase(e); e.preventDefault(); }, {passive:false});
sand.addEventListener('touchmove',  e=>{ moveErase(e);  e.preventDefault(); }, {passive:false});
sand.addEventListener('touchend',   endErase, {passive:false});
sand.addEventListener('touchcancel',endErase, {passive:false});

/* ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚å–å¾—è©¦è¡Œï¼ˆä¿é™ºï¼‰ */
sand.addEventListener('click', e=>{ const {x,y}=eventToCanvasXY(e); tryCollectAtCanvasXY(x,y); });
sand.addEventListener('contextmenu', e=>e.preventDefault(), {passive:false});

/* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ‡æ›¿ãƒ»ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ */
$('#previewBtn').addEventListener('click', ()=>{ if(!isPreview) location.href='asari.html?preview=1'; });

function getBgSrc(){ const s=getComputedStyle($('#bg')).backgroundImage; const m=s&&s.match(/url\(["']?(.*?)["']?\)/); return m?m[1]:'public/items/bg/beach_day.jpg'; }
function drawImageFit(c, img, x,y,w,h){ c.drawImage(img,x,y,w,h); }
async function snapshotScene(){
  const W=cw,H=ch, cvs=document.createElement('canvas'); cvs.width=W; cvs.height=H; const c=cvs.getContext('2d');
  const bgImg=new Image(); bgImg.crossOrigin='anonymous'; bgImg.src=getBgSrc(); await new Promise(r=>{bgImg.onload=r; bgImg.onerror=r;}); if(bgImg.width) drawImageFit(c,bgImg,0,0,W,H);
  const gr=game.getBoundingClientRect();
  $$('#shellLayer .shell').forEach(el=>{ if(el.classList.contains('hidden')) return; const r=el.getBoundingClientRect(); const x=r.left-gr.left, y=r.top-gr.top; try{ c.drawImage(el,x,y,r.width,r.height); }catch(_){} });
  try{ c.drawImage(sand,0,0,W,H); }catch(_){}
  const fwr=friendWrap.getBoundingClientRect(); const fx=fwr.left-gr.left, fy=fwr.top-gr.top, fw=fwr.width, fh=fwr.height;
  const drawEl=el=>{ if(el && el.src) try{ c.drawImage(el,fx,fy,fw,fh);}catch(_){} };
  drawEl(friendImg); drawEl(equipImgs.style); drawEl(equipImgs.head); drawEl(equipImgs.body); drawEl(equipImgs.back); drawEl(equipImgs.hands); drawEl(equipImgs.shoes);
  const url=cvs.toDataURL('image/png'); const list=readJSON('who_snaps',[]); const eq=readJSON('who_equipment',{head:null,body:null,back:null,hands:null,shoes:null,style:null});
  list.unshift({ts:new Date().toISOString(),mode:isPreview?'preview':'play',got:gotShells,total:totalShells,equip:eq,dataUrl:url}); if(list.length>12) list.length=12; writeJSON('who_snaps',list);
  const a=document.createElement('a'); a.href=url; a.download=`who_asari_${isPreview?'preview':'play'}_${Date.now()}.png`; document.body.appendChild(a); a.click(); a.remove();
  showBubble('å†™çœŸã‚’ä¿å­˜ã—ã¾ã—ãŸ');
}
$('#snapBtn').addEventListener('click', snapshotScene);

/* å®Œäº†ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤é·ç§» */
$('#toExchange').addEventListener('click', ()=>location.href='exchange.html');
$('#toCollection').addEventListener('click', ()=>location.href='collection.html');
$('#toSnap').addEventListener('click', snapshotScene);
$('#toPreview').addEventListener('click', ()=>location.href='asari.html?preview=1');

/* ===== èµ·å‹• ===== */
(async function init(){
  applyTimeBackground();
  resize(); initPointer();
  if(isPreview){ $('#previewCurtain').classList.add('show'); sand.style.display='none'; $('#shellLayer').style.display='none'; }
  else{ placeShells(4); }
  friendImg.src=resolveFriendSrc(); friendImg.crossOrigin='anonymous'; applyEquipment();
  $('#got').textContent='0';
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
