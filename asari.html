<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>WHO VQ — 潮干狩り</title>
<style>
  html, body { height:100%; margin:0; font-family:"Hiragino Sans","Meiryo",sans-serif; }
  body {
    background: url("public/items/bg/beach_day.jpg") center/cover no-repeat fixed;
    overflow: hidden;
  }
  .game { position:relative; width:100%; height:100%; }

  /* 砂ゾーン */
  .sand { position:absolute; left:0; right:0; bottom:0; height:40%;
          background: url("public/items/sand.png") center/cover no-repeat;
          touch-action:none; pointer-events:auto; z-index:1; }

  /* 貝 */
  .clams { position:absolute; inset:0; z-index:2; pointer-events:none; }
  .clam  { position:absolute; width:64px; height:64px;
           background-size:contain; background-repeat:no-repeat;
           pointer-events:auto; transition: transform .12s ease; }
  .clam:active { transform: scale(.9); }

  /* キャラ */
  .char-wrap{ position:absolute; z-index:3; height:22vh; aspect-ratio:1/1; pointer-events:none;
              filter: drop-shadow(0 14px 12px rgba(0,0,0,.55));
              transform-origin:50% 90%;
              animation:sway 4.2s ease-in-out infinite, breathe 3s ease-in-out infinite;
              transition:left 1.2s ease, top 1.2s ease; }
  .char-wrap img{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain; }
  .acc{ position:absolute; display:none; }

  @keyframes sway { 0%,100%{transform:rotate(-2deg);} 50%{transform:rotate(2deg);} }
  @keyframes breathe{
    0%,100%{ filter: drop-shadow(0 14px 12px rgba(0,0,0,.55)) brightness(1); }
    50%    { filter: drop-shadow(0 18px 14px rgba(0,0,0,.50)) brightness(1.03); }
  }
  .picking{ animation: pick .45s ease forwards; }
  @keyframes pick{ 0%{transform:rotate(0) scale(1);} 50%{transform:rotate(-6deg) scale(.94) translateY(3px);} 100%{transform:rotate(0) scale(1);} }

  /* HUD / 操作 */
  .hud{ position:absolute; top:10px; left:10px; z-index:5; background:rgba(0,0,0,.55); color:#fff;
        padding:8px 10px; border-radius:8px; font-size:14px; user-select:none; }
  .controls{ position:absolute; top:10px; right:10px; z-index:5; display:flex; flex-direction:column; gap:8px; }
  .controls button{ padding:8px 10px; border:none; border-radius:8px; background:rgba(255,255,255,.9); font-size:13px; cursor:pointer; }

  .toast{ position:absolute; left:50%; top:14%; transform:translateX(-50%); z-index:6; background:rgba(0,0,0,.65);
          color:#fff; padding:6px 10px; border-radius:8px; font-size:13px; opacity:0; transition:opacity .25s ease; }
  .toast.show{ opacity:1; }
</style>
</head>
<body>
<div class="game" id="game">
  <div class="sand" id="sand"></div>
  <div class="clams" id="clams"></div>

  <div class="char-wrap" id="charWrap">
    <img id="charImg" alt="キャラ">
    <img id="accImg" class="acc" alt="アクセサリー">
  </div>

  <div class="hud">アサリ: <span id="cnt">0</span><br>称号: <span id="title">なし</span></div>
  <div class="controls">
    <button id="toggleChar">キャラ表示ON/OFF</button>
    <button id="exam">検定モード</button>
    <button id="release">海に返す</button>
  </div>
  <div class="toast" id="toast"></div>
</div>

<script>
  /* LocalStorage Keys */
  const LS = { character:"who_character", clam:"who_clam", title:"who_title", unlocks:"who_unlocks", equipped:"who_equippedAccessory" };

  /* Elements */
  const sand = document.getElementById('sand');
  const clamsLayer = document.getElementById('clams');
  const charWrap = document.getElementById('charWrap');
  const charImg = document.getElementById('charImg');
  const accImg  = document.getElementById('accImg');
  const hudCnt = document.getElementById('cnt');
  const hudTitle = document.getElementById('title');
  const toast = document.getElementById('toast');

  /* キャラ */
  const charKey = localStorage.getItem(LS.character) || 'pink';
  charImg.src = `public/assets/stage1/${charKey}_open.png`;
  function setCharPos(px, py){ charWrap.style.left = px + 'px'; charWrap.style.top = py + 'px'; }
  window.addEventListener('load', ()=>{
    setCharPos(innerWidth*0.5 - (charWrap.clientWidth||160)/2, innerHeight*0.62);
  });

  /* 状態 */
  let count   = parseInt(localStorage.getItem(LS.clam) || '0', 10);
  let title   = localStorage.getItem(LS.title) || 'なし';
  let unlocks = JSON.parse(localStorage.getItem(LS.unlocks) || '{}');
  hudCnt.textContent = count; hudTitle.textContent = title;

  /* アクセ位置 */
  const ACCESSORY_ANCHORS = {
    pink:{ top:4, left:50, width:38 }, blue:{ top:4, left:50, width:38 },
    green:{ top:5, left:50, width:38 }, purple:{ top:6, left:50, width:38 }
  };
  function renderAccessory(){
    if(!unlocks.accessory){ accImg.style.display='none'; return; }
    const id = localStorage.getItem(LS.equipped);
    if(!id){ accImg.style.display='none'; return; }
    accImg.src = `public/assets/accessories/${id}.png`;
    const a = ACCESSORY_ANCHORS[charKey] || ACCESSORY_ANCHORS.pink;
    accImg.style.display='block';
    accImg.style.width = a.width + '%';
    accImg.style.left  = (a.left - a.width/2) + '%';
    accImg.style.top   = a.top + '%';
  }
  renderAccessory();

  /* シェル一覧 */
  const SHELLS = [
    { src:"public/items/asari1.png", prob:0.27, value:1 },
    { src:"public/items/asari2.png", prob:0.27, value:1 },
    { src:"public/items/asari3.png", prob:0.26, value:1 },
    { src:"public/items/aurora_shell.png",   prob:0.04, value:2 },
    { src:"public/items/flame_shell.png",    prob:0.03, value:2 },
    { src:"public/items/luminous_shell.png", prob:0.02, value:3 },
    { src:"public/items/mystic_shell.png",   prob:0.02, value:3 },
    { src:"public/items/night_sky_shell.png",prob:0.015,value:5 },
    { src:"public/items/rare_pearl.png",     prob:0.01, value:5 },
    { src:"public/items/rare_rainbow.png",   prob:0.005,value:10 }
  ];
  function chooseShell(){
    let r=Math.random(), acc=0;
    for(let s of SHELLS){ acc+=s.prob; if(r<acc) return s; }
    return SHELLS[0];
  }

  /* 砂なででシェル出現 */
  let stroking=false, lastEmit=0;
  const EMIT_INTERVAL=80;
  sand.addEventListener('pointerdown', e=>{ stroking=true; lastEmit=0; sand.setPointerCapture(e.pointerId); });
  sand.addEventListener('pointerup', ()=>stroking=false);
  sand.addEventListener('pointercancel', ()=>stroking=false);
  sand.addEventListener('pointermove', e=>{
    if(!stroking) return;
    e.preventDefault();
    const now=performance.now();
    if(now-lastEmit<EMIT_INTERVAL) return;
    lastEmit=now;
    spawnClam(e.clientX, e.clientY);
  });

  function spawnClam(x,y){
    const s=chooseShell();
    const d=document.createElement("div");
    d.className="clam";
    d.style.backgroundImage=`url('${s.src}')`;
    d.dataset.value=s.value;
    d.style.left=(x-32)+"px"; d.style.top=(y-32)+"px";
    clamsLayer.appendChild(d);
    d.addEventListener("click", ()=>pickClam(d,x,y,parseInt(d.dataset.value,10)), {once:true});
  }

  /* キャラが拾う */
  function moveCharacterTo(x,y){
    return new Promise(resolve=>{
      const L = x - (charWrap.clientWidth/2 || 80);
      const T = y - (charWrap.clientHeight*0.9 || 120);
      const onEnd=()=>{ charWrap.removeEventListener('transitionend', onEnd); resolve(); };
      charWrap.addEventListener('transitionend', onEnd);
      setCharPos(L,T); setTimeout(onEnd,1300);
    });
  }
  function pickClam(el,x,y,value){
    moveCharacterTo(x,y).then(()=>{
      charWrap.classList.add("picking");
      setTimeout(()=>charWrap.classList.remove("picking"),450);
      el.remove();
      count+=value;
      hudCnt.textContent=count;
      localStorage.setItem(LS.clam,count);
      if(value>1) showToast(`レア貝 +${value}！`);
      checkUnlocks();
    });
  }

  /* 徘徊 */
  function wander(){
    const mx=innerWidth*0.1, my=innerHeight*0.45;
    const x=mx+Math.random()*(innerWidth-mx*2);
    const y=my+Math.random()*(innerHeight-my-20);
    setCharPos(x-(charWrap.clientWidth/2||80), y);
  }
  setInterval(wander,5500);

  /* UI */
  function showToast(msg){ toast.textContent=msg; toast.classList.add('show'); clearTimeout(showToast._id); toast._id=setTimeout(()=>toast.classList.remove('show'),1400); }
  function checkUnlocks(){
    if(count>=10 && !unlocks.accessory){ unlocks.accessory=true; showToast('アクセサリー解放！'); renderAccessory(); }
    if(count>=30 && !unlocks.conversation){ unlocks.conversation=true; showToast('夜の会話 解放！'); }
    localStorage.setItem(LS.unlocks, JSON.stringify(unlocks));
  }

  document.getElementById('exam').addEventListener('click', ()=>{
    let got=0; const h=(e)=>{ if(e.target.classList && e.target.classList.contains('clam')) got++; };
    clamsLayer.addEventListener('click', h);
    showToast('検定開始：20秒で10個！');
    const start=performance.now(); const timer=setInterval(()=>{
      if(performance.now()-start>=20000){
        clearInterval(timer); clamsLayer.removeEventListener('click',h);
        if(got>=10){ localStorage.setItem(LS.title,'アサリ取り名人１級'); hudTitle.textContent='アサリ取り名人１級'; showToast('合格！称号ゲット'); }
        else { showToast('惜しい！もう一度挑戦してね'); }
      }
    },1000);
  });

  document.getElementById('release').addEventListener('click', ()=>{
    if(count<=0){ showToast('返せるアサリがありません'); return; }
    const r=Math.max(1,Math.floor(count*0.2));
    count-=r; hudCnt.textContent=count; localStorage.setItem(LS.clam,count);
    showToast(`${r}個のアサリを海に返しました`);
  });

  document.getElementById('toggleChar').addEventListener('click', ()=>{
    charWrap.style.display=(charWrap.style.display==='none')?'block':'none';
  });

  window.addEventListener('resize', ()=>{
    setCharPos(innerWidth*0.5 - (charWrap.clientWidth||160)/2, innerHeight*0.62);
  });
</script>
</body>
</html>
