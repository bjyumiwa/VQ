<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>WHO VQ â€” æ½®å¹²ç‹©ã‚Š</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;background:#000;color:#fff;font-family:system-ui,"Noto Sans JP",sans-serif;overflow:hidden}

  /* ===== èƒŒæ™¯ï¼ˆæ™‚é–“å¸¯ã§åˆ‡æ›¿ï¼‰ ===== */
  .stage{position:relative;width:100vw;height:100vh;overflow:hidden;isolation:isolate}
  .sky{position:absolute;inset:0;z-index:0;transition:filter .8s, opacity .8s}
  .sky.morning{background:linear-gradient(180deg,#8fd0ff 0%,#bfe8ff 45%,#e9f7ff 100%)}
  .sky.noon{background:linear-gradient(180deg,#63b3ff 0%,#8fd0ff 45%,#c2f0ff 100%)}
  .sky.night{background:linear-gradient(180deg,#0b172a 0%,#142849 45%,#03101f 100%)}

  .ocean{position:absolute;left:0;right:0;z-index:1;height:28vh;bottom:28vh;
         background:linear-gradient(180deg,rgba(40,140,220,.85),rgba(40,140,220,.65))}
  .ocean::before{
    content:"";position:absolute;inset:-10px;opacity:.32;
    background:
      radial-gradient(120px 12px at 0 60%, #fff, transparent 65%) 0 0/220px 44px repeat-x,
      radial-gradient(120px 12px at 110px 80%, #fff, transparent 65%) 0 22px/220px 44px repeat-x;
    animation:waves 12s linear infinite;
  }
  @keyframes waves{ to { transform: translateX(-220px); } }

  .shore{position:absolute;left:0;right:0;bottom:0;z-index:1;height:30vh;
         background:
         radial-gradient(800px 220px at 60% -40px, rgba(255,250,210,.35), transparent 60%),
         linear-gradient(180deg,#f3e2b3 0%,#e6d09a 50%,#d3bd82 100%)}

  /* ===== ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆè²ï¼ç ‚ï¼‰ ===== */
  canvas{position:absolute;left:0;top:0;width:100%;height:100%}
  #world{z-index:2}     /* è²ãƒ»åœ°é¢ã®é™°å½± */
  #sandMask{z-index:3}  /* ç ‚ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆã“ã“ã‚’æ¶ˆã—ã‚´ãƒ ã§â€œãªã§ã¦â€å‰Šã‚‹ï¼‰ */

  /* ===== UI ===== */
  .hud{position:absolute;z-index:4;left:10px;top:10px;padding:8px 12px;border-radius:10px;
       background:rgba(0,0,0,.45);backdrop-filter:blur(4px);font-size:14px}
  .btn{cursor:pointer;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.12);
       color:#fff;padding:6px 10px;border-radius:8px;font-size:13px}
  .hud-row{display:flex;gap:8px;align-items:center;margin-top:6px}
  .hint{position:absolute;z-index:4;right:10px;top:10px;font-size:12px;opacity:.75}

  /* ===== ã‚­ãƒ£ãƒ©ï¼ˆåŠåˆ†ã‚µã‚¤ã‚ºãƒ»è¿½å¾“ãƒ»ã‚†ã‚‰ãï¼‰ ===== */
  .char{position:absolute;z-index:4;width:100px;height:auto;  /* â† åŠåˆ†ã‚µã‚¤ã‚º */
        left:50%;top:50%;transform:translate(-50%,-50%);
        filter:drop-shadow(0 6px 14px rgba(0,0,0,.35))}
  @keyframes floatY{0%,100%{transform:translate(-50%,-50%) }50%{transform:translate(-50%,-55%)}}
  .char.float{animation:floatY 4s ease-in-out infinite}
  .speech{position:absolute;z-index:5;left:50%;transform:translateX(-50%);bottom:24vh;
          background:rgba(0,0,0,.65);border:1px solid rgba(255,255,255,.25);padding:6px 10px;border-radius:10px;font-size:13px;opacity:0;pointer-events:none;transition:opacity .2s}

  /* ===== å…¨å›åã®â€œãƒ¯ãƒ¼ãƒƒâ€æ¼”å‡º ===== */
  .bloom{position:absolute;inset:0;z-index:4;pointer-events:none;
         background:
         radial-gradient(60% 40% at 50% 40%, rgba(255,255,255,.50), transparent 60%),
         radial-gradient(50% 35% at 50% 60%, rgba(255,240,180,.35), transparent 65%);
         opacity:0;transform:scale(1);transition:opacity .9s ease, transform .9s ease}
  .stage.win .bloom{opacity:1;transform:scale(1.05)}
  .stage.win .sky{filter:brightness(1.25) saturate(1.25)}
  .stage.win .ocean{filter:brightness(1.15) saturate(1.15)}
  .stage.win .shore{filter:brightness(1.12) saturate(1.12)}
</style>
</head>
<body>
<div class="stage" id="stage">
  <div id="sky" class="sky"></div>
  <div class="ocean"></div>
  <div class="shore"></div>

  <canvas id="world"></canvas>
  <canvas id="sandMask"></canvas>

  <img id="char" class="char float" alt="character" src="" />
  <div id="speech" class="speech">ã‚„ã£ãŸï¼</div>
  <div class="bloom"></div>

  <div class="hud" id="hud">
    <div>ğŸš è²: <span id="count">0</span> / <span id="total">0</span></div>
    <div class="hud-row">
      <button class="btn" id="resetBtn">ç ‚ã‚’å…ƒã«æˆ»ã™</button>
      <button class="btn" id="toCollection">ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¸</button>
    </div>
  </div>
  <div class="hint">ç ‚ã®ä¸Šã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦â€œãªã§ã‚‹â€â†’ éœ²å‡ºã—ãŸè²ã‚’ã‚¿ãƒƒãƒ—</div>
</div>

<script>
/* =========================
   åŸºæœ¬è¨­å®š
   ========================= */
const LS_KEYS = { shells:"shell_inventory", whoChar:"who_character" };
function getCharPath(){
  const color = localStorage.getItem(LS_KEYS.whoChar) || "pink";
  return `public/assets/stage1/${color}_open.png`;
}
function setTimeBackground(){
  const h = new Date().getHours();
  const sky = document.getElementById("sky");
  sky.className = "sky " + (h>=5&&h<11 ? "morning" : h<18 ? "noon" : "night");
}

/* =========================
   ç”»é¢ã‚µã‚¤ã‚ºãƒ»ã‚­ãƒ£ãƒ³ãƒã‚¹
   ========================= */
const world = document.getElementById("world");
const wctx  = world.getContext("2d");
const mask  = document.getElementById("sandMask");
const mctx  = mask.getContext("2d", { willReadFrequently:true });

let W=0,H=0, DPR = Math.max(1, Math.min(2, window.devicePixelRatio||1));
const SAND_TOP = () => H*0.70; // ã“ã“ã‚ˆã‚Šä¸‹ãŒç ‚æµœ
function resize(){
  DPR = Math.max(1, Math.min(2, window.devicePixelRatio||1));
  W = world.width  = Math.floor(innerWidth * DPR);
  H = world.height = Math.floor(innerHeight* DPR);
  mask.width  = W; mask.height = H;
  world.style.width = mask.style.width = innerWidth+"px";
  world.style.height= mask.style.height= innerHeight+"px";
  drawMask();           // ç ‚ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’å†å¡—ã‚Š
  drawWorld(true);      // ä½ç½®å†è¨ˆç®—
}
window.addEventListener('resize', resize);

/* =========================
   è²ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ¬ã‚¢åº¦ãƒ»å‡ºç¾ç‡ï¼‰
   ========================= */
const SHELL_MASTER = [
  {id:"asari1", img:"public/assets/shells/asari1.png", weight:22, r:32},
  {id:"asari2", img:"public/assets/shells/asari2.png", weight:18, r:32},
  {id:"asari3", img:"public/assets/shells/asari3.png", weight:18, r:32},
  {id:"aurora_shell",   img:"public/assets/shells/aurora_shell.png",   weight:6, r:34},
  {id:"luminous_shell", img:"public/assets/shells/luminous_shell.png", weight:6, r:34},
  {id:"mystic_shell",   img:"public/assets/shells/mystic_shell.png",   weight:5, r:34},
  {id:"flame_shell",    img:"public/assets/shells/flame_shell.png",    weight:3, r:36},
  {id:"night_sky_shell",img:"public/assets/shells/night_sky_shell.png",weight:3, r:36},
  {id:"rare_rainbow",   img:"public/assets/shells/rare_rainbow.png",   weight:1, r:36},
  {id:"rare_pearl",     img:"public/assets/shells/rare_pearl.png",     weight:1, r:36},
];
const TOTAL_SHELLS = 12;

let shells = [];          // {id,img,x,y,r,found:false}
let foundCount = 0;
let inventory = loadJSON(LS_KEYS.shells, {});

function pickWeighted(){
  const sum = SHELL_MASTER.reduce((a,s)=>a+s.weight,0);
  let t = Math.random()*sum;
  for(const s of SHELL_MASTER){ if((t-=s.weight)<=0) return s; }
  return SHELL_MASTER[0];
}
function spawnShells(){
  shells = [];
  for(let i=0;i<TOTAL_SHELLS;i++){
    const m = pickWeighted();
    const img = new Image(); img.src = m.img;
    // ç ‚æµœã‚¨ãƒªã‚¢ã«æ•£ã‚‰ã™ï¼ˆå·¦å³10%ã¯ä½™ç™½ï¼‰
    const px = (innerWidth*DPR)*0.10 + Math.random()*(W*0.80);
    const py = SAND_TOP() + (Math.random()* (H - SAND_TOP() - 20*DPR));
    shells.push({ id:m.id, img, x:px, y:py, r:m.r*DPR, found:false });
  }
  document.getElementById("total").textContent = String(shells.length);
}

/* =========================
   ç ‚ãƒã‚¹ã‚¯ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ã§â€œãªã§ã‚‹â€ï¼‰
   ========================= */
const BRUSH = { r: 22*DPR }; // å°‘ã—å°ã•ã‚ã«ï¼ˆâ€œãªã§ã¦â€éœ²å‡ºï¼‰
let drawing = false, lastX=0, lastY=0;

function drawMask(){
  mctx.clearRect(0,0,W,H);
  // ç ‚ã¯ä¸‹åŠåˆ†ã ã‘
  const top = SAND_TOP();
  const grad = mctx.createLinearGradient(0,top,0,H);
  grad.addColorStop(0, "rgba(233,210,150,0.96)");
  grad.addColorStop(1, "rgba(210,185,120,0.98)");
  mctx.fillStyle = grad; mctx.fillRect(0,top,W,H-top);

  // ç ‚ç²’ã®ãƒã‚¤ã‚º
  const step = 6*DPR; mctx.globalAlpha = 0.08;
  for(let y=top; y<H; y+=step){
    for(let x=0; x<W; x+=step){
      mctx.fillStyle = ((x+y/step)%3===0 ? "#000" : "#fff");
      mctx.fillRect(x,y,1,1);
    }
  }
  mctx.globalAlpha = 1;
}
function eraseAt(x,y){
  mctx.save();
  mctx.globalCompositeOperation = 'destination-out';
  mctx.beginPath(); mctx.arc(x,y,BRUSH.r,0,Math.PI*2); mctx.fill();
  mctx.restore();
}
function onPointerDown(e){ drawing=true; const p=point(e); lastX=p.x; lastY=p.y; if(p.y>=SAND_TOP()) eraseAt(p.x,p.y); }
function onPointerMove(e){
  const p=point(e);
  // è¿½å¾“æ›´æ–°ï¼ˆã‚­ãƒ£ãƒ©ç§»å‹•ç”¨ï¼‰
  if(!drawing || p.y < SAND_TOP()) return;
  const dx=p.x-lastX, dy=p.y-lastY, dist=Math.hypot(dx,dy), step=BRUSH.r*0.6;
  for(let t=0;t<=dist;t+=step){ eraseAt(lastX+dx*(t/dist), lastY+dy*(t/dist)); }
  lastX=p.x; lastY=p.y;
}
function onPointerUp(){ drawing=false; }

/* =========================
   éœ²å‡ºåˆ¤å®š â†’ ã‚¯ãƒªãƒƒã‚¯ã§å›å
   ========================= */
function isExposed(sh, ratioNeeded=0.60){
  const r = Math.floor(sh.r*0.9);
  const size = r*2;
  const sx = Math.max(0, Math.min(Math.floor(sh.x - r), W-size));
  const sy = Math.max(0, Math.min(Math.floor(sh.y - r), H-size));
  try{
    const imgData = mctx.getImageData(sx, sy, size, size).data;
    let transparent=0, total=0;
    const step = 6;
    for(let yy=0; yy<size; yy+=step){
      for(let xx=0; xx<size; xx+=step){
        const a = imgData[(yy*size + xx)*4 + 3];
        total++; if(a===0) transparent++;
      }
    }
    return (transparent/total) >= ratioNeeded;
  }catch{ return true; }
}

function onClick(e){
  const p = point(e);
  if(p.y < SAND_TOP()) return;

  // è¿‘ã„è²
  let target=null, dmin=1e9;
  for(const sh of shells){
    if(sh.found) continue;
    const d = Math.hypot(p.x - sh.x, p.y - sh.y);
    if(d < sh.r*1.2 && d < dmin){ dmin=d; target=sh; }
  }
  if(!target) return;

  if(!isExposed(target, 0.60)){ say("ã¾ã ç ‚ã®ä¸­â€¦"); return; }

  // å›åï¼
  target.found = true;
  foundCount++;
  inventory[target.id] = (inventory[target.id]||0) + 1;
  saveJSON(LS_KEYS.shells, inventory);
  document.getElementById("count").textContent = String(foundCount);
  drawWorld();

  spinCharacter();
  say(pickMessage(target.id));

  if(shells.every(s=>s.found)){
    // â€œãƒ¯ãƒ¼ãƒƒâ€ã¨æ˜ã‚‹ã
    document.getElementById("stage").classList.add("win");
    setTimeout(()=> location.href="collection.html", 1200);
  }
}

/* =========================
   æç”»ï¼ˆè²ï¼†ç ‚é™°å½±ï¼‰
   ========================= */
function drawWorld(reseed=false){
  if(reseed){ spawnShells(); }
  wctx.clearRect(0,0,W,H);

  // ç ‚æµœã®è–„ã„é™°å½±
  const g = wctx.createLinearGradient(0,SAND_TOP(),0,H);
  g.addColorStop(0,"rgba(0,0,0,0.08)");
  g.addColorStop(1,"rgba(0,0,0,0.15)");
  wctx.fillStyle = g; wctx.fillRect(0,SAND_TOP(),W,H-SAND_TOP());

  // æœªå›åã®è²ã ã‘æã
  shells.forEach(sh=>{
    if(sh.found) return;
    const sz = sh.r*2;
    try{ wctx.drawImage(sh.img, sh.x - sh.r, sh.y - sh.r, sz, sz); }catch{}
  });
}

/* =========================
   ã‚­ãƒ£ãƒ©ï¼šã‚¹ãƒ ãƒ¼ã‚ºè¿½å¾“ï¼‹ã‚¹ãƒ”ãƒ³ï¼‹å¹ãå‡ºã—
   ========================= */
const charEl = document.getElementById("char");
function setupCharacter(){
  charEl.src = getCharPath();
  let cx = innerWidth/2, cy = innerHeight*0.52, vx=0, vy=0;
  const k = 0.10, damp=0.86;  // ã‚¹ãƒ ãƒ¼ã‚ºæ„Ÿ
  function tick(){
    const tx = mouse.x, ty = mouse.y-26;  // å°‘ã—ã ã‘ä¸Šã«è¿½å¾“
    vx = (vx + (tx - cx)*k) * damp;
    vy = (vy + (ty - cy)*k) * damp;
    cx += vx; cy += vy;
    charEl.style.left = cx + "px";
    charEl.style.top  = cy + "px";
    requestAnimationFrame(tick);
  }
  tick();
}
function spinCharacter(){
  charEl.style.transition="transform .45s";
  charEl.style.transform="translate(-50%,-50%) rotate(360deg)";
  setTimeout(()=>{ charEl.style.transform="translate(-50%,-50%)"; }, 450);
}
function say(text){
  const sp = document.getElementById("speech");
  sp.textContent = text;
  sp.style.opacity = 1;
  clearTimeout(say._t);
  say._t = setTimeout(()=> sp.style.opacity = 0, 1100);
}
function pickMessage(id){
  switch(id){
    case "rare_pearl": return "çœŸç ã ï¼";
    case "rare_rainbow": return "è™¹è‰²ã®è²ï¼";
    case "flame_shell": return "ã‚ã¤ã„â€¦ï¼";
    case "night_sky_shell": return "ã‚­ãƒ©ã‚­ãƒ©ï½";
    default: return "ã‚„ã£ãŸï¼";
  }
}

/* =========================
   ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
   ========================= */
function loadJSON(k,fb){ try{return JSON.parse(localStorage.getItem(k))||fb}catch(e){return fb} }
function saveJSON(k,v){ localStorage.setItem(k, JSON.stringify(v)) }

const mouse = {x: innerWidth/2, y: innerHeight/2};
function point(e){
  const rect = world.getBoundingClientRect();
  const x = ((e.touches?e.touches[0].clientX:e.clientX) - rect.left) * DPR;
  const y = ((e.touches?e.touches[0].clientY:e.clientY) - rect.top)  * DPR;
  // è¿½å¾“ç”¨ã®è¡¨ç¤ºåº§æ¨™ã‚‚æ›´æ–°
  mouse.x = (x / DPR); mouse.y = (y / DPR);
  return {x,y};
}

/* =========================
   åˆæœŸåŒ–
   ========================= */
function init(){
  setTimeBackground();
  document.getElementById("count").textContent = "0";
  document.getElementById("total").textContent = "0";

  resize();
  setupCharacter();
  drawWorld(true);

  // â€œãªã§ã‚‹â€æ“ä½œ
  mask.addEventListener("pointerdown", onPointerDown);
  mask.addEventListener("pointermove", onPointerMove);
  window.addEventListener("pointerup", onPointerUp);
  // éœ²å‡ºå¾Œã®å›åã¯ã‚¯ãƒªãƒƒã‚¯
  mask.addEventListener("click", onClick);

  // ãƒœã‚¿ãƒ³
  document.getElementById("resetBtn").onclick = ()=>{
    drawMask(); drawWorld(); foundCount=0; shells.forEach(s=>s.found=false);
    document.getElementById("count").textContent="0";
    document.getElementById("stage").classList.remove("win");
  };
  document.getElementById("toCollection").onclick = ()=> location.href="collection.html";
}
init();
</script>
</body>
</html>
