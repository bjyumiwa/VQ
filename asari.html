<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
  <title>WHO VQ — 潮干狩り</title>
  <style>
    body {
      margin: 0;
      font-family: "Hiragino Sans","Meiryo",sans-serif;
      background: url("public/items/bg/beach_day.jpg") no-repeat center/cover;
      height: 100vh;
      overflow: hidden;
    }
    .game-container {
      position: relative;
      width: 100%;
      height: 100%;
    }

    /* キャラ表示 */
    .character-area {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      pointer-events: none;
    }
    .character-area img {
      height: 40vh;
      width: auto;
      animation: sway 3s ease-in-out infinite;
      filter: drop-shadow(0 8px 6px rgba(0,0,0,0.4));
    }
    @keyframes sway {
      0%,100% { transform: translateX(-50%) rotate(-2deg); }
      50%     { transform: translateX(-50%) rotate(2deg); }
    }

    /* 貝 */
    .clam {
      position: absolute;
      width: 40px;
      height: 40px;
      background: url("public/assets/items/clam.png") no-repeat center/contain;
    }
    .clam.rare {
      background: url("public/assets/items/clam_gold.png") no-repeat center/contain;
    }

    /* HUD */
    .hud {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.5);
      color: #fff;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 14px;
    }

    /* 操作用ボタン */
    .controls {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .controls button {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      background: rgba(255,255,255,0.8);
    }
  </style>
</head>
<body>
  <div class="game-container" id="gameArea">
    <!-- HUD -->
    <div class="hud">
      アサリ: <span id="clamCount">0</span>
      <br>
      称号: <span id="title">なし</span>
    </div>

    <!-- 操作ボタン -->
    <div class="controls">
      <button id="toggleChar">キャラ表示ON/OFF</button>
      <button id="examMode">検定モード</button>
      <button id="releaseBtn">海に返す</button>
    </div>

    <!-- キャラ -->
    <div class="character-area" id="charArea">
      <img id="charImg" src="" alt="キャラ">
    </div>
  </div>

  <script>
    const LS_KEYS = {
      character: "who_character",
      clam: "who_clam",
      title: "who_title",
      unlocks: "who_unlocks"
    };

    const gameArea = document.getElementById("gameArea");
    const charImg = document.getElementById("charImg");
    const clamCountEl = document.getElementById("clamCount");
    const titleEl = document.getElementById("title");

    // --- キャラ設定 ---
    const selectedChar = localStorage.getItem(LS_KEYS.character) || "pink";
    charImg.src = `public/assets/stage1/${selectedChar}_open.png`;

    // --- 所持数・称号読み込み ---
    let clamCount = parseInt(localStorage.getItem(LS_KEYS.clam) || "0", 10);
    let title = localStorage.getItem(LS_KEYS.title) || "なし";
    let unlocks = JSON.parse(localStorage.getItem(LS_KEYS.unlocks) || "{}");
    clamCountEl.textContent = clamCount;
    titleEl.textContent = title;

    // --- 貝を出す処理 ---
    function spawnClam(x, y) {
      if (Math.random() > 0.25) return; // 出現率25%くらいで「なかなか集まらない」感じに

      const clam = document.createElement("div");
      clam.classList.add("clam");

      // レア貝判定（5%）
      const isRare = Math.random() < 0.05;
      if (isRare) clam.classList.add("rare");

      clam.style.left = x - 20 + "px";
      clam.style.top = y - 20 + "px";
      gameArea.appendChild(clam);

      clam.addEventListener("click", () => {
        clam.remove();
        const add = isRare ? 3 : 1;
        clamCount += add;
        clamCountEl.textContent = clamCount;
        localStorage.setItem(LS_KEYS.clam, clamCount);
        checkUnlocks();
      });
    }

    // --- 砂をなでる ---
    let dragging = false;
    function handleMove(e) {
      const x = e.touches ? e.touches[0].clientX : e.clientX;
      const y = e.touches ? e.touches[0].clientY : e.clientY;
      if (dragging) spawnClam(x, y);
    }
    gameArea.addEventListener("mousedown", () => dragging = true);
    gameArea.addEventListener("mouseup", () => dragging = false);
    gameArea.addEventListener("mousemove", handleMove);
    gameArea.addEventListener("touchstart", () => dragging = true);
    gameArea.addEventListener("touchend", () => dragging = false);
    gameArea.addEventListener("touchmove", handleMove);

    // --- 特典解放 ---
    function checkUnlocks() {
      if (clamCount >= 10 && !unlocks.accessory) {
        unlocks.accessory = true;
        alert("アクセサリーが解放されました！");
      }
      if (clamCount >= 30 && !unlocks.conversation) {
        unlocks.conversation = true;
        alert("夜の会話が解放されました！");
      }
      localStorage.setItem(LS_KEYS.unlocks, JSON.stringify(unlocks));
    }

    // --- 検定モード ---
    document.getElementById("examMode").addEventListener("click", () => {
      let examCount = 0;
      let time = 20;
      alert("検定モード開始！20秒以内に10個取ろう！");
      const timer = setInterval(() => {
        time--;
        if (time <= 0) {
          clearInterval(timer);
          if (examCount >= 10) {
            title = "アサリ取り名人１級";
            localStorage.setItem(LS_KEYS.title, title);
            titleEl.textContent = title;
            alert("合格！称号「アサリ取り名人１級」獲得！");
          } else {
            alert("残念！もう一度挑戦してみよう。");
          }
        }
      }, 1000);

      // 一時的に回収数をカウント
      const handler = () => { examCount++; };
      gameArea.addEventListener("clamCollected", handler);

      setTimeout(() => {
        gameArea.removeEventListener("clamCollected", handler);
      }, 20000);
    });

    // --- 海に返す ---
    document.getElementById("releaseBtn").addEventListener("click", () => {
      if (clamCount <= 0) { alert("返せるアサリがありません"); return; }
      const release = Math.max(1, Math.floor(clamCount * 0.2)); // 2割くらい返す
      clamCount -= release;
      clamCountEl.textContent = clamCount;
      localStorage.setItem(LS_KEYS.clam, clamCount);
      alert(`${release}個のアサリを海に返しました🌊`);
    });

    // --- キャラ表示ON/OFF ---
    const charArea = document.getElementById("charArea");
    document.getElementById("toggleChar").addEventListener("click", () => {
      charArea.style.display = (charArea.style.display === "none") ? "block" : "none";
    });
  </script>
</body>
</html>
