<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
  <title>WHO VQ — 潮干狩り</title>

  <!-- 背景画像は jpg / パスは public/items/bg/ で統一 -->
  <link rel="preload" as="image" href="public/items/bg/sunrise.jpg" />
  <link rel="preload" as="image" href="public/items/bg/beach_day.jpg" />
  <link rel="preload" as="image" href="public/items/bg/night_beach.jpg" />

  <style>
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font-family:system-ui,"Noto Sans JP","Hiragino Sans","Meiryo",sans-serif;
      color:#fff; overflow:hidden;
      background:#000 center/cover no-repeat;
    }
    /* 画面レイヤ */
    #stage{position:relative; width:100%; height:100dvh; overflow:hidden;}
    .hud{
      position:fixed; left:0; right:0; top:0;
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px; z-index:30;
      background:linear-gradient(180deg,rgba(0,0,0,.5),rgba(0,0,0,0));
      gap:8px;
    }
    .hud .btn{
      appearance:none; border:none; border-radius:999px; padding:8px 14px;
      background:rgba(255,255,255,.12); color:#fff; font-weight:600;
      backdrop-filter:blur(6px); cursor:pointer;
    }
    .hud .btn:active{transform:translateY(1px)}
    .hud .counter{font-weight:700; text-shadow:0 1px 2px rgba(0,0,0,.6)}

    /* キャラ */
    #character{
      position:absolute; z-index:10;
      width:min(22vw, 180px); /* 端末で程よく */
      transform:translate(-50%,-50%);
      pointer-events:none; /* クリックはステージで拾う */
      filter: drop-shadow(0 10px 16px rgba(0,0,0,.45));
      transition: left .28s ease, top .28s ease;
    }
    /* 掘るモーション（上下＆少しひねる） */
    @keyframes dig {
      0%   { transform:translate(-50%,-50%) rotate(0deg); }
      25%  { transform:translate(-50%,-47%) rotate(-5deg); }
      50%  { transform:translate(-50%,-54%) rotate(5deg); }
      75%  { transform:translate(-50%,-49%) rotate(-4deg); }
      100% { transform:translate(-50%,-50%) rotate(0deg); }
    }
    .digging{ animation:dig .6s ease-in-out; }

    /* 砂のエフェクト */
    .sand{
      position:absolute; z-index:5; width:10px; height:10px; border-radius:50%;
      background:rgba(222,200,150,.85);
      opacity:.95; pointer-events:none; filter:blur(.3px);
      animation: puff .6s ease-out forwards;
    }
    @keyframes puff{
      0%{ transform:translate(0,0) scale(.9); opacity:.95 }
      100%{ transform:translate(var(--dx), var(--dy)) scale(1.2); opacity:0 }
    }

    /* 貝（出現→小ジャンプ） */
    .shell{
      position:absolute; z-index:8; width:min(10vw,75px);
      transform:translate(-50%,-30%) scale(.9);
      animation:pop .35s ease-out;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.35));
      user-select:none;
    }
    @keyframes pop{
      from{ transform:translate(-50%,-20%) scale(.7); opacity:0 }
      to  { transform:translate(-50%,-30%) scale(1); opacity:1 }
    }

    /* 足元の波紋っぽい影 */
    .foot{
      position:absolute; z-index:4; width:min(26vw,210px); height:22px;
      background: radial-gradient(ellipse at center, rgba(0,0,0,.35), rgba(0,0,0,0) 60%);
      transform:translate(-50%,-50%);
      filter: blur(6px); opacity:.55; pointer-events:none;
    }

    /* 画面下のガイド */
    .help{
      position:fixed; left:50%; bottom:10px; transform:translateX(-50%);
      background:rgba(0,0,0,.35); padding:8px 12px; border-radius:10px;
      font-size:14px; z-index:30; backdrop-filter:blur(6px)
    }
  </style>
</head>
<body>
  <div id="stage" aria-label="beach play area">
    <img id="character" alt="character" />
    <div id="foot" class="foot"></div>
  </div>

  <div class="hud">
    <button class="btn" id="backBtn" onclick="location.href='char.html'">← キャラ選択に戻る</button>
    <div class="counter" id="counter">0 shells</div>
    <button class="btn" id="toCollection" onclick="location.href='collection.html'">コレクションを見る →</button>
  </div>
  <div class="help">砂浜をタップ / クリックすると、その場所へ移動して掘ります</div>

  <script>
    // ======== 背景：時刻から自動選択（朝 5-8 / 昼 9-17 / 夜 18-4） ========
    (function setBackground(){
      const h = new Date().getHours();
      let bg = "public/items/bg/beach_day.jpg";
      if (h >= 5 && h <= 8) bg = "public/items/bg/sunrise.jpg";
      else if (h >= 18 || h <= 4) bg = "public/items/bg/night_beach.jpg";
      document.body.style.backgroundImage = `url('${bg}')`;
    })();

    // ======== 便利：localStorageから選択キャラ画像を推測して取得 ========
    function findSelectedCharacterSrc(){
      const candidates = [
        "whoai_character_src","whoai_selectedCharacter","selectedCharacterSrc",
        "selectedCharacter","characterImage","char_src"
      ];
      for (const k of candidates){
        const v = localStorage.getItem(k);
        if (v && typeof v === "string") return v;
      }
      // 既定（ブルー種）
      return "public/characters/tane_blue.png";
    }

    // ======== ステージ要素 ========
    const stage = document.getElementById("stage");
    const character = document.getElementById("character");
    const foot = document.getElementById("foot");
    const counterEl = document.getElementById("counter");

    // キャラ画像読込
    character.src = findSelectedCharacterSrc();

    // 初期位置（中央やや下）
    let cx = window.innerWidth * 0.5;
    let cy = window.innerHeight * 0.72;
    function placeCharacter(x, y){
      cx = Math.max(30, Math.min(window.innerWidth - 30, x));
      cy = Math.max(60, Math.min(window.innerHeight - 30, y));
      character.style.left = cx + "px";
      character.style.top  = cy + "px";
      foot.style.left = cx + "px";
      foot.style.top  = (cy + character.clientHeight*0.40) + "px";
    }
    window.addEventListener("resize", ()=> placeCharacter(cx, cy));
    character.addEventListener("load", ()=> placeCharacter(cx, cy));

    // ======== 砂・貝 定義 ========
    // 一般貝（アサリ：白・黄・橙）
    const COMMON_SHELLS = [
      { id:"asari_white", label:"アサリ（白）",  src:"public/items/shells/asari_white.png",  weight: 60 },
      { id:"asari_yellow",label:"アサリ（黄）",  src:"public/items/shells/asari_yellow.png", weight: 30 },
      { id:"asari_orange",label:"アサリ（橙）",  src:"public/items/shells/asari_orange.png", weight: 20 },
    ];
    // レア貝（炎・オーロラ・光る・神秘・夜空・虹色・真珠）
    const RARE_SHELLS = [
      { id:"rare_flame",   label:"炎の貝",   src:"public/items/shells/rare_flame.png",   weight: 6 },
      { id:"rare_aurora",  label:"オーロラ", src:"public/items/shells/rare_aurora.png",  weight: 5 },
      { id:"rare_glow",    label:"光る貝",   src:"public/items/shells/rare_glow.png",    weight: 5 },
      { id:"rare_mystic",  label:"神秘の貝", src:"public/items/shells/rare_mystic.png",  weight: 4 },
      { id:"rare_night",   label:"夜空の貝", src:"public/items/shells/rare_night.png",   weight: 3 },
      { id:"rare_rainbow", label:"虹色の貝", src:"public/items/shells/rare_rainbow.png", weight: 2 },
      { id:"rare_pearl",   label:"真珠",     src:"public/items/shells/rare_pearl.png",   weight: 2 },
    ];
    const ALL_SHELLS = COMMON_SHELLS.concat(RARE_SHELLS);

    function pickShell(){
      // 90%: COMMON / 10%: RARE から重み付き抽選
      const pool = Math.random() < 0.9 ? COMMON_SHELLS : RARE_SHELLS;
      const total = pool.reduce((s,a)=> s + a.weight, 0);
      let r = Math.random()*total;
      for(const a of pool){
        if((r -= a.weight) <= 0) return a;
      }
      return pool[0];
    }

    // ======== 所持コレクション保存 ========
    function loadCollection(){
      try{
        const raw = localStorage.getItem("whoai_shells");
        return raw ? JSON.parse(raw) : [];
      }catch(e){ return [] }
    }
    function saveCollection(arr){ localStorage.setItem("whoai_shells", JSON.stringify(arr)); }
    function addToCollection(item){
      const list = loadCollection();
      list.push({ ...item, ts: Date.now() });
      saveCollection(list);
      counterEl.textContent = `${list.length} shells`;
    }
    // 初期カウンタ
    counterEl.textContent = `${loadCollection().length} shells`;

    // ======== エフェクト生成 ========
    function spawnSand(x, y){
      for(let i=0;i<6;i++){
        const d = document.createElement("div");
        d.className = "sand";
        const ang = (Math.random()*Math.PI) - Math.PI/2; // 左右に飛ぶ
        const dist = 20 + Math.random()*26;
        d.style.left = (x + (Math.random()*10-5)) + "px";
        d.style.top  = (y + (Math.random()*8-2)) + "px";
        d.style.setProperty("--dx", (Math.cos(ang)*dist)+"px");
        d.style.setProperty("--dy", (Math.sin(ang)*dist)+"px");
        stage.appendChild(d);
        setTimeout(()=> d.remove(), 620);
      }
    }

    function spawnShellAt(x, y){
      const item = pickShell();
      const img = new Image();
      img.src = item.src;
      img.alt = item.label;
      img.className = "shell";
      img.style.left = x + "px";
      img.style.top  = (y + 4) + "px";
      img.draggable = false;

      // クリックで回収
      img.addEventListener("click", (e)=>{
        e.stopPropagation();
        img.style.transition = "transform .25s ease, opacity .25s ease";
        img.style.transform = "translate(-50%,-60%) scale(.8)";
        img.style.opacity = "0";
        setTimeout(()=> img.remove(), 240);
        addToCollection(item);
      });

      stage.appendChild(img);
      // 自動で回収したい場合は数秒後に吸い寄せる処理を入れてもOK
    }

    // ======== 掘る：クリック地点へ移動→掘る→貝出現 ========
    let diggingLock = false;
    stage.addEventListener("click", (ev)=>{
      if (diggingLock) return;
      const rect = stage.getBoundingClientRect();
      const x = ev.clientX - rect.left;
      const y = ev.clientY - rect.top;

      diggingLock = true;

      // 少し手前（キャラの足元に合うように）に移動
      placeCharacter(x, y + 10);

      // 到着少し後に掘り開始
      setTimeout(()=>{
        character.classList.add("digging");
        spawnSand(cx, cy);
        // 掘ってから貝を出す
        setTimeout(()=>{
          spawnShellAt(cx, cy);
          character.classList.remove("digging");
          diggingLock = false;
        }, 340);
      }, 260);
    });

    // 初期配置
    placeCharacter(cx, cy);
  </script>
</body>
</html>
