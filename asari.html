<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover,user-scalable=no" />
<title>WHO VQ ‚Äî ÊΩÆÂπ≤Áã©„ÇäÔºà„É©„Çπ„ÉàÁâàÔºâ</title>
<style>
  :root{ --fg:#fff; --glass:rgba(0,0,0,.38); }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{background:#000;color:var(--fg);overflow:hidden;
    font-family:system-ui,"Noto Sans JP","Meiryo",sans-serif;touch-action:none;}

  /* ËÉåÊôØ */
  .bg{position:fixed;inset:0;z-index:0;pointer-events:none;
    background-size:cover;background-position:center;transition:opacity .8s}
  .bg.sunrise{background-image:url("public/items/bg/sunrise.jpg")}
  .bg.day{background-image:url("public/items/bg/beach_day.jpg")}
  .bg.night{background-image:url("public/items/bg/night_beach.jpg")}
  .bg.dim{opacity:.35}
  .bg.revealed{opacity:1}

  .scene{position:relative;z-index:1;width:100vw;height:100vh;overflow:hidden}
  .under{position:absolute;inset:0;z-index:1}
  .clam{
    position:absolute;width:46px;height:46px;
    background:url("public/items/asari3.png") center/contain no-repeat;
    filter:drop-shadow(0 2px 2px rgba(0,0,0,.45));
    opacity:0;transition:opacity .2s ease,transform .2s ease;cursor:pointer;
  }
  .clam.seen{opacity:1}
  .clam.collected{opacity:0;transform:scale(.6);pointer-events:none}

  #sandCanvas{position:absolute;inset:0;z-index:2;cursor:crosshair;touch-action:none;}

  /* „Ç≠„É£„É©ËøΩÂæì */
  .friend-wrap{
    position:absolute;left:50%;top:55%;
    transform:translate(-50%,-50%) translate(var(--tx,0px), var(--ty,0px));
    z-index:3;pointer-events:none;
  }
  .friend{
    display:block;height:clamp(90px,22vh,220px);transform:scale(.5);
    transform-origin:center center;
    filter:drop-shadow(0 8px 18px rgba(0,0,0,.45));
    opacity:0;transition:opacity .25s ease;
  }
  .friend.show{opacity:1}
  .friend.spin{animation:friendSpin .5s ease both;}
  @keyframes friendSpin{
    0%{transform:scale(.5) rotate(0deg)}
    50%{transform:scale(.52) rotate(180deg)}
    100%{transform:scale(.5) rotate(360deg)}
  }

  /* Âêπ„ÅçÂá∫„Åó */
  .bubble{
    position:absolute;left:50%;top:-10px;transform:translate(-50%,-100%);
    background:rgba(255,255,255,.95);color:#000;padding:6px 10px;border-radius:12px;
    font-size:13px;white-space:nowrap;opacity:0;transition:opacity .2s;pointer-events:none;
  }
  .bubble.show{opacity:1}

  .hud{
    position:fixed;top:8px;right:8px;z-index:5;
    display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:14px;
    background:var(--glass);backdrop-filter:blur(6px);font-size:14px}
  .hud b{font-size:16px}
  .hint{position:fixed;left:50%;top:12px;transform:translateX(-50%);z-index:5;font-size:12px;opacity:.9}
  .btnbar{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);z-index:5;display:flex;gap:10px}
  .btn{border:none;border-radius:12px;padding:8px 12px;cursor:pointer;
       background:linear-gradient(180deg,#ffde8a,#ffbf6b);color:#2b1b07;font-weight:700}
  .ghost{background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.25)}
</style>
</head>
<body>
<div id="bg" class="bg dim"></div>

<div class="scene" id="scene">
  <div id="under" class="under"></div>
  <canvas id="sandCanvas"></canvas>

  <div id="friendWrap" class="friend-wrap" style="--tx:0px;--ty:0px;">
    <img id="friend" class="friend" alt="friend"/>
    <div id="bubble" class="bubble"></div>
  </div>
</div>

<div class="hud">üêö <b id="count">0</b><span>ÂÄã</span></div>
<div class="hint">Á†Ç„Çí„Å™„Åß„Å¶ ‚Üí Ë≤ù„Çí„ÇØ„É™„ÉÉ„ÇØÔºÅ</div>
<div class="btnbar">
  <button class="btn ghost" id="resetBtn">Á†Ç„ÇíÊàª„Åô</button>
  <button class="btn ghost" id="backBtn">Êàª„Çã</button>
</div>

<script>
(function(){
  const LS_CHAR='who_character', LS_CLAM='who_clams';
  const CLAM_IMG='public/items/asari3.png';
  const CLAM_COUNT=16, BRUSH=28, CLEAR_RATIO=0.85;

  const bg=document.getElementById('bg');
  const scene=document.getElementById('scene');
  const under=document.getElementById('under');
  const canvas=document.getElementById('sandCanvas');
  const ctx=canvas.getContext('2d');
  const friendWrap=document.getElementById('friendWrap');
  const friend=document.getElementById('friend');
  const bubble=document.getElementById('bubble');
  const countEl=document.getElementById('count');
  const resetBtn=document.getElementById('resetBtn');
  const backBtn=document.getElementById('backBtn');

  // ËÉåÊôØ
  (function(){
    const h=new Date().getHours();
    bg.classList.remove('sunrise','day','night');
    if(h>=5&&h<9) bg.classList.add('sunrise');
    else if(h>=9&&h<18) bg.classList.add('day');
    else bg.classList.add('night');
  })();

  // „Ç≠„É£„É©„É≠„Éº„Éâ
  const FRIEND_PATH=(c)=>(c&&c.includes('/'))?c:`public/assets/stage1/${c||'pink'}_closed.png`;
  (function(){
    const c=localStorage.getItem(LS_CHAR)||'pink';
    friend.onload=()=>friend.classList.add('show');
    friend.src=FRIEND_PATH(c);
  })();

  // Áä∂ÊÖã
  let W=0,H=0,total=parseInt(localStorage.getItem(LS_CLAM)||'0',10);
  let nodes=[],drawing=false,lastX=0,lastY=0;
  function updateCount(){countEl.textContent=total;}

  // „É¨„Ç§„Ç¢„Ç¶„Éà
  function drawSandBase(){
    ctx.globalCompositeOperation='source-over';
    const grd=ctx.createLinearGradient(0,H*0.35,0,H);
    grd.addColorStop(0,'#d9c7a0');grd.addColorStop(0.45,'#cdb893');grd.addColorStop(1,'#b79362');
    ctx.globalAlpha=0.96;ctx.fillStyle=grd;ctx.fillRect(0,0,W,H);
    ctx.globalAlpha=1;
  }
  function placeClams(){
    under.innerHTML='';nodes=[];
    const top=H*0.42;
    for(let i=0;i<CLAM_COUNT;i++){
      const x=Math.random()*(W*0.8)+W*0.1;
      const y=top+Math.random()*(H-top-60)+20;
      const s=34+Math.random()*18;
      const el=document.createElement('div');
      el.className='clam';el.style.left=(x-s/2)+'px';el.style.top=(y-s/2)+'px';
      el.style.width=s+'px';el.style.height=s+'px';
      el.style.backgroundImage=`url("${CLAM_IMG}")`;
      under.appendChild(el);
      nodes.push({x,y,s,el,seen:false,dead:false});
    }
  }
  function resize(){
    const r=scene.getBoundingClientRect();
    W=canvas.width=r.width;H=canvas.height=r.height;
    drawSandBase();placeClams();bg.classList.add('dim');bg.classList.remove('revealed');
  }
  window.addEventListener('resize',resize);resize();updateCount();

  // „Éñ„É©„Ç∑
  function eraseCircle(x,y){
    ctx.save();ctx.globalCompositeOperation='destination-out';
    const g=ctx.createRadialGradient(x,y,BRUSH*0.2,x,y,BRUSH);
    g.addColorStop(0,'rgba(0,0,0,0.95)');g.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=g;ctx.beginPath();ctx.arc(x,y,BRUSH,0,Math.PI*2);ctx.fill();ctx.restore();
    const r2=BRUSH*BRUSH*1.2;
    for(const n of nodes){if(!n.seen&&!n.dead){
      const dx=n.x-x,dy=n.y-y;if(dx*dx+dy*dy<=r2){n.seen=true;n.el.classList.add('seen');}
    }}
  }
  function sampleClear(){
    const step=8,img=ctx.getImageData(0,0,W,H).data;let t=0,c=0;
    for(let y=0;y<H;y+=step){for(let x=0;x<W;x+=step){
      const a=img[((y*W)+x)*4+3];t++;if(a<30)c++;}}
    return c/t;
  }

  canvas.addEventListener('pointerdown',ev=>{
    drawing=true;lastX=ev.clientX;lastY=ev.clientY;eraseCircle(lastX,lastY);
  });
  canvas.addEventListener('pointermove',ev=>{
    if(drawing){
      const x=ev.clientX,y=ev.clientY;
      const dx=x-lastX,dy=y-lastY,dist=Math.hypot(dx,dy);
      const steps=Math.max(1,Math.floor(dist/(BRUSH*0.6)));
      for(let i=1;i<=steps;i++){
        eraseCircle(lastX+dx*(i/steps),lastY+dy*(i/steps));
      }
      lastX=x;lastY=y;
      if(sampleClear()>=CLEAR_RATIO){bg.classList.remove('dim');bg.classList.add('revealed');}
    }
    trackMouse(ev.clientX,ev.clientY);
  });
  window.addEventListener('pointerup',()=>drawing=false);
  window.addEventListener('pointermove',ev=>trackMouse(ev.clientX,ev.clientY));

  // ÂõûÂèé
  function tryCollect(px,py){
    const prev=canvas.style.pointerEvents;canvas.style.pointerEvents='none';
    const el=document.elementFromPoint(px,py);canvas.style.pointerEvents=prev;
    if(!(el&&el.classList.contains('clam')))return;
    const n=nodes.find(n=>n.el===el&&!n.dead);if(!n)return;
    n.dead=true;el.classList.add('collected');setTimeout(()=>el.remove(),150);
    total++;localStorage.setItem(LS_CLAM,total);updateCount();
    friend.classList.remove('spin');void friend.offsetWidth;friend.classList.add('spin');
    speak(["„Åì„Åì„Å†„ÇàÔºÅ","„ÇÑ„Å£„Åü„Å≠ÔºÅ","„Éä„Ç§„ÇπÔºÅ"][Math.floor(Math.random()*3)]);
    if(nodes.every(n=>n.dead)){bg.classList.remove('dim');bg.classList.add('revealed');}
  }
  canvas.addEventListener('click',ev=>tryCollect(ev.clientX,ev.clientY));
  under.addEventListener('click',ev=>{
    const t=ev.target.closest('.clam');if(!t)return;
    const r=t.getBoundingClientRect();tryCollect(r.left+r.width/2,r.top+r.height/2);
  });

  // Âêπ„ÅçÂá∫„Åó
  function speak(msg){
    bubble.textContent=msg;bubble.classList.add('show');
    clearTimeout(speak._t);speak._t=setTimeout(()=>bubble.classList.remove('show'),1200);
  }

  // „Ç≠„É£„É©ËøΩÂæìÔºö„Çπ„É†„Éº„Ç∫ÔºãÊè∫„Çå
  let targetX=0,targetY=0,curX=0,curY=0;
  function trackMouse(mx,my){
    const rect=scene.getBoundingClientRect();
    const nx=(mx-rect.width/2)/rect.width;
    const ny=(my-rect.height*0.6)/rect.height;
    targetX=nx*rect.width*0.25;targetY=ny*rect.height*0.18;
  }
  function loop(){
    curX+=(targetX-curX)*0.08;curY+=(targetY-curY)*0.08;
    const wobbleX=Math.sin(Date.now()/600)*6;
    const wobbleY=Math.cos(Date.now()/800)*4;
    friendWrap.style.setProperty('--tx',`${(curX+wobbleX).toFixed(1)}px`);
    friendWrap.style.setProperty('--ty',`${(curY+wobbleY).toFixed(1)}px`);
    requestAnimationFrame(loop);
  }
  loop();

  // „Éú„Çø„É≥
  resetBtn.addEventListener('click',()=>{drawSandBase();placeClams();bg.classList.add('dim');bg.classList.remove('revealed');});
  backBtn.addEventListener('click',()=>location.href='index.html');
})();
</script>
</body>
</html>
