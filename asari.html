<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover,user-scalable=no" />
<title>WHO VQ — 潮干狩り</title>
<style>
  :root{
    --fg:#fff; --muted:#cfe3f7; --glass:rgba(0,0,0,.38);
    --accent:#ffd27a; --danger:#ff6b6b; --ok:#7aff9a;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family:system-ui,"Noto Sans JP","Hiragino Kaku Gothic ProN","Meiryo",sans-serif;
    background:#000;color:var(--fg);overflow:hidden;
  }

  .scene{position:relative; width:100vw; height:100vh; overflow:hidden;}
  /* 背景：画像が無くても見栄えする軽量グラデ */
  .bg{position:absolute; inset:0; z-index:0; background:
    linear-gradient(180deg,#0b2840 0%,#1f6a9a 34%,#2ea3bf 50%,#cdb893 65%,#b79362 100%);
  }
  /* 砂エリア：ここに掘りポイントを配置 */
  .sand-layer{position:absolute; left:0; right:0; bottom:0; height:52vh; z-index:2;
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.15));
    mask-image: linear-gradient(0deg, black 85%, transparent 100%);
  }

  /* 掘りポイント（見た目はさりげなく） */
  .dig-point{
    position:absolute; width:64px; height:44px; border-radius:999px; cursor:pointer;
    background:radial-gradient(closest-side, rgba(0,0,0,.22), rgba(0,0,0,.06) 60%, transparent 70%);
    transform:translate(-50%,-50%); transition:transform .12s ease;
    touch-action:manipulation; user-select:none;
  }
  .dig-point:hover{transform:translate(-50%,-50%) scale(1.03)}
  .dig-point.revealed{background:transparent; pointer-events:none;}

  .clam{
    position:absolute; left:50%; top:50%; width:42px; height:32px; transform:translate(-50%,-60%) scale(0.95);
    background-size:contain; background-repeat:no-repeat; background-position:center; filter:drop-shadow(0 2px 2px rgba(0,0,0,.45));
    opacity:0; transition:opacity .2s, transform .2s;
  }
  .clam.show{opacity:1; transform:translate(-50%,-62%) scale(1)}

  /* 右上の収穫バッジ（小型化） */
  .hud{
    position:fixed; top:env(safe-area-inset-top,8px); right:8px; z-index:5;
    display:flex; align-items:center; gap:8px; padding:6px 10px; border-radius:14px;
    background:var(--glass); backdrop-filter: blur(6px); font-size:14px;
  }
  .hud b{font-size:16px}
  .hint{position:fixed; left:50%; top:14px; transform:translateX(-50%); z-index:5; font-size:12px; opacity:.85}

  /* アクセ交換ボタン */
  .dock{
    position:fixed; left:50%; bottom:calc(env(safe-area-inset-bottom,10px) + 10px); transform:translateX(-50%); z-index:5;
    display:flex; gap:10px;
  }
  .btn{
    appearance:none; border:none; border-radius:14px; padding:10px 14px; cursor:pointer;
    background:linear-gradient(180deg, #ffe29a, #ffbf6b); color:#2b1b07; font-weight:700; font-size:14px;
    box-shadow:0 6px 18px rgba(0,0,0,.35); transition:.2s;
  }
  .btn:disabled{filter:saturate(.1) brightness(.8); cursor:not-allowed}
  .btn.ghost{background:rgba(255,255,255,.10); color:var(--fg); font-weight:500; border:1px solid rgba(255,255,255,.25)}

  /* キャラ：読み込み完了まで非表示。モバイルで切れないサイズ計算。 */
  .friend{
    position:absolute; left:50%; bottom:18vh; transform:translateX(-50%); z-index:3;
    height: min(38vh, 50vw); max-height: 42vh; max-width: 70vw; object-fit:contain;
    image-rendering:auto; filter:drop-shadow(0 8px 18px rgba(0,0,0,.45));
    opacity:0; transition:opacity .3s ease;
  }
  .friend.show{opacity:1}

  /* 小型端末ではさらに下げて全身を確実表示 */
  @media (max-width: 420px){
    .friend{ bottom: 20vh; height: min(34vh, 58vw); }
  }
  /* 縦が短い端末 */
  @media (max-height: 640px){
    .friend{ bottom: 16vh; height: min(30vh, 48vw); }
  }

  /* ふわっと浮遊（待機時） */
  @keyframes floatY{ 0%{transform:translate(-50%,0)} 50%{transform:translate(-50%,-4px)} 100%{transform:translate(-50%,0)} }
  .idle{ animation: floatY 3s ease-in-out infinite }

  /* トースト */
  .toast{
    position:fixed; left:50%; bottom:calc(env(safe-area-inset-bottom, 16px) + 64px); transform:translateX(-50%);
    background:rgba(0,0,0,.75); color:#fff; padding:10px 14px; border-radius:12px; font-size:13px; z-index:9;
    opacity:0; transition:opacity .2s, transform .2s;
  }
  .toast.show{opacity:1; transform:translateX(-50%) translateY(-4px)}
</style>
</head>
<body>
<div class="scene" id="scene">
  <div class="bg" aria-hidden="true"></div>
  <img id="friend" class="friend idle" alt="friend" />
  <div class="sand-layer" id="sand"></div>
</div>

<!-- HUD -->
<div class="hud" id="hud" role="status" aria-live="polite">
  <span>🐚</span><b id="count">0</b><span id="unit">個</span>
</div>
<div class="hint" id="hint">砂の盛り上がりをタップしてみよう</div>

<!-- Dock -->
<div class="dock">
  <button class="btn" id="exchangeBtn" disabled>アクセ交換（10個以上）</button>
  <button class="btn ghost" id="backBtn">戻る</button>
</div>

<div class="toast" id="toast"></div>

<script>
(function(){
  // ====== 設定 ======
  const LS_LAST = 'who_last_page';
  const LS_LANG = 'who_lang';
  const LS_CHAR = 'who_character'; // 'pink' | 'blue' | 'green' | 'purple' を想定
  const LS_CLAM = 'who_clams';     // 所持貝の累計（所持通貨のように扱う）
  const CLAM_IMAGE = 'public/assets/asari/clam.png'; // ←手元の配置に合わせて必要なら変更
  const FRIEND_PATH = (color)=>`public/assets/stage1/${color}_open.png`;

  // 掘りポイント生成
  const POINTS = 28;         // 砂の盛り上がり数
  const CLAM_RATE = 0.45;    // クラム出現率
  const CLAM_MIN_GUARANTEE = 6; // 「出ない」対策の最低保証

  // 交換条件
  const EXCHANGE_COST = 10;  // 10個以上で交換可能（未満は不可）

  // ====== 要素 ======
  const scene = document.getElementById('scene');
  const sand = document.getElementById('sand');
  const friend = document.getElementById('friend');
  const countEl = document.getElementById('count');
  const exchangeBtn = document.getElementById('exchangeBtn');
  const backBtn = document.getElementById('backBtn');
  const toast = document.getElementById('toast');

  // ====== 言語（最小限の文言切替） ======
  const lang = localStorage.getItem(LS_LANG) || 'ja';
  const text = {
    ja: {
      hint: '砂の盛り上がりをタップしてみよう',
      exchange:'アクセ交換（10個以上）',
      need_more:(n)=>`あと${n}個必要です`,
      got:'+1 個ゲット！',
      exchanged:'交換しました！',
      back:'戻る'
    },
    en: {
      hint: 'Tap the sand mounds.',
      exchange:'Exchange Accessory (10+)',
      need_more:(n)=>`${n} more needed`,
      got:'+1!',
      exchanged:'Exchanged!',
      back:'Back'
    }
  }[lang];
  document.getElementById('hint').textContent = text.hint;
  document.getElementById('unit').textContent = (lang==='ja'?'個':'');
  exchangeBtn.textContent = text.exchange;
  backBtn.textContent = text.back;

  // ====== ユーティリティ ======
  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add('show');
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toast.classList.remove('show'), 1200);
  }
  function easeMoveTo(el, x, y){
    // 友達を掘りポイントへ寄せる（簡易）
    el.style.transition = 'transform .28s ease';
    el.style.transform = `translateX(-50%) translateY(0)`;
    // 実座標から friend の translateX(-50%) を考慮して X だけ少し寄せる
    const sceneRect = scene.getBoundingClientRect();
    const ratioX = (x - sceneRect.width/2) / sceneRect.width;
    const dx = Math.max(-14, Math.min(14, ratioX * 60)); // -14〜14pxだけ寄る
    el.style.transform = `translateX(calc(-50% + ${dx}px))`;
    setTimeout(()=>{ el.style.transform = 'translateX(-50%)'; }, 300);
  }

  // ====== 所持数の管理（累計通貨） ======
  let total = parseInt(localStorage.getItem(LS_CLAM)||'0',10);
  function updateCountDisplay(){
    countEl.textContent = total;
    exchangeBtn.disabled = total < EXCHANGE_COST;
  }
  updateCountDisplay();

  // ====== キャラ読み込み（ロード済みだけ表示：切れないサイズ） ======
  (function loadFriend(){
    const color = localStorage.getItem(LS_CHAR) || 'pink';
    const src = FRIEND_PATH(color);
    friend.onload = ()=> friend.classList.add('show');
    friend.onerror = ()=> {
      // 画像が無い場合でも落ちない（ただしフォールバック絵は出さない）
      console.warn('friend image not found:', src);
    };
    friend.src = src;
  })();

  // ====== 掘りポイント生成（最低保証つき） ======
  (function buildPoints(){
    sand.innerHTML = '';
    const rect = sand.getBoundingClientRect();
    const points = [];
    let clamCount = 0;

    for(let i=0;i<POINTS;i++){
      const x = Math.random()*0.86 + 0.07; // 左右端を少し避ける
      const y = Math.random()*0.82 + 0.10; // 上端下端を避ける
      const hasClam = Math.random() < CLAM_RATE;
      if(hasClam) clamCount++;

      points.push({x,y,hasClam});
    }
    // 最低保証
    let need = Math.max(0, CLAM_MIN_GUARANTEE - clamCount);
    while(need>0){
      const idx = Math.floor(Math.random()*points.length);
      if(!points[idx].hasClam){
        points[idx].hasClam = true;
        need--;
      }
    }

    // DOM配置
    points.forEach(p=>{
      const dp = document.createElement('div');
      dp.className = 'dig-point';
      dp.style.left = (p.x*100)+'%';
      dp.style.top  = (p.y*100)+'%';

      if(p.hasClam){
        const clam = document.createElement('div');
        clam.className = 'clam';
        clam.style.backgroundImage = `url("${CLAM_IMAGE}")`;
        dp.appendChild(clam);
      }

      dp.addEventListener('click', (ev)=>{
        // 友達を寄せる
        easeMoveTo(friend, ev.clientX, ev.clientY);

        // 貝の有無で処理
        const clam = dp.querySelector('.clam');
        if(clam){
          clam.classList.add('show');
          // 小ジャンプ表現
          friend.classList.remove('idle');
          const old = friend.style.transition;
          friend.style.transition = 'transform .12s ease';
          friend.style.transform = 'translateX(-50%) translateY(-6px)';
          setTimeout(()=>{friend.style.transform='translateX(-50%)'},120);
          setTimeout(()=>friend.classList.add('idle'), 280);

          // 所持 +1
          total += 1;
          localStorage.setItem(LS_CLAM, String(total));
          updateCountDisplay();
          showToast(text.got);

          dp.classList.add('revealed');
          dp.style.pointerEvents = 'none';
        }else{
          dp.classList.add('revealed');
          showToast(lang==='ja'?'ハズレ…':'Empty…');
        }
      }, {passive:true});

      sand.appendChild(dp);
    });
  })();

  // ====== 交換処理（10個以上） ======
  exchangeBtn.addEventListener('click', ()=>{
    if(total < EXCHANGE_COST){
      showToast(text.need_more(EXCHANGE_COST - total));
      return;
    }
    // 消費
    total -= EXCHANGE_COST;
    localStorage.setItem(LS_CLAM, String(total));
    updateCountDisplay();
    showToast(text.exchanged);

    // ここで「アクセ付与」などの処理を書く想定：
    // 所持アクセ配列に push する／演出を出す等
    // 例: const owned = JSON.parse(localStorage.getItem('who_accessories')||'[]');
    // owned.push({id:`clam_${Date.now()}`, kind:'shell', power:1});
    // localStorage.setItem('who_accessories', JSON.stringify(owned));
  });

  // 戻る
  backBtn.addEventListener('click', ()=>{
    localStorage.setItem(LS_LAST, 'asari.html');
    // 必要に応じて戻り先を変更
    history.length>1 ? history.back() : location.href='index.html';
  });

  // このページを「最後のページ」として保存
  try{ localStorage.setItem(LS_LAST, 'asari.html'); }catch(e){}
})();
</script>
</body>
</html>
