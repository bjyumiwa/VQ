<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover,user-scalable=no"/>
<title>WHO VQ — 潮干狩り</title>
<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:sans-serif}
  .layer{position:absolute;inset:0}

  /* === 背景（時間帯で切替） === */
  .bg{z-index:0;pointer-events:none;background-size:cover;background-position:center;transition:opacity 1s ease;}
  .bg.day{background-image:url("public/items/bg/beach_day.jpg");}
  .bg.night{background-image:url("public/items/bg/night_beach.jpg");}
  .bg.sunrise{background-image:url("public/items/bg/sunrise.jpg");}

  /* 貝 */
  .clam{
    position:absolute;width:48px;height:48px;
    background:url("public/items/asari3.png") center/contain no-repeat;
    cursor:pointer;z-index:2;
    filter:drop-shadow(0 2px 2px rgba(0,0,0,.45));
    transition:opacity .2s ease, transform .2s ease;
  }
  .clam.collected{opacity:0;transform:scale(.5);pointer-events:none;}

  /* 砂 */
  #sandCanvas{z-index:3;touch-action:none;cursor:crosshair;}

  /* キャラ */
  .friend{
    position:absolute;left:50%;bottom:20%;transform:translateX(-50%);
    height:calc(min(38vh,50vw) * 0.7); /* 70%サイズ */
    max-height:40vh;max-width:60vw;z-index:4;
    filter:drop-shadow(0 8px 18px rgba(0,0,0,.45));
    opacity:0;transition:opacity .3s ease, transform .3s ease;
    animation:floatY 3s ease-in-out infinite;
  }
  .friend.show{opacity:1}
  @keyframes floatY{0%{transform:translate(-50%,0)}50%{transform:translate(-50%,-10px)}100%{transform:translate(-50%,0)}}

  /* 吹き出し */
  .bubble{
    position:absolute;bottom:100%;left:50%;transform:translate(-50%,-10px);
    background:rgba(255,255,255,.9);color:#000;padding:4px 8px;border-radius:12px;
    font-size:13px;white-space:nowrap;opacity:0;transition:opacity .3s ease;
    pointer-events:none;
  }
  .bubble.show{opacity:1}

  /* HUD */
  .hud{
    position:fixed;top:10px;right:10px;z-index:5;
    background:rgba(0,0,0,.5);color:#fff;padding:6px 10px;border-radius:12px;font-size:14px;
  }
</style>
</head>
<body>
<div id="bg" class="layer bg"></div>
<canvas class="layer" id="sandCanvas"></canvas>
<div id="clams"></div>
<div style="position:absolute;left:50%;bottom:18%;transform:translateX(-50%);z-index:5;">
  <img id="friend" class="friend" src="public/assets/stage1/pink_closed.png" alt="friend"/>
  <div id="bubble" class="bubble"></div>
</div>
<div class="hud">🐚 <span id="count">0</span></div>

<script>
(function(){
  const canvas=document.getElementById('sandCanvas');
  const ctx=canvas.getContext('2d');
  const clamsDiv=document.getElementById('clams');
  const friend=document.getElementById('friend');
  const bubble=document.getElementById('bubble');
  const countEl=document.getElementById('count');
  const bg=document.getElementById('bg');

  let W,H,total=0;

  // ==== 背景を時間帯で切替 ====
  function setBackground(){
    const h=new Date().getHours();
    if(h>=5 && h<9){ bg.className="layer bg sunrise"; }
    else if(h>=9 && h<18){ bg.className="layer bg day"; }
    else{ bg.className="layer bg night"; }
  }
  setBackground();

  // ==== サイズ設定 ====
  function resize(){
    W=canvas.width=innerWidth; H=canvas.height=innerHeight;
    drawSand();
    placeClams();
  }
  window.addEventListener('resize',resize);

  // ==== 砂 ====
  function drawSand(){
    ctx.fillStyle="#cdb893"; ctx.fillRect(0,0,W,H);
  }

  // ==== 貝配置 ====
  function placeClams(){
    clamsDiv.innerHTML="";
    for(let i=0;i<8;i++){
      const x=Math.random()*(W-60)+30;
      const y=Math.random()*(H*0.4)+H*0.3;
      const clam=document.createElement("div");
      clam.className="clam";
      clam.style.left=x+"px"; clam.style.top=y+"px";
      clam.addEventListener("click",()=>collectClam(clam,x,y));
      clamsDiv.appendChild(clam);
    }
  }

  // ==== 貝回収 ====
  function collectClam(clam,x,y){
    clam.classList.add("collected");
    setTimeout(()=>clam.remove(),300);
    total++; countEl.textContent=total;
    moveFriend(x,y);
  }

  // ==== キャラを貝に寄せる＋吹き出し ====
  function moveFriend(x,y){
    const rect=friend.getBoundingClientRect();
    const sceneRect=document.body.getBoundingClientRect();
    const dx=x-sceneRect.width/2;
    friend.style.transform=`translateX(calc(-50% + ${dx*0.2}px))`;
    showBubble(["ここだよ！","やったね！","ナイス！"][Math.floor(Math.random()*3)]);
    setTimeout(()=>{ friend.style.transform="translateX(-50%)"; },600);
  }

  // ==== 吹き出し ====
  function showBubble(msg){
    bubble.textContent=msg;
    bubble.classList.add("show");
    setTimeout(()=>bubble.classList.remove("show"),1000);
  }

  // ==== 初期化 ====
  friend.onload=()=>friend.classList.add("show");
  resize();
})();
</script>
</body>
</html>
