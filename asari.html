<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover,user-scalable=no" />
<title>WHO VQ — 潮干狩り（なでて見つける）</title>
<style>
  :root{
    --fg:#fff; --muted:#cfe3f7; --glass:rgba(0,0,0,.38);
    --accent:#ffd27a;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{background:#000;color:var(--fg);overflow:hidden;font-family:system-ui,"Noto Sans JP",sans-serif}

  /* 背景（初期は暗く、全部なでたら明るく表示） */
  .bg-img{
    position:fixed; inset:0; z-index:0; pointer-events:none;
    background:url("public/items/bg/beach_day.jpg") center/cover no-repeat;
    opacity:0.25; transition:opacity .8s ease;
  }
  .bg-img.revealed{ opacity:1; }

  .scene{position:relative; z-index:1; width:100vw; height:100vh; overflow:hidden;}

  /* 下層の貝 */
  .underlayer img{
    position:absolute; opacity:0; transition:opacity .2s ease;
    pointer-events:none;
  }

  /* 砂キャンバス */
  #sandCanvas{
    position:absolute; inset:0; z-index:2; cursor:crosshair;
    touch-action:none;
  }

  /* キャラ */
  .friend{
    position:absolute; left:50%; bottom:18vh; transform:translateX(-50%);
    z-index:3;
    height:min(38vh,50vw); max-height:44vh; max-width:70vw; object-fit:contain;
    filter:drop-shadow(0 8px 18px rgba(0,0,0,.45));
    opacity:0; transition:opacity .3s ease;
  }
  .friend.show{opacity:1}
  @keyframes floatY{0%{transform:translate(-50%,0)}50%{transform:translate(-50%,-4px)}100%{transform:translate(-50%,0)}}
  .idle{animation:floatY 3s ease-in-out infinite}

  /* HUD */
  .hud{
    position:fixed; top:8px; right:8px; z-index:5;
    background:var(--glass); backdrop-filter:blur(6px);
    padding:6px 10px; border-radius:14px; font-size:14px; display:flex; gap:6px;
  }
  .hud b{font-size:16px}

  /* ボタン */
  .dock{position:fixed; left:50%; bottom:16px; transform:translateX(-50%); z-index:5; display:flex; gap:10px}
  .btn{
    border:none; border-radius:14px; padding:10px 14px; cursor:pointer;
    background:linear-gradient(180deg,#ffde8a,#ffbf6b); color:#2b1b07; font-weight:700;
  }
  .ghost{background:rgba(255,255,255,.1); color:#fff}
  .btn:disabled{filter:saturate(.2) brightness(.7); cursor:not-allowed}

  .toast{position:fixed;left:50%;bottom:64px;transform:translateX(-50%);
    background:rgba(0,0,0,.75);color:#fff;padding:8px 12px;border-radius:10px;font-size:13px;opacity:0;transition:.2s}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}
</style>
</head>
<body>
<div class="bg-img" id="bg"></div>
<div class="scene" id="scene">
  <div class="underlayer" id="under"></div>
  <canvas id="sandCanvas"></canvas>
  <img id="friend" class="friend idle" alt="friend" />
</div>

<div class="hud"><span>🐚</span><b id="count">0</b><span>個</span></div>

<div class="dock">
  <button class="btn" id="exchangeBtn" disabled>アクセ交換（10個以上）</button>
  <button class="btn ghost" id="resetBtn">砂を元に戻す</button>
  <button class="btn ghost" id="backBtn">戻る</button>
</div>

<div class="toast" id="toast"></div>

<script>
(function(){
  const LS_CHAR='who_character', LS_CLAM='who_clams';
  const CLAM_IMG='public/items/asari3.png';
  const FRIEND_PATH=(color)=>`public/assets/stage1/${color}_closed.png`;
  const EXCHANGE_COST=10, BRUSH=28, CLAM_COUNT=15, CLEAR_RATIO=0.85;

  const under=document.getElementById('under'), canvas=document.getElementById('sandCanvas'), ctx=canvas.getContext('2d');
  const friend=document.getElementById('friend'), countEl=document.getElementById('count'), bg=document.getElementById('bg');
  const exchangeBtn=document.getElementById('exchangeBtn'), resetBtn=document.getElementById('resetBtn'), backBtn=document.getElementById('backBtn');
  const toast=document.getElementById('toast');

  let W=0,H=0,total=parseInt(localStorage.getItem(LS_CLAM)||'0',10),clams=[];

  function updateCount(){countEl.textContent=total;exchangeBtn.disabled=total<EXCHANGE_COST;}

  // キャラ表示
  const color=localStorage.getItem(LS_CHAR)||'pink';
  friend.src=FRIEND_PATH(color);
  friend.onload=()=>friend.classList.add('show');

  // 貝配置
  function placeClams(){
    under.innerHTML=''; clams=[];
    for(let i=0;i<CLAM_COUNT;i++){
      const x=Math.random()*(W-60)+30, y=Math.random()*(H-120)+60, s=32+Math.random()*20;
      const el=document.createElement('img'); el.src=CLAM_IMG; el.style.left=(x-s/2)+'px'; el.style.top=(y-s/2)+'px'; el.style.width=s+'px'; el.style.opacity=0;
      under.appendChild(el);
      clams.push({x,y,s,el,found:false});
    }
  }

  // 砂塗りつぶし
  function drawSand(){
    ctx.globalCompositeOperation='source-over';
    ctx.fillStyle='#cdb893';
    ctx.fillRect(0,0,W,H);
  }

  function resize(){
    W=canvas.width=innerWidth; H=canvas.height=innerHeight;
    drawSand(); placeClams(); bg.classList.remove('revealed');
  }
  window.addEventListener('resize',resize); resize();

  function erase(x,y){
    ctx.globalCompositeOperation='destination-out';
    ctx.beginPath(); ctx.arc(x,y,BRUSH,0,Math.PI*2); ctx.fill();
    for(const c of clams){
      if(!c.found && Math.abs(c.x-x)<BRUSH && Math.abs(c.y-y)<BRUSH){
        c.found=true; c.el.style.opacity=1;
        total++; localStorage.setItem(LS_CLAM,total); updateCount(); showToast('+1!');
      }
    }
  }

  let drawing=false;
  canvas.addEventListener('mousedown',e=>{drawing=true;erase(e.clientX,e.clientY);});
  canvas.addEventListener('mousemove',e=>{if(drawing)erase(e.clientX,e.clientY);});
  window.addEventListener('mouseup',()=>drawing=false);
  canvas.addEventListener('touchstart',e=>{drawing=true;const t=e.touches[0];erase(t.clientX,t.clientY);},{passive:false});
  canvas.addEventListener('touchmove',e=>{if(drawing){const t=e.touches[0];erase(t.clientX,t.clientY);}},{passive:false});
  window.addEventListener('touchend',()=>drawing=false);

  // 透明率チェック
  setInterval(()=>{
    const img=ctx.getImageData(0,0,W,H).data; let clear=0;
    for(let i=3;i<img.length;i+=32){if(img[i]<20)clear++;}
    if(clear/(img.length/32)>CLEAR_RATIO){bg.classList.add('revealed');}
  },1000);

  // 交換
  exchangeBtn.onclick=()=>{
    if(total<EXCHANGE_COST){showToast(`あと${EXCHANGE_COST-total}個必要`);return;}
    total-=EXCHANGE_COST; localStorage.setItem(LS_CLAM,total); updateCount(); showToast('交換しました！');
  };
  resetBtn.onclick=()=>{drawSand();placeClams();bg.classList.remove('revealed');};
  backBtn.onclick=()=>location.href='index.html';

  function showToast(msg){toast.textContent=msg;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),1200);}
  updateCount();
})();
</script>
</body>
</html>
