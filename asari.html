<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
  <title>WHO VQ — 潮干狩り</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Helvetica Neue','Arial','Hiragino Kaku Gothic ProN','Hiragino Sans','Meiryo',sans-serif;
      overflow:hidden;background:#000;color:#fff
    }
    .game-container{position:relative;width:100vw;height:100vh;overflow:hidden}
    .bg{position:absolute;inset:0;background-size:cover;background-position:center;background-repeat:no-repeat;transition:opacity .8s ease;z-index:0}
    canvas{position:absolute;inset:0;z-index:1;cursor:pointer}
    .char{position:absolute;bottom:10%;left:50%;transform:translateX(-50%);width:200px;z-index:2;animation:floatY 4s ease-in-out infinite}
    @keyframes floatY{0%,100%{transform:translate(-50%,0)}50%{transform:translate(-50%,-10px)}}
    .counter{position:absolute;top:10px;left:10px;z-index:3;padding:8px 12px;background:rgba(0,0,0,0.5);border-radius:8px;font-size:14px}
  </style>
</head>
<body>
  <div class="game-container">
    <div id="bg" class="bg"></div>
    <canvas id="sand"></canvas>
    <img id="char" class="char" src="" alt="char">
    <div class="counter" id="counter">🐚 0</div>
  </div>
  <script>
    // ========== 背景（時間帯で変化） ==========
    function setTimeBackground(){
      const hour=new Date().getHours();
      const bg=document.getElementById("bg");
      if(hour>=5 && hour<11){
        bg.style.background="linear-gradient(180deg,#87ceeb 0%,#ffe2b3 100%)";
      }else if(hour>=11 && hour<18){
        bg.style.background="linear-gradient(180deg,#63b3ff 0%,#c2f0ff 100%)";
      }else{
        bg.style.background="linear-gradient(180deg,#0b172a 0%,#03101f 100%)";
      }
    }

    // ========== キャラ反映 ==========
    function setCharacter(){
      const color=localStorage.getItem("who_character")||"pink";
      document.getElementById("char").src=`public/assets/stage1/${color}_open.png`;
    }

    // ========== 貝データ ==========
    const SHELLS=[
      {id:"asari1", img:"public/assets/shells/asari1.png", rarity:1},
      {id:"asari2", img:"public/assets/shells/asari2.png", rarity:1},
      {id:"asari3", img:"public/assets/shells/asari3.png", rarity:1},
      {id:"aurora_shell", img:"public/assets/shells/aurora_shell.png", rarity:2},
      {id:"luminous_shell", img:"public/assets/shells/luminous_shell.png", rarity:2},
      {id:"mystic_shell", img:"public/assets/shells/mystic_shell.png", rarity:2},
      {id:"flame_shell", img:"public/assets/shells/flame_shell.png", rarity:3},
      {id:"night_sky_shell", img:"public/assets/shells/night_sky_shell.png", rarity:3},
      {id:"rare_rainbow", img:"public/assets/shells/rare_rainbow.png", rarity:4},
      {id:"rare_pearl", img:"public/assets/shells/rare_pearl.png", rarity:5}
    ];

    // ========== ゲーム描画 ==========
    const canvas=document.getElementById("sand");
    const ctx=canvas.getContext("2d");
    let W,H;
    function resize(){W=canvas.width=window.innerWidth;H=canvas.height=window.innerHeight;}
    window.addEventListener("resize",resize);resize();

    let shells=[]; // 出現中の貝
    function spawnShells(){
      shells=[];
      for(let i=0;i<12;i++){
        const s=SHELLS[Math.floor(Math.random()*SHELLS.length)];
        shells.push({
          id:s.id,img:new Image(),x:Math.random()*W*0.8+W*0.1,y:Math.random()*H*0.5+H*0.4,found:false
        });
        shells[i].img.src=s.img;
      }
    }
    spawnShells();

    let collected=0;
    let inventory=JSON.parse(localStorage.getItem("shell_inventory")||"{}");

    function draw(){
      ctx.clearRect(0,0,W,H);
      shells.forEach(sh=>{
        if(!sh.found){
          ctx.drawImage(sh.img,sh.x-32,sh.y-32,64,64);
        }
      });
      requestAnimationFrame(draw);
    }
    draw();

    canvas.addEventListener("click",e=>{
      const mx=e.offsetX,my=e.offsetY;
      for(const sh of shells){
        if(!sh.found && mx>sh.x-32 && mx<sh.x+32 && my>sh.y-32 && my<sh.y+32){
          sh.found=true;
          collected++;
          inventory[sh.id]=(inventory[sh.id]||0)+1;
          localStorage.setItem("shell_inventory",JSON.stringify(inventory));
          document.getElementById("counter").textContent="🐚 "+collected;
          break;
        }
      }
      // 全部拾ったら次ページ
      if(shells.every(s=>s.found)){
        setTimeout(()=>{location.href="collection.html";},1000);
      }
    });

    // 初期化
    setTimeBackground();
    setCharacter();
  </script>
</body>
</html>
