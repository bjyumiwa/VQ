<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
  <title>WHO VQ â€” æ½®å¹²ç‹©ã‚Š</title>
  <style>
    body {
      margin: 0;
      font-family: "Hiragino Sans","Meiryo",sans-serif;
      background: url("public/items/bg/beach_day.jpg") no-repeat center/cover;
      height: 100vh;
      overflow: hidden;
    }
    .game-container {
      position: relative;
      width: 100%;
      height: 100%;
    }

    /* ã‚­ãƒ£ãƒ©è¡¨ç¤º */
    .character-area {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      pointer-events: none;
    }
    .character-area img {
      height: 40vh;
      width: auto;
      animation: sway 3s ease-in-out infinite;
      filter: drop-shadow(0 8px 6px rgba(0,0,0,0.4));
    }
    @keyframes sway {
      0%,100% { transform: translateX(-50%) rotate(-2deg); }
      50%     { transform: translateX(-50%) rotate(2deg); }
    }

    /* è² */
    .clam {
      position: absolute;
      width: 40px;
      height: 40px;
      background: url("public/assets/items/clam.png") no-repeat center/contain;
    }
    .clam.rare {
      background: url("public/assets/items/clam_gold.png") no-repeat center/contain;
    }

    /* HUD */
    .hud {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.5);
      color: #fff;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 14px;
    }

    /* æ“ä½œç”¨ãƒœã‚¿ãƒ³ */
    .controls {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .controls button {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      background: rgba(255,255,255,0.8);
    }
  </style>
</head>
<body>
  <div class="game-container" id="gameArea">
    <!-- HUD -->
    <div class="hud">
      ã‚¢ã‚µãƒª: <span id="clamCount">0</span>
      <br>
      ç§°å·: <span id="title">ãªã—</span>
    </div>

    <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
    <div class="controls">
      <button id="toggleChar">ã‚­ãƒ£ãƒ©è¡¨ç¤ºON/OFF</button>
      <button id="examMode">æ¤œå®šãƒ¢ãƒ¼ãƒ‰</button>
      <button id="releaseBtn">æµ·ã«è¿”ã™</button>
    </div>

    <!-- ã‚­ãƒ£ãƒ© -->
    <div class="character-area" id="charArea">
      <img id="charImg" src="" alt="ã‚­ãƒ£ãƒ©">
    </div>
  </div>

  <script>
    const LS_KEYS = {
      character: "who_character",
      clam: "who_clam",
      title: "who_title",
      unlocks: "who_unlocks"
    };

    const gameArea = document.getElementById("gameArea");
    const charImg = document.getElementById("charImg");
    const clamCountEl = document.getElementById("clamCount");
    const titleEl = document.getElementById("title");

    // --- ã‚­ãƒ£ãƒ©è¨­å®š ---
    const selectedChar = localStorage.getItem(LS_KEYS.character) || "pink";
    charImg.src = `public/assets/stage1/${selectedChar}_open.png`;

    // --- æ‰€æŒæ•°ãƒ»ç§°å·èª­ã¿è¾¼ã¿ ---
    let clamCount = parseInt(localStorage.getItem(LS_KEYS.clam) || "0", 10);
    let title = localStorage.getItem(LS_KEYS.title) || "ãªã—";
    let unlocks = JSON.parse(localStorage.getItem(LS_KEYS.unlocks) || "{}");
    clamCountEl.textContent = clamCount;
    titleEl.textContent = title;

    // --- è²ã‚’å‡ºã™å‡¦ç† ---
    function spawnClam(x, y) {
      if (Math.random() > 0.25) return; // å‡ºç¾ç‡25%ãã‚‰ã„ã§ã€Œãªã‹ãªã‹é›†ã¾ã‚‰ãªã„ã€æ„Ÿã˜ã«

      const clam = document.createElement("div");
      clam.classList.add("clam");

      // ãƒ¬ã‚¢è²åˆ¤å®šï¼ˆ5%ï¼‰
      const isRare = Math.random() < 0.05;
      if (isRare) clam.classList.add("rare");

      clam.style.left = x - 20 + "px";
      clam.style.top = y - 20 + "px";
      gameArea.appendChild(clam);

      clam.addEventListener("click", () => {
        clam.remove();
        const add = isRare ? 3 : 1;
        clamCount += add;
        clamCountEl.textContent = clamCount;
        localStorage.setItem(LS_KEYS.clam, clamCount);
        checkUnlocks();
      });
    }

    // --- ç ‚ã‚’ãªã§ã‚‹ ---
    let dragging = false;
    function handleMove(e) {
      const x = e.touches ? e.touches[0].clientX : e.clientX;
      const y = e.touches ? e.touches[0].clientY : e.clientY;
      if (dragging) spawnClam(x, y);
    }
    gameArea.addEventListener("mousedown", () => dragging = true);
    gameArea.addEventListener("mouseup", () => dragging = false);
    gameArea.addEventListener("mousemove", handleMove);
    gameArea.addEventListener("touchstart", () => dragging = true);
    gameArea.addEventListener("touchend", () => dragging = false);
    gameArea.addEventListener("touchmove", handleMove);

    // --- ç‰¹å…¸è§£æ”¾ ---
    function checkUnlocks() {
      if (clamCount >= 10 && !unlocks.accessory) {
        unlocks.accessory = true;
        alert("ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ãŒè§£æ”¾ã•ã‚Œã¾ã—ãŸï¼");
      }
      if (clamCount >= 30 && !unlocks.conversation) {
        unlocks.conversation = true;
        alert("å¤œã®ä¼šè©±ãŒè§£æ”¾ã•ã‚Œã¾ã—ãŸï¼");
      }
      localStorage.setItem(LS_KEYS.unlocks, JSON.stringify(unlocks));
    }

    // --- æ¤œå®šãƒ¢ãƒ¼ãƒ‰ ---
    document.getElementById("examMode").addEventListener("click", () => {
      let examCount = 0;
      let time = 20;
      alert("æ¤œå®šãƒ¢ãƒ¼ãƒ‰é–‹å§‹ï¼20ç§’ä»¥å†…ã«10å€‹å–ã‚ã†ï¼");
      const timer = setInterval(() => {
        time--;
        if (time <= 0) {
          clearInterval(timer);
          if (examCount >= 10) {
            title = "ã‚¢ã‚µãƒªå–ã‚Šåäººï¼‘ç´š";
            localStorage.setItem(LS_KEYS.title, title);
            titleEl.textContent = title;
            alert("åˆæ ¼ï¼ç§°å·ã€Œã‚¢ã‚µãƒªå–ã‚Šåäººï¼‘ç´šã€ç²å¾—ï¼");
          } else {
            alert("æ®‹å¿µï¼ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã¦ã¿ã‚ˆã†ã€‚");
          }
        }
      }, 1000);

      // ä¸€æ™‚çš„ã«å›åæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
      const handler = () => { examCount++; };
      gameArea.addEventListener("clamCollected", handler);

      setTimeout(() => {
        gameArea.removeEventListener("clamCollected", handler);
      }, 20000);
    });

    // --- æµ·ã«è¿”ã™ ---
    document.getElementById("releaseBtn").addEventListener("click", () => {
      if (clamCount <= 0) { alert("è¿”ã›ã‚‹ã‚¢ã‚µãƒªãŒã‚ã‚Šã¾ã›ã‚“"); return; }
      const release = Math.max(1, Math.floor(clamCount * 0.2)); // 2å‰²ãã‚‰ã„è¿”ã™
      clamCount -= release;
      clamCountEl.textContent = clamCount;
      localStorage.setItem(LS_KEYS.clam, clamCount);
      alert(`${release}å€‹ã®ã‚¢ã‚µãƒªã‚’æµ·ã«è¿”ã—ã¾ã—ãŸğŸŒŠ`);
    });

    // --- ã‚­ãƒ£ãƒ©è¡¨ç¤ºON/OFF ---
    const charArea = document.getElementById("charArea");
    document.getElementById("toggleChar").addEventListener("click", () => {
      charArea.style.display = (charArea.style.display === "none") ? "block" : "none";
    });
  </script>
</body>
</html>
