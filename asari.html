<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>WHO VQ — 潮干狩り</title>
<style>
  html, body { height:100%; margin:0; font-family:"Hiragino Sans","Meiryo",sans-serif; }
  body {
    background: url("public/items/bg/beach_day.jpg") center/cover no-repeat fixed;
    overflow: hidden;
  }
  .game { position:relative; width:100%; height:100%; }

  /* 砂ゾーン */
  .sand {
    position:absolute; left:0; right:0; bottom:0; height:40%;
    background: url("public/items/sand.png") center/cover no-repeat;
    touch-action: none; pointer-events:auto; z-index:2;
    cursor: grab;
  }
  .sand:active { cursor: grabbing; }

  /* 貝（砂の下から出る演出） */
  .clams { position:absolute; inset:0; z-index:1; pointer-events:none; }
  .clam {
    position:absolute; width:64px; height:64px;
    background-size:contain; background-repeat:no-repeat;
    pointer-events:auto; transform: translateY(20px) scale(0.7);
    opacity:0;
    transition: transform 0.8s ease, opacity 0.8s ease;
  }
  .clam.revealed {
    transform: translateY(0) scale(1);
    opacity:1;
  }
  .clam:hover { transform: scale(1.05); cursor:pointer; }

  /* キャラ */
  .char-wrap{
    position:absolute; z-index:3; height:22vh; aspect-ratio:1/1; pointer-events:none;
    filter: drop-shadow(0 14px 12px rgba(0,0,0,.55));
    transform-origin:50% 90%;
    animation:sway 4.2s ease-in-out infinite, breathe 3s ease-in-out infinite;
    transition:left 1.2s ease, top 1.2s ease;
  }
  .char-wrap img{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain; }

  @keyframes sway { 0%,100%{transform:rotate(-2deg);} 50%{transform:rotate(2deg);} }
  @keyframes breathe{
    0%,100%{ filter: drop-shadow(0 14px 12px rgba(0,0,0,.55)) brightness(1); }
    50%    { filter: drop-shadow(0 18px 14px rgba(0,0,0,.50)) brightness(1.03); }
  }
  .picking{ animation: pick .45s ease forwards; }
  @keyframes pick{ 0%{transform:scale(1);} 50%{transform:scale(.9);} 100%{transform:scale(1);} }

  /* HUD */
  .hud{ position:absolute; top:10px; left:10px; z-index:5; background:rgba(0,0,0,.55); color:#fff;
        padding:8px 10px; border-radius:8px; font-size:14px; user-select:none; }

  .toast{ position:absolute; left:50%; top:14%; transform:translateX(-50%); z-index:6; background:rgba(0,0,0,.65);
          color:#fff; padding:6px 10px; border-radius:8px; font-size:13px; opacity:0; transition:opacity .25s ease; }
  .toast.show{ opacity:1; }

  /* 砂なで効果 */
  .sand-effect {
    position:absolute; width:28px; height:28px; border-radius:50%;
    background: radial-gradient(circle, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 70%);
    pointer-events:none; animation:ripple 0.6s ease-out forwards; z-index:3;
  }
  @keyframes ripple { 0%{transform:scale(0.5);opacity:.8;} 100%{transform:scale(2);opacity:0;} }
</style>
</head>
<body>
<div class="game">
  <div class="clams" id="clams"></div>
  <div class="sand" id="sand"></div>

  <div class="char-wrap" id="charWrap">
    <img id="charImg" alt="キャラ">
  </div>

  <div class="hud">アサリ: <span id="cnt">0</span></div>
  <div class="toast" id="toast"></div>
</div>

<script>
  const LS = { clam:"who_clam", character:"who_character" };
  const sand = document.getElementById('sand');
  const clamsLayer = document.getElementById('clams');
  const charWrap = document.getElementById('charWrap');
  const charImg = document.getElementById('charImg');
  const hudCnt = document.getElementById('cnt');
  const toast = document.getElementById('toast');

  let count = parseInt(localStorage.getItem(LS.clam) || '0',10);
  hudCnt.textContent = count;

  const charKey = localStorage.getItem(LS.character) || 'pink';
  charImg.src = `public/assets/stage1/${charKey}_open.png`;

  function setCharPos(x,y){ charWrap.style.left=x+'px'; charWrap.style.top=y+'px'; }
  window.addEventListener('load',()=>{
    setCharPos(innerWidth*0.5 - 60, innerHeight*0.55);
  });

  /* シェル（低確率） */
  const SHELLS = [
    { src:"public/items/asari1.png", prob:0.45, value:1, name:"アサリ" },
    { src:"public/items/asari2.png", prob:0.30, value:1, name:"アサリ" },
    { src:"public/items/aurora_shell.png", prob:0.15, value:2, name:"オーロラ貝" },
    { src:"public/items/rare_rainbow.png", prob:0.1, value:5, name:"虹色貝" }
  ];
  function chooseShell(){
    let r=Math.random(), acc=0;
    for(const s of SHELLS){ acc+=s.prob; if(r<acc) return s; }
    return SHELLS[0];
  }

  /* なでて出現 */
  let stroking=false,lastEmit=0;
  sand.addEventListener('pointerdown',e=>{
    stroking=true; sand.setPointerCapture(e.pointerId);
  });
  sand.addEventListener('pointerup',()=>stroking=false);
  sand.addEventListener('pointermove',e=>{
    if(!stroking) return;
    const now=performance.now();
    if(now-lastEmit>400 && Math.random()<0.2){ // 出にくい
      lastEmit=now;
      spawnClam(e.clientX,e.clientY);
    }
    ripple(e.clientX,e.clientY);
  });

  function ripple(x,y){
    const fx=document.createElement('div');
    fx.className='sand-effect';
    fx.style.left=(x-14)+'px';
    fx.style.top=(y-14)+'px';
    sand.appendChild(fx);
    setTimeout(()=>fx.remove(),600);
  }

  function spawnClam(x,y){
    const s=chooseShell();
    const d=document.createElement('div');
    d.className='clam';
    d.style.backgroundImage=`url('${s.src}')`;
    d.style.left=(x-32)+'px'; d.style.top=(y-32)+'px';
    d.dataset.value=s.value; d.dataset.name=s.name;
    clamsLayer.appendChild(d);
    // 少し遅れて砂から出現
    setTimeout(()=>d.classList.add('revealed'),100);

    d.addEventListener('click',()=>pickClam(d,parseInt(d.dataset.value,10),d.dataset.name),{once:true});
  }

  function pickClam(el,value,name){
    charWrap.classList.add("picking");
    setTimeout(()=>charWrap.classList.remove("picking"),400);
    el.remove();
    count+=value;
    hudCnt.textContent=count;
    localStorage.setItem(LS.clam,count);
    showToast(`${name} +${value}`);
  }

  function showToast(msg){
    toast.textContent=msg;
    toast.classList.add('show');
    clearTimeout(showToast._t);
    toast._t=setTimeout(()=>toast.classList.remove('show'),1200);
  }
</script>
</body>
</html>
