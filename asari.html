<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover,user-scalable=no" />
<title>WHO VQ â€” æ½®å¹²ç‹©ã‚Š</title>
<style>
  :root{
    --fg:#fff; --muted:#cfe3f7; --glass:rgba(0,0,0,.38);
    --accent:#ffd27a; --danger:#ff6b6b; --ok:#7aff9a;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family:system-ui,"Noto Sans JP","Hiragino Kaku Gothic ProN","Meiryo",sans-serif;
    background:#000;color:var(--fg);overflow:hidden;
  }

  .scene{position:relative; width:100vw; height:100vh; overflow:hidden;}
  /* èƒŒæ™¯ï¼šç”»åƒãŒç„¡ãã¦ã‚‚è¦‹æ „ãˆã™ã‚‹è»½é‡ã‚°ãƒ©ãƒ‡ */
  .bg{position:absolute; inset:0; z-index:0; background:
    linear-gradient(180deg,#0b2840 0%,#1f6a9a 34%,#2ea3bf 50%,#cdb893 65%,#b79362 100%);
  }
  /* ç ‚ã‚¨ãƒªã‚¢ï¼šã“ã“ã«æ˜ã‚Šãƒã‚¤ãƒ³ãƒˆã‚’é…ç½® */
  .sand-layer{position:absolute; left:0; right:0; bottom:0; height:52vh; z-index:2;
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.15));
    mask-image: linear-gradient(0deg, black 85%, transparent 100%);
  }

  /* æ˜ã‚Šãƒã‚¤ãƒ³ãƒˆï¼ˆè¦‹ãŸç›®ã¯ã•ã‚Šã’ãªãï¼‰ */
  .dig-point{
    position:absolute; width:64px; height:44px; border-radius:999px; cursor:pointer;
    background:radial-gradient(closest-side, rgba(0,0,0,.22), rgba(0,0,0,.06) 60%, transparent 70%);
    transform:translate(-50%,-50%); transition:transform .12s ease;
    touch-action:manipulation; user-select:none;
  }
  .dig-point:hover{transform:translate(-50%,-50%) scale(1.03)}
  .dig-point.revealed{background:transparent; pointer-events:none;}

  .clam{
    position:absolute; left:50%; top:50%; width:42px; height:32px; transform:translate(-50%,-60%) scale(0.95);
    background-size:contain; background-repeat:no-repeat; background-position:center; filter:drop-shadow(0 2px 2px rgba(0,0,0,.45));
    opacity:0; transition:opacity .2s, transform .2s;
  }
  .clam.show{opacity:1; transform:translate(-50%,-62%) scale(1)}

  /* å³ä¸Šã®åç©«ãƒãƒƒã‚¸ï¼ˆå°å‹åŒ–ï¼‰ */
  .hud{
    position:fixed; top:env(safe-area-inset-top,8px); right:8px; z-index:5;
    display:flex; align-items:center; gap:8px; padding:6px 10px; border-radius:14px;
    background:var(--glass); backdrop-filter: blur(6px); font-size:14px;
  }
  .hud b{font-size:16px}
  .hint{position:fixed; left:50%; top:14px; transform:translateX(-50%); z-index:5; font-size:12px; opacity:.85}

  /* ã‚¢ã‚¯ã‚»äº¤æ›ãƒœã‚¿ãƒ³ */
  .dock{
    position:fixed; left:50%; bottom:calc(env(safe-area-inset-bottom,10px) + 10px); transform:translateX(-50%); z-index:5;
    display:flex; gap:10px;
  }
  .btn{
    appearance:none; border:none; border-radius:14px; padding:10px 14px; cursor:pointer;
    background:linear-gradient(180deg, #ffe29a, #ffbf6b); color:#2b1b07; font-weight:700; font-size:14px;
    box-shadow:0 6px 18px rgba(0,0,0,.35); transition:.2s;
  }
  .btn:disabled{filter:saturate(.1) brightness(.8); cursor:not-allowed}
  .btn.ghost{background:rgba(255,255,255,.10); color:var(--fg); font-weight:500; border:1px solid rgba(255,255,255,.25)}

  /* ã‚­ãƒ£ãƒ©ï¼šèª­ã¿è¾¼ã¿å®Œäº†ã¾ã§éè¡¨ç¤ºã€‚ãƒ¢ãƒã‚¤ãƒ«ã§åˆ‡ã‚Œãªã„ã‚µã‚¤ã‚ºè¨ˆç®—ã€‚ */
  .friend{
    position:absolute; left:50%; bottom:18vh; transform:translateX(-50%); z-index:3;
    height: min(38vh, 50vw); max-height: 42vh; max-width: 70vw; object-fit:contain;
    image-rendering:auto; filter:drop-shadow(0 8px 18px rgba(0,0,0,.45));
    opacity:0; transition:opacity .3s ease;
  }
  .friend.show{opacity:1}

  /* å°å‹ç«¯æœ«ã§ã¯ã•ã‚‰ã«ä¸‹ã’ã¦å…¨èº«ã‚’ç¢ºå®Ÿè¡¨ç¤º */
  @media (max-width: 420px){
    .friend{ bottom: 20vh; height: min(34vh, 58vw); }
  }
  /* ç¸¦ãŒçŸ­ã„ç«¯æœ« */
  @media (max-height: 640px){
    .friend{ bottom: 16vh; height: min(30vh, 48vw); }
  }

  /* ãµã‚ã£ã¨æµ®éŠï¼ˆå¾…æ©Ÿæ™‚ï¼‰ */
  @keyframes floatY{ 0%{transform:translate(-50%,0)} 50%{transform:translate(-50%,-4px)} 100%{transform:translate(-50%,0)} }
  .idle{ animation: floatY 3s ease-in-out infinite }

  /* ãƒˆãƒ¼ã‚¹ãƒˆ */
  .toast{
    position:fixed; left:50%; bottom:calc(env(safe-area-inset-bottom, 16px) + 64px); transform:translateX(-50%);
    background:rgba(0,0,0,.75); color:#fff; padding:10px 14px; border-radius:12px; font-size:13px; z-index:9;
    opacity:0; transition:opacity .2s, transform .2s;
  }
  .toast.show{opacity:1; transform:translateX(-50%) translateY(-4px)}
</style>
</head>
<body>
<div class="scene" id="scene">
  <div class="bg" aria-hidden="true"></div>
  <img id="friend" class="friend idle" alt="friend" />
  <div class="sand-layer" id="sand"></div>
</div>

<!-- HUD -->
<div class="hud" id="hud" role="status" aria-live="polite">
  <span>ğŸš</span><b id="count">0</b><span id="unit">å€‹</span>
</div>
<div class="hint" id="hint">ç ‚ã®ç››ã‚Šä¸ŠãŒã‚Šã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã¿ã‚ˆã†</div>

<!-- Dock -->
<div class="dock">
  <button class="btn" id="exchangeBtn" disabled>ã‚¢ã‚¯ã‚»äº¤æ›ï¼ˆ10å€‹ä»¥ä¸Šï¼‰</button>
  <button class="btn ghost" id="backBtn">æˆ»ã‚‹</button>
</div>

<div class="toast" id="toast"></div>

<script>
(function(){
  // ====== è¨­å®š ======
  const LS_LAST = 'who_last_page';
  const LS_LANG = 'who_lang';
  const LS_CHAR = 'who_character'; // 'pink' | 'blue' | 'green' | 'purple' ã‚’æƒ³å®š
  const LS_CLAM = 'who_clams';     // æ‰€æŒè²ã®ç´¯è¨ˆï¼ˆæ‰€æŒé€šè²¨ã®ã‚ˆã†ã«æ‰±ã†ï¼‰
  const CLAM_IMAGE = 'public/assets/asari/clam.png'; // â†æ‰‹å…ƒã®é…ç½®ã«åˆã‚ã›ã¦å¿…è¦ãªã‚‰å¤‰æ›´
  const FRIEND_PATH = (color)=>`public/assets/stage1/${color}_open.png`;

  // æ˜ã‚Šãƒã‚¤ãƒ³ãƒˆç”Ÿæˆ
  const POINTS = 28;         // ç ‚ã®ç››ã‚Šä¸ŠãŒã‚Šæ•°
  const CLAM_RATE = 0.45;    // ã‚¯ãƒ©ãƒ å‡ºç¾ç‡
  const CLAM_MIN_GUARANTEE = 6; // ã€Œå‡ºãªã„ã€å¯¾ç­–ã®æœ€ä½ä¿è¨¼

  // äº¤æ›æ¡ä»¶
  const EXCHANGE_COST = 10;  // 10å€‹ä»¥ä¸Šã§äº¤æ›å¯èƒ½ï¼ˆæœªæº€ã¯ä¸å¯ï¼‰

  // ====== è¦ç´  ======
  const scene = document.getElementById('scene');
  const sand = document.getElementById('sand');
  const friend = document.getElementById('friend');
  const countEl = document.getElementById('count');
  const exchangeBtn = document.getElementById('exchangeBtn');
  const backBtn = document.getElementById('backBtn');
  const toast = document.getElementById('toast');

  // ====== è¨€èªï¼ˆæœ€å°é™ã®æ–‡è¨€åˆ‡æ›¿ï¼‰ ======
  const lang = localStorage.getItem(LS_LANG) || 'ja';
  const text = {
    ja: {
      hint: 'ç ‚ã®ç››ã‚Šä¸ŠãŒã‚Šã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã¿ã‚ˆã†',
      exchange:'ã‚¢ã‚¯ã‚»äº¤æ›ï¼ˆ10å€‹ä»¥ä¸Šï¼‰',
      need_more:(n)=>`ã‚ã¨${n}å€‹å¿…è¦ã§ã™`,
      got:'+1 å€‹ã‚²ãƒƒãƒˆï¼',
      exchanged:'äº¤æ›ã—ã¾ã—ãŸï¼',
      back:'æˆ»ã‚‹'
    },
    en: {
      hint: 'Tap the sand mounds.',
      exchange:'Exchange Accessory (10+)',
      need_more:(n)=>`${n} more needed`,
      got:'+1!',
      exchanged:'Exchanged!',
      back:'Back'
    }
  }[lang];
  document.getElementById('hint').textContent = text.hint;
  document.getElementById('unit').textContent = (lang==='ja'?'å€‹':'');
  exchangeBtn.textContent = text.exchange;
  backBtn.textContent = text.back;

  // ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add('show');
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toast.classList.remove('show'), 1200);
  }
  function easeMoveTo(el, x, y){
    // å‹é”ã‚’æ˜ã‚Šãƒã‚¤ãƒ³ãƒˆã¸å¯„ã›ã‚‹ï¼ˆç°¡æ˜“ï¼‰
    el.style.transition = 'transform .28s ease';
    el.style.transform = `translateX(-50%) translateY(0)`;
    // å®Ÿåº§æ¨™ã‹ã‚‰ friend ã® translateX(-50%) ã‚’è€ƒæ…®ã—ã¦ X ã ã‘å°‘ã—å¯„ã›ã‚‹
    const sceneRect = scene.getBoundingClientRect();
    const ratioX = (x - sceneRect.width/2) / sceneRect.width;
    const dx = Math.max(-14, Math.min(14, ratioX * 60)); // -14ã€œ14pxã ã‘å¯„ã‚‹
    el.style.transform = `translateX(calc(-50% + ${dx}px))`;
    setTimeout(()=>{ el.style.transform = 'translateX(-50%)'; }, 300);
  }

  // ====== æ‰€æŒæ•°ã®ç®¡ç†ï¼ˆç´¯è¨ˆé€šè²¨ï¼‰ ======
  let total = parseInt(localStorage.getItem(LS_CLAM)||'0',10);
  function updateCountDisplay(){
    countEl.textContent = total;
    exchangeBtn.disabled = total < EXCHANGE_COST;
  }
  updateCountDisplay();

  // ====== ã‚­ãƒ£ãƒ©èª­ã¿è¾¼ã¿ï¼ˆãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã ã‘è¡¨ç¤ºï¼šåˆ‡ã‚Œãªã„ã‚µã‚¤ã‚ºï¼‰ ======
  (function loadFriend(){
    const color = localStorage.getItem(LS_CHAR) || 'pink';
    const src = FRIEND_PATH(color);
    friend.onload = ()=> friend.classList.add('show');
    friend.onerror = ()=> {
      // ç”»åƒãŒç„¡ã„å ´åˆã§ã‚‚è½ã¡ãªã„ï¼ˆãŸã ã—ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯çµµã¯å‡ºã•ãªã„ï¼‰
      console.warn('friend image not found:', src);
    };
    friend.src = src;
  })();

  // ====== æ˜ã‚Šãƒã‚¤ãƒ³ãƒˆç”Ÿæˆï¼ˆæœ€ä½ä¿è¨¼ã¤ãï¼‰ ======
  (function buildPoints(){
    sand.innerHTML = '';
    const rect = sand.getBoundingClientRect();
    const points = [];
    let clamCount = 0;

    for(let i=0;i<POINTS;i++){
      const x = Math.random()*0.86 + 0.07; // å·¦å³ç«¯ã‚’å°‘ã—é¿ã‘ã‚‹
      const y = Math.random()*0.82 + 0.10; // ä¸Šç«¯ä¸‹ç«¯ã‚’é¿ã‘ã‚‹
      const hasClam = Math.random() < CLAM_RATE;
      if(hasClam) clamCount++;

      points.push({x,y,hasClam});
    }
    // æœ€ä½ä¿è¨¼
    let need = Math.max(0, CLAM_MIN_GUARANTEE - clamCount);
    while(need>0){
      const idx = Math.floor(Math.random()*points.length);
      if(!points[idx].hasClam){
        points[idx].hasClam = true;
        need--;
      }
    }

    // DOMé…ç½®
    points.forEach(p=>{
      const dp = document.createElement('div');
      dp.className = 'dig-point';
      dp.style.left = (p.x*100)+'%';
      dp.style.top  = (p.y*100)+'%';

      if(p.hasClam){
        const clam = document.createElement('div');
        clam.className = 'clam';
        clam.style.backgroundImage = `url("${CLAM_IMAGE}")`;
        dp.appendChild(clam);
      }

      dp.addEventListener('click', (ev)=>{
        // å‹é”ã‚’å¯„ã›ã‚‹
        easeMoveTo(friend, ev.clientX, ev.clientY);

        // è²ã®æœ‰ç„¡ã§å‡¦ç†
        const clam = dp.querySelector('.clam');
        if(clam){
          clam.classList.add('show');
          // å°ã‚¸ãƒ£ãƒ³ãƒ—è¡¨ç¾
          friend.classList.remove('idle');
          const old = friend.style.transition;
          friend.style.transition = 'transform .12s ease';
          friend.style.transform = 'translateX(-50%) translateY(-6px)';
          setTimeout(()=>{friend.style.transform='translateX(-50%)'},120);
          setTimeout(()=>friend.classList.add('idle'), 280);

          // æ‰€æŒ +1
          total += 1;
          localStorage.setItem(LS_CLAM, String(total));
          updateCountDisplay();
          showToast(text.got);

          dp.classList.add('revealed');
          dp.style.pointerEvents = 'none';
        }else{
          dp.classList.add('revealed');
          showToast(lang==='ja'?'ãƒã‚ºãƒ¬â€¦':'Emptyâ€¦');
        }
      }, {passive:true});

      sand.appendChild(dp);
    });
  })();

  // ====== äº¤æ›å‡¦ç†ï¼ˆ10å€‹ä»¥ä¸Šï¼‰ ======
  exchangeBtn.addEventListener('click', ()=>{
    if(total < EXCHANGE_COST){
      showToast(text.need_more(EXCHANGE_COST - total));
      return;
    }
    // æ¶ˆè²»
    total -= EXCHANGE_COST;
    localStorage.setItem(LS_CLAM, String(total));
    updateCountDisplay();
    showToast(text.exchanged);

    // ã“ã“ã§ã€Œã‚¢ã‚¯ã‚»ä»˜ä¸ã€ãªã©ã®å‡¦ç†ã‚’æ›¸ãæƒ³å®šï¼š
    // æ‰€æŒã‚¢ã‚¯ã‚»é…åˆ—ã« push ã™ã‚‹ï¼æ¼”å‡ºã‚’å‡ºã™ç­‰
    // ä¾‹: const owned = JSON.parse(localStorage.getItem('who_accessories')||'[]');
    // owned.push({id:`clam_${Date.now()}`, kind:'shell', power:1});
    // localStorage.setItem('who_accessories', JSON.stringify(owned));
  });

  // æˆ»ã‚‹
  backBtn.addEventListener('click', ()=>{
    localStorage.setItem(LS_LAST, 'asari.html');
    // å¿…è¦ã«å¿œã˜ã¦æˆ»ã‚Šå…ˆã‚’å¤‰æ›´
    history.length>1 ? history.back() : location.href='index.html';
  });

  // ã“ã®ãƒšãƒ¼ã‚¸ã‚’ã€Œæœ€å¾Œã®ãƒšãƒ¼ã‚¸ã€ã¨ã—ã¦ä¿å­˜
  try{ localStorage.setItem(LS_LAST, 'asari.html'); }catch(e){}
})();
</script>
</body>
</html>
