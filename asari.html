<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>WHO VQ — 潮干狩り（asari）</title>
<style>
  :root { --bg-brightness: 1; --ui-bg: rgba(0,0,0,.35); --card-bg: rgba(0,0,0,.5); }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;background:#000;color:#fff;font-family:system-ui,"Noto Sans JP",sans-serif;overscroll-behavior:none}
  .game{position:relative;width:100vw;height:100vh;overflow:hidden;touch-action:none;cursor:crosshair}

  /* タップ青ハイライト・選択/ドラッグ無効（iOS対策） */
  html, body, .game, img, .shell, button { -webkit-tap-highlight-color: transparent; }
  img, .shell { -webkit-user-drag:none; user-drag:none; -webkit-user-select:none; user-select:none; outline:none; }
  #friendWrap, #friend, .equip, #accLayer { pointer-events:none; -webkit-touch-callout:none; }

  /* 背景（2レイヤ） */
  .bg, .bg2{
    position:absolute;inset:0;z-index:0;background-size:cover;background-position:center;
    filter:brightness(var(--bg-brightness));transition:opacity .9s ease, filter .6s ease;opacity:1;
  }
  .bg{ background-image:url("public/items/bg/beach_day.jpg"); }
  .bg2{ background-image:url("public/items/bg/beach_clear.jpg"); opacity:0; }
  .bg2.show{ opacity:1; }

  /* UI */
  #topbar{
    position:absolute;left:0;right:0;top:0;z-index:10;display:flex;gap:8px;align-items:center;justify-content:space-between;
    padding:10px;background:linear-gradient(180deg,rgba(0,0,0,.45),rgba(0,0,0,0))
  }
  .pill{background:var(--ui-bg);border:1px solid rgba(255,255,255,.15);padding:6px 10px;border-radius:999px;backdrop-filter:blur(6px);display:inline-flex;gap:8px;align-items:center}
  .btn{background:var(--card-bg);border:1px solid rgba(255,255,255,.15);padding:8px 12px;border-radius:10px;color:#fff;cursor:pointer;user-select:none}
  .btn:hover{background:rgba(255,255,255,.08)}
  #counter b{font-variant-numeric:tabular-nums}

  /* 砂＆貝 */
  #shellLayer{position:absolute;inset:0;z-index:2}
  .shell{
    position:absolute;width:52px;height:52px;object-fit:contain;
    filter:drop-shadow(0 2px 4px rgba(0,0,0,.35));
    transition:transform .25s ease, opacity .25s ease; cursor:pointer; will-change:transform, opacity;
    background:transparent;
  }
  .shell.hidden{opacity:0;transform:scale(.6) translateY(-6px);pointer-events:none}
  #sand{position:absolute;inset:0;z-index:3;pointer-events:none;transition:opacity .8s ease}
  #sand.fadeout{opacity:0}

  /* キャラ＆装備 */
  #friendWrap{
    position:absolute;z-index:4;width:min(14vh,120px);min-width:80px;aspect-ratio:1/1;transform-origin:50% 80%;
    filter:drop-shadow(0 8px 12px rgba(0,0,0,.4))
  }
  #friendWrap.spin{animation:spin .5s ease}
  #friendWrap.jump{animation:jump .45s ease}
  @keyframes spin{from{transform:rotate(0deg)}50%{transform:rotate(18deg)}to{transform:rotate(0deg)}}
  @keyframes jump{0%{transform:translateY(0)}40%{transform:translateY(-10px)}100%{transform:translateY(0)}}
  #friend{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:100%;height:100%;object-fit:contain}
  .equip{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:100%;height:100%;object-fit:contain}
  /* アクセ専用レイヤ（複数同時装着可） */
  #accLayer{position:absolute;left:50%;top:50%;width:100%;height:100%;transform:translate(-50%,-50%);pointer-events:none}
  #accLayer img.acc{position:absolute;left:50%;top:50%;width:100%;height:100%;object-fit:contain;filter:drop-shadow(0 6px 10px rgba(0,0,0,.25))}

  /* 吹き出し */
  #bubble{position:absolute;z-index:9;padding:6px 10px;background:rgba(0,0,0,.7);border:1px solid rgba(255,255,255,.2);border-radius:12px;transform:translate(-50%,-120%);white-space:nowrap;opacity:0;transition:opacity .2s, transform .2s}
  #bubble.show{opacity:1;transform:translate(-50%,-140%)}

  /* プレビュー幕 */
  #previewCurtain{position:absolute;inset:0;z-index:5;background:rgba(0,0,0,.25);backdrop-filter:blur(1px);display:none}
  #previewCurtain.show{display:block}
  #backBtn{display:none}
  body.preview #backBtn{display:inline-flex}

  /* クリアオーバーレイ */
  #clearOverlay{position:absolute;inset:0;z-index:8;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,.2),rgba(0,0,0,.5))}
  #clearOverlay.show{display:flex}
  .clearCard{background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.18);padding:18px 20px;border-radius:14px;text-align:center;backdrop-filter:blur(6px)}
  .clearCard h2{font-size:20px;margin-bottom:8px}
  .clearCard p{opacity:.9;margin-bottom:12px}

  /* ===== アクセサリーパネル ===== */
  .panel{
    position:absolute;inset:0;z-index:20;display:none;align-items:center;justify-content:center;
    background:rgba(0,0,0,.45);backdrop-filter:blur(3px)
  }
  .panel.show{display:flex}
  .panelCard{
    width:min(900px,92vw);max-height:86vh;overflow:auto;background:rgba(0,0,0,.55);
    border:1px solid rgba(255,255,255,.18);border-radius:14px;padding:16px
  }
  .panelHeader{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .gridAcc{display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}
  .accChoice{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:10px}
  .accChoice img{width:88px;height:88px;object-fit:contain;display:block;margin:0 auto 6px}
  .accChoice .t{font-size:13px;text-align:center}
  .accChoice input{display:block;margin:8px auto 0}
</style>
</head>
<body>
<div class="game" id="game">
  <div class="bg"  id="bgDay"></div>
  <div class="bg2" id="bgClear"></div>

  <div id="topbar">
    <div class="pill" id="counter">貝：<b id="got">0</b>/<b id="total">0</b></div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn" id="backBtn" type="button">交換所へ</button>
      <button class="btn" id="accBtn"  type="button" title="アクセサリー">アクセ</button>
      <button class="btn" id="previewBtn" title="装備プレビュー（砂を隠す/操作不可）" type="button">プレビュー</button>
    </div>
  </div>

  <!-- シェル層 -->
  <div id="shellLayer"></div>
  <!-- 砂 -->
  <canvas id="sand"></canvas>

  <!-- キャラ＆装備 -->
  <div id="friendWrap" aria-label="friend">
    <img id="friend" alt="friend" />
    <img class="equip equip--style" data-slot="style" alt="" />
    <img class="equip equip--head"  data-slot="head"  alt="" />
    <img class="equip equip--body"  data-slot="body"  alt="" />
    <img class="equip equip--back"  data-slot="back"  alt="" />
    <img class="equip equip--hands" data-slot="hands" alt="" />
    <img class="equip equip--shoes" data-slot="shoes" alt="" />
    <div id="accLayer" aria-hidden="true"></div>
  </div>

  <div id="bubble"></div>
  <div id="previewCurtain"></div>

  <div id="clearOverlay">
    <div class="clearCard">
      <h2>コンプリート！</h2>
      <p>きれいな浜辺が姿をあらわしたよ。</p>
      <button class="btn" id="goCollection" type="button">コレクションへ</button>
    </div>
  </div>

  <!-- ===== アクセパネル ===== -->
  <div class="panel" id="accessoryPanel" aria-modal="true">
    <div class="panelCard">
      <div class="panelHeader">
        <h3>アクセサリー</h3>
        <button class="btn" id="accClose" type="button">とじる</button>
      </div>
      <div class="gridAcc" id="accList"></div>
    </div>
  </div>
</div>

<script>
/* ===== ストア（localStorage） ===== */
const store = {
  get(k, f){ try{ const v = localStorage.getItem(k); return v? JSON.parse(v): f; }catch(e){ return f; } },
  set(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} }
};

/* ===== スマートナビ（404対策） ===== */
const NAV_CANDIDATES = {
  collection: ['collection.html','./collection.html','../collection.html','scenes/collection.html','pages/collection.html','collection/index.html'],
  exchange:   ['exchange.html','./exchange.html','../exchange.html','shop/exchange.html','pages/exchange.html','exchange/index.html']
};
async function smartNavigate(key){
  const list = NAV_CANDIDATES[key] || [];
  for(const rel of list){
    const href = new URL(rel, location.href).href;
    try{ const res = await fetch(href, { method:'HEAD', cache:'no-store' }); if(res.ok){ location.href = href; return; } }catch(e){}
  }
  alert('ページが見つかりませんでした。配置を確認してください。');
}

/* ===== 便利 ===== */
const $ = s=>document.querySelector(s);
const $$=(s,root=document)=>Array.from(root.querySelectorAll(s));
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const now = ()=>performance.now();

/* ===== 背景用画像フォールバック ===== */
function loadIconWithFallback(id){
  const paths=[`public/items/ex_${id}.png`,`public/items/${id}.png`,`./public/items/${id}.png`,`/public/items/${id}.png`];
  return new Promise(res=>{ const img=new Image(); let i=0; const next=()=>{ if(i>=paths.length){res(null);return;} img.src=paths[i++]; img.onload=()=>res(img); img.onerror=next; }; next(); });
}
function emojiDataURI(emoji="🐚", size=128){
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}'><text x='50%' y='50%' font-size='${size*0.8}' dominant-baseline='central' text-anchor='middle'>${emoji}</text></svg>`;
  return `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svg)}`;
}

/* ===== アクセ画像フォールバック ===== */
function loadAccessoryWithFallback(id){
  const paths=[
    `public/accessories/${id}.png`,
    `./public/accessories/${id}.png`,
    `/public/accessories/${id}.png`,
    `public/items/accessories/${id}.png`
  ];
  return new Promise(res=>{ const img=new Image(); let i=0; const next=()=>{ if(i>=paths.length){res(null);return;} img.src=paths[i++]; img.onload=()=>res(img); img.onerror=next; }; next(); });
}

/* ===== シェル保存 ===== */
function ensureShells(){
  let s = store.get('who_shells', null);
  if(!s || s.schema!=='who_shells/v1'){ s = {schema:'who_shells/v1',updatedAt:new Date().toISOString(),items:{}}; store.set('who_shells', s); }
  return s;
}
function totalCollected(){ const s = ensureShells(); return Object.values(s.items).reduce((a,b)=>a+(b|0),0); }

/* ===== クエリ・定数 ===== */
const search = new URLSearchParams(location.search);
const isPreview = search.get('preview') === '1';
if(isPreview) document.body.classList.add('preview');

const FRIEND_OFFSET = { x: 36, y: 8 };
const FLOAT_AMPL = 6;
const FLOAT_SPEED = 0.0016;

/* ===== 装備アンカー（基準） ===== */
const ANCHOR = {
  head:{x:0, y:-38, scale:0.9},
  body:{x:0, y:-2,  scale:0.96},
  back:{x:-4,y:-8,  scale:0.94},
  hands:{x:10,y:4,  scale:0.95},
  shoes:{x:4, y:40, scale:0.92},
  style:{x:2, y:-10, scale:0.96}
};

/* ===== アクセサリー定義（直選→即装着・サイズ/位置込み） ===== */
const ACCESSORIES=[
  {key:'straw_hat',   name:'麦わら帽子',  unlockAt:3,  fit:{x:0,  y:-40, scale:0.98}}, // 頭上
  {key:'knit_hat',    name:'毛糸の帽子',  unlockAt:6,  fit:{x:0,  y:-40, scale:0.98}},
  {key:'sunglasses',  name:'サングラス',  unlockAt:10, fit:{x:0,  y:-18, scale:0.68}}, // 目の位置
  {key:'ribbon_yellow',name:'黄色いリボン',unlockAt:15, fit:{x:22, y:-28, scale:0.74}}, // 耳横
  {key:'star_yellow', name:'黄色のスター', unlockAt:20, fit:{x:28, y:-6,  scale:0.92}}  // 体の右側
];

/* ===== 画面準備 ===== */
const game = $('#game'), sand = $('#sand'), shellLayer = $('#shellLayer');
const bgClear = $('#bgClear');
const friendWrap = $('#friendWrap'), friendImg = $('#friend'), accLayer = $('#accLayer');
let cw=0, ch=0, ctx=null;
function resize(){ cw=game.clientWidth; ch=game.clientHeight; sand.width=cw; sand.height=ch; ctx=sand.getContext('2d'); drawSand(); }
window.addEventListener('resize', resize);
function drawSand(){
  if(!ctx) return;
  ctx.clearRect(0,0,cw,ch);
  ctx.fillStyle = '#D9C7A1'; ctx.fillRect(0,0,cw,ch);
  const density = Math.floor((cw*ch)/9000);
  ctx.globalAlpha=.15; ctx.fillStyle='#bca67e';
  for(let i=0;i<density;i++){ const x=Math.random()*cw, y=Math.random()*ch, r=Math.random()*1.8; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); }
  ctx.globalAlpha=1;
}

/* ===== キャラ画像 ===== */
function resolveFriendSrc(){
  const color = (localStorage.getItem('who_character') || 'pink').replace(/[^a-z]/g,'') || 'pink';
  return `public/assets/stage1/${color}_open.png`;
}

/* ===== 貝の種類（新セット） ===== */
const SHELL_DEFS = [
  {id:'asari1',         label:'アサリ（白）',         weight: 9},
  {id:'asari2',         label:'アサリ（橙）',         weight: 7},
  {id:'asari3',         label:'アサリ（大）',         weight: 5},
  {id:'aurora_shell',   label:'オーロラ貝殻',         weight: 3},
  {id:'flame_shell',    label:'フレイム貝殻',         weight: 3},
  {id:'luminous_shell', label:'ルミナス貝殻',         weight: 3},
  {id:'mystic_shell',   label:'ミスティック貝殻',     weight: 3},
  {id:'night_sky_shell',label:'夜空の貝殻',           weight: 3},
  {id:'rare_pearl',     label:'真珠',                 weight: 1},
  {id:'rare_rainbow',   label:'虹色の貝殻',           weight: 1}
];
let totalShells=0, gotShells=0;
function weightedPick(list){ const sum=list.reduce((a,b)=>a+b.weight,0); let r=Math.random()*sum; for(const it of list){ if((r-=it.weight)<=0) return it; } return list[list.length-1]; }
function placeShells(nTotal=18){
  shellLayer.innerHTML=''; const margin=64; const items=[];
  for(let i=0;i<nTotal;i++){ const p=weightedPick(SHELL_DEFS); const x=margin+Math.random()*(cw-margin*2), y=margin+Math.random()*(ch-margin*2); items.push({...p,x,y}); }
  totalShells=items.length; $('#total').textContent=totalShells;
  items.forEach(it=>{
    const el=document.createElement('img'); el.className='shell'; el.alt=it.label;
    el.style.left=`${Math.round(it.x-26)}px`; el.style.top=`${Math.round(it.y-26)}px`;
    el.dataset.cx=String(it.x); el.dataset.cy=String(it.y);
    el.draggable=false; el.setAttribute('draggable','false'); el.tabIndex=-1;
    loadIconWithFallback(it.id).then(img=>{ el.src=img?img.src:emojiDataURI('🐚',128); });
    el.addEventListener('click',ev=>{
      const cx=parseFloat(el.dataset.cx), cy=parseFloat(el.dataset.cy);
      if(isUncovered(cx,cy,28,0.55)){ collectShell(it.id,it.label,el); } else { showBubble('まだ砂が残っているよ'); }
      ev.stopPropagation();
    });
    shellLayer.appendChild(el);
  });
}

/* ===== 吹き出し ===== */
function showBubble(text){
  const b=$('#bubble'), rect=friendWrap.getBoundingClientRect();
  b.style.left=`${rect.left+rect.width*.5}px`; b.style.top=`${rect.top}px`; b.textContent=text;
  b.classList.add('show'); setTimeout(()=>b.classList.remove('show'),700);
}

/* ===== 露出判定 ===== */
function uncoverRatioAt(x,y,r=24,step=4){
  if(!ctx) return 0;
  let u=0,t=0; const rx=Math.max(0,Math.floor(x-r)), ry=Math.max(0,Math.floor(y-r));
  const rw=Math.min(cw-rx,Math.ceil(r*2)), rh=Math.min(ch-ry,Math.ceil(r*2));
  try{
    const data=ctx.getImageData(rx,ry,rw,rh).data;
    for(let j=0;j<rh;j+=step){ for(let i=0;i<rw;i+=step){ const dx=i-r, dy=j-r; if(dx*dx+dy*dy<=r*r){ const a=data[(j*rw+i)*4+3]; if(a===0) u++; t++; }}}
    return t? u/t : 0;
  }catch(e){ return 0; }
}
function isUncovered(x,y,r=24,th=0.5){ return uncoverRatioAt(x,y,r,4)>=th; }

/* ===== 収集処理 ===== */
function collectShell(id,label,el){
  if(el.classList.contains('hidden')) return;
  el.classList.add('hidden'); gotShells++; $('#got').textContent=gotShells;
  const st=ensureShells(); st.items[id]=(st.items[id]||0)+1; st.updatedAt=new Date().toISOString(); store.set('who_shells',st);
  friendWrap.classList.remove('spin'); friendWrap.classList.remove('jump'); void friendWrap.offsetWidth; friendWrap.classList.add('spin'); friendWrap.classList.add('jump');
  showBubble(`GET! ${label}`);
  refreshAccessoryLocks(); // 取得数でアンロック更新
  if(gotShells>=totalShells) onAllCollected();
}

/* ===== 砂消しゴム ===== */
let erasing=false;
function startErase(){ if(isPreview) return; erasing=true; }
function endErase(){ erasing=false; }
function eraseAt(x,y){
  if(!ctx||isPreview) return;
  ctx.save(); ctx.globalCompositeOperation='destination-out';
  const r=24,g=ctx.createRadialGradient(x,y,0,x,y,r);
  g.addColorStop(0,'rgba(0,0,0,1)'); g.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); ctx.restore();
}
game.addEventListener('pointerdown',e=>{ startErase(); eraseAt(e.clientX,e.clientY); },{capture:true});
game.addEventListener('pointermove',e=>{ if(erasing) eraseAt(e.clientX,e.clientY); },{capture:true});
window.addEventListener('pointerup',endErase,{capture:true});
game.addEventListener('touchstart',e=>{ const p=e.touches[0]; startErase(); eraseAt(p.clientX,p.clientY); },{passive:true,capture:true});
game.addEventListener('touchmove',e=>{ const p=e.touches[0]; if(erasing) eraseAt(p.clientX,p.clientY); },{passive:true,capture:true});
window.addEventListener('touchend',endErase,{capture:true});

/* ===== 追従モーション ===== */
let mx=0,my=0,fx=0,fy=0,t0=now();
function onPointerPos(e){ const p=e.touches?e.touches[0]:e; mx=p.clientX+FRIEND_OFFSET.x; my=p.clientY+FRIEND_OFFSET.y; }
['pointerdown','pointermove','touchstart','touchmove'].forEach(ev=>game.addEventListener(ev,onPointerPos,{passive:true,capture:true}));
function loop(){ const t=now(),dt=t-t0; t0=t; const f=Math.min(1,dt/1000*6); const bob=Math.sin(performance.now()*FLOAT_SPEED)*FLOAT_AMPL; fx+=(mx-fx)*f*.22; fy+=(my-fy)*f*.22;
  friendWrap.style.left=`${clamp(fx,40,cw-40)}px`; friendWrap.style.top=`${clamp(fy+bob,40,ch-40)}px`; requestAnimationFrame(loop); }

/* ===== クリア処理 ===== */
function onAllCollected(){
  $('#sand').classList.add('fadeout'); setTimeout(()=>{ $('#sand').style.display='none'; },820);
  bgClear.classList.add('show'); $('#clearOverlay').classList.add('show');
  if(!isPreview){ setTimeout(()=>smartNavigate('collection'), 1800); }
}
$('#goCollection').addEventListener('click',()=>smartNavigate('collection'));

/* ===== プレビュー切替 ===== */
$('#previewBtn').addEventListener('click',()=>{ if(!isPreview) location.href='asari.html?preview=1'; });

/* ===== 交換所へ ===== */
$('#backBtn').addEventListener('click',()=>smartNavigate('exchange'));

/* ===== アクセ：状態管理 ===== */
function getActiveAcc(){ return new Set(store.get('whoai.accessories',[])); }
function setActiveAcc(s){ store.set('whoai.accessories', Array.from(s)); }

/* アクセ画像を friend に追加（サイズ/位置を自動フィット） */
async function addAccImg(a){
  removeAccImg(a.key);
  const img = document.createElement('img');
  img.alt = a.name; img.className='acc'; img.dataset.key=a.key;
  const loaded = await loadAccessoryWithFallback(a.key);
  if(loaded) img.src = loaded.src;
  // 位置合わせ
  const base = a.fit || {x:0,y:0,scale:1};
  img.style.transform = `translate(calc(-50% + ${base.x}px), calc(-50% + ${base.y}px)) scale(${base.scale})`;
  accLayer.appendChild(img);
}
function removeAccImg(key){
  const el = accLayer.querySelector(`img.acc[data-key="${key}"]`);
  if(el) el.remove();
}
function restoreAccessories(){
  const active = getActiveAcc(); ACCESSORIES.forEach(a=>{ if(active.has(a.key)) addAccImg(a); });
}

/* ===== アクセ：UI（直接選択→即装着） ===== */
const accessoryPanel = $('#accessoryPanel'), accList = $('#accList');
function openPanel(el){ el.classList.add('show'); }
function closePanel(el){ el.classList.remove('show'); }
$('#accClose').onclick = ()=>closePanel(accessoryPanel);
$('#accBtn').onclick   = ()=>openAccessory();

function openAccessory(){
  const total = totalCollected();
  if(!accList.dataset.ready){
    ACCESSORIES.forEach(a=>{
      const div = document.createElement('div'); div.className='accChoice'; div.dataset.key=a.key;
      div.innerHTML = `
        <img src="${(loadAccessoryWithFallback(a.key).then(()=>{}), `public/accessories/${a.key}.png`)}" alt="${a.name}">
        <div class="t">
          <div style="font-weight:700">${a.name}</div>
          <div class="hint" style="font-size:12px;opacity:.8">タップで装着/解除</div>
        </div>
        <input type="checkbox">
      `;
      const cb=div.querySelector('input');
      cb.addEventListener('change',()=>toggleAccessory(a,cb.checked));
      div.addEventListener('click',e=>{ if(e.target.tagName!=='INPUT'){ cb.checked=!cb.checked; cb.dispatchEvent(new Event('change')); }});
      accList.appendChild(div);
    });
    accList.dataset.ready = '1';
  }
  const active = getActiveAcc();
  $$('.accChoice',accList).forEach(div=>{
    const a = ACCESSORIES.find(x=>x.key===div.dataset.key);
    const cb = div.querySelector('input'); const hint = div.querySelector('.hint');
    const locked = total < a.unlockAt;
    div.style.opacity = locked ? .5 : 1;
    cb.disabled = locked;
    hint.textContent = locked ? `あと ${a.unlockAt-total} 個で解放` : 'タップで装着/解除';
    cb.checked = active.has(a.key);
  });
  openPanel(accessoryPanel);
}
function toggleAccessory(a,on){
  const total=totalCollected();
  if(total<a.unlockAt){ showBubble(`あと ${a.unlockAt-total} 個で解放`); return; }
  const s=getActiveAcc();
  if(on){ s.add(a.key); addAccImg(a); } else { s.delete(a.key); removeAccImg(a.key); }
  setActiveAcc(s);
}
function refreshAccessoryLocks(){
  if(!accList.dataset.ready) return;
  const total=totalCollected();
  $$('.accChoice',accList).forEach(div=>{
    const a=ACCESSORIES.find(x=>x.key===div.dataset.key); const cb=div.querySelector('input'); const hint=div.querySelector('.hint');
    const locked=total<a.unlockAt; div.style.opacity=locked?.5:1; cb.disabled=locked; hint.textContent=locked?`あと ${a.unlockAt-total} 個で解放`:'タップで装着/解除';
  });
}

/* ===== 起動 ===== */
(function init(){
  resize();
  if(isPreview){
    $('#previewCurtain').classList.add('show');
    sand.style.opacity=.15; shellLayer.style.display='none';
  }else{
    placeShells(18);
  }
  friendImg.src = resolveFriendSrc();
  restoreAccessories(); // ← 直接選んだ装着状態を反映
  $('#got').textContent='0';
  mx=cw*.5; my=ch*.65; fx=mx; fy=my;
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
