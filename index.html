<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
  <title>WHO VQ — Start</title>

  <!-- 背景画像を先読み（パスは public/items/bg/*.jpg で統一） -->
  <link rel="preload" as="image" href="public/items/bg/sunrise.jpg" />
  <link rel="preload" as="image" href="public/items/bg/beach_day.jpg" />
  <link rel="preload" as="image" href="public/items/bg/night_beach.jpg" />

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Helvetica Neue','Arial','Hiragino Kaku Gothic ProN','Hiragino Sans','Meiryo',sans-serif;
      overflow:hidden;background:#000;color:#fff
    }
    /* 背景 */
    .bg{position:absolute;inset:0;background-size:cover;background-position:center;background-repeat:no-repeat;opacity:0;transition:opacity .6s}
    .bg.show{opacity:1}
    .bg.fallback{
      background:
        radial-gradient(ellipse at 30% 20%, rgba(255,200,100,.25), transparent 50%),
        linear-gradient(180deg,#1a365d 0%,#2d5a87 30%,#4a90c2 60%,#7bb3d9 100%);
    }
    .overlay{position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.55))}
    /* ヘッダー */
    .topbar{
      position:absolute;top:0;left:0;right:0;display:flex;justify-content:space-between;align-items:center;
      padding:16px;background:linear-gradient(180deg,rgba(0,0,0,.5),transparent);backdrop-filter:blur(8px);z-index:2
    }
    .logo{font-size:24px;font-weight:700;letter-spacing:.08em}
    .right{display:flex;gap:10px;align-items:center}
    #langSelect{
      background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.3);
      color:#fff;padding:8px 12px;border-radius:20px;cursor:pointer;font-size:14px
    }
    /* 中央 */
    .center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;z-index:2;text-align:center}
    h1{font-size:3.2rem;letter-spacing:.18em;text-shadow:0 4px 20px rgba(0,0,0,.4)}
    .subtitle{opacity:.9}
    .buttons{display:flex;flex-direction:column;gap:12px;min-width:260px}
    .btn{
      width:100%;padding:14px 24px;border:none;border-radius:999px;font-size:16px;cursor:pointer;transition:.2s;color:#fff
    }
    .btn.primary{background:#3498db}
    .btn.secondary{background:#7f8c8d}
    .btn.ghost{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.35)}
    .btn:hover{filter:brightness(1.08);transform:translateY(-1px)}
    .note{position:absolute;bottom:20px;color:#ddd;opacity:.9}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.35);background:rgba(0,0,0,.35);font-size:12px}
  </style>
</head>
<body data-page="index">
  <!-- 背景 -->
  <div id="bg" class="bg fallback"></div>
  <div class="overlay"></div>

  <!-- ヘッダー -->
  <header class="topbar">
    <div class="logo">WHO VQ</div>
    <div class="right">
      <span class="chip" id="phaseLabel">—</span>
      <select id="langSelect" aria-label="language">
        <option value="ja">日本語</option>
        <option value="en">English</option>
        <option value="zh">中文</option>
        <option value="ko">한국어</option>
      </select>
    </div>
  </header>

  <!-- メイン -->
  <main class="center">
    <h1 data-i18n="title">WHO VQ</h1>
    <p class="subtitle" data-i18n="subtitle">あなたのお世話が、誰かの世界に</p>
    <div class="buttons">
      <button class="btn ghost" id="btnStart" data-i18n="start">スタート</button>
      <button class="btn ghost" id="btnContinue" data-i18n="continue">続きから</button>
      <button class="btn ghost" id="btnAbout" data-i18n="about">研究について</button>
    </div>
    <div class="note" id="resumeNote"></div>
  </main>

  <script>
    /********** i18n **********/
    const translations = {
      ja:{title:'WHO VQ',subtitle:'あなたのお世話が、誰かの世界に',start:'スタート',continue:'続きから',about:'研究について'},
      en:{title:'WHO VQ',subtitle:"Your care becomes someone's world",start:'Start',continue:'Continue',about:'About'},
      zh:{title:'WHO VQ',subtitle:'您的关怀，成就他人的世界',start:'开始',continue:'继续',about:'关于研究'},
      ko:{title:'WHO VQ',subtitle:'당신의 돌봄이 누군가의 세상이 됩니다',start:'시작',continue:'계속하기',about:'연구 소개'}
    };
    let currentLang = localStorage.getItem('who_language') || 'ja';
    function updateTexts(){
      const t = translations[currentLang] || translations.ja;
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n'); if(t[key]) el.textContent = t[key];
      });
      document.title = `${t.title} — Start`;
    }
    function initLang(){
      document.getElementById('langSelect').value = currentLang;
      updateTexts();
      document.getElementById('langSelect').addEventListener('change',e=>{
        currentLang = e.target.value; localStorage.setItem('who_language', currentLang); updateTexts();
      });
    }

    /********** 背景（public/items/bg/*.jpg） **********/
    const BG = {
      sunrise:'public/items/bg/sunrise.jpg',
      day:'public/items/bg/beach_day.jpg',
      night:'public/items/bg/night_beach.jpg'
    };
    const LABELS = {sunrise:'朝日',day:'昼',night:'夜'};
    const PHASES = ['sunrise','day','night'];
    const bg = document.getElementById('bg');
    const phaseLabel = document.getElementById('phaseLabel');

    function inferPhase(){
      const url = new URL(location.href);
      const q = url.searchParams.get('bg'); if(q && PHASES.includes(q)) return q;
      const saved = localStorage.getItem('who_timePhase'); if(saved && PHASES.includes(saved)) return saved;
      const h = new Date().getHours();
      if(h>=5 && h<9) return 'sunrise';
      if(h>=18 || h<5) return 'night';
      return 'day';
    }
    function setBackground(phase){
      const path = BG[phase];
      const img = new Image();
      img.onload = ()=>{
        bg.style.backgroundImage = `url(${path})`;
        bg.classList.add('show'); bg.classList.remove('fallback');
        phaseLabel.textContent = `背景：${LABELS[phase]}`;
        localStorage.setItem('who_timePhase', phase);
      };
      img.onerror = ()=>{
        console.warn('背景読み込み失敗:', path);
        bg.classList.add('show'); // フォールバック表示
        phaseLabel.textContent = `背景：${LABELS[phase]}（代替）`;
      };
      img.src = path + '?v=' + Date.now(); // キャッシュ回避
    }

    /********** UI **********/
    const last = localStorage.getItem('who_lastPage');
    document.getElementById('resumeNote').textContent =
      last ? '前回のページは保存済みです。「続きから」で再開できます。'
           : '前回のページは未保存です。「スタート」から始められます。';

    document.getElementById('btnStart').onclick = ()=>{
      localStorage.removeItem('who_lastPage'); location.href='char.html';
    };
    document.getElementById('btnContinue').onclick = ()=>{
      location.href = last || 'char.html';
    };
    document.getElementById('btnAbout').onclick = ()=>{
      location.href = 'about.html';
    };

    /********** init **********/
    initLang();
    const phase = inferPhase();
    setBackground(phase);
  </script>
</body>
</html>
