<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
  <title>WHO VQ — スタート</title>
  <style>
    /* ====== Reset & Base ====== */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; background: #000; color: #fff; font-family: system-ui, "Noto Sans JP", sans-serif; }

    /* ====== Background (朝日〜柔らかいグラデ) ====== */
    .bg {
      position: fixed; inset: 0; z-index: 0; pointer-events: none;
      background:
        radial-gradient(1200px 600px at 50% 10%, rgba(255,220,160,0.45), transparent 55%),
        linear-gradient(180deg, #87ceeb 0%, #c0e4f4 40%, #e7d7b3 60%, #f0e1c6 70%, #a7895f 100%);
      filter: saturate(1.05);
    }

    /* ====== Layout ====== */
    .wrap {
      position: relative; z-index: 1;
      min-height: 100dvh; display: grid; place-items: center;
      padding: 24px;
    }
    .panel {
      width: min(960px, 92vw);
      display: grid; gap: 20px;
      grid-template-columns: 1fr;
      grid-template-areas:
        "logo"
        "preview"
        "buttons"
        "foot";
    }
    @media (min-width: 860px) {
      .panel {
        grid-template-columns: 1.2fr 1fr;
        grid-template-areas:
          "logo logo"
          "preview buttons"
          "foot foot";
        align-items: center;
      }
    }

    /* ====== Title ====== */
    .logo {
      grid-area: logo;
      text-align: center;
      text-shadow: 0 2px 18px rgba(0,0,0,.35);
    }
    .logo h1 {
      font-size: clamp(22px, 4.2vw, 44px);
      letter-spacing: .06em;
      font-weight: 800;
    }
    .logo p {
      margin-top: 6px; opacity: .85; font-size: clamp(12px, 2.4vw, 14px);
    }

    /* ====== Character Preview ====== */
    .preview {
      grid-area: preview;
      display: grid; place-items: center;
      padding: 10px;
    }
    .charStage {
      position: relative;
      /* 以前より約半分の見た目になるように控えめサイズに */
      width: clamp(140px, 28vw, 220px);
      aspect-ratio: 1 / 1;  /* 正方形ステージ */
      border-radius: 24px;
      background: rgba(0,0,0,.18);
      box-shadow: 0 10px 30px rgba(0,0,0,.25) inset, 0 12px 32px rgba(0,0,0,.18);
      overflow: visible;
    }
    .charImg,
    .accImg {
      position: absolute; inset: 0; margin: auto;
      display: block;
      width: 100%; height: 100%; object-fit: contain;
      image-rendering: auto;
      pointer-events: none;
      user-select: none;
    }
    /* サングラスは位置微調整（目の高さに） */
    .accImg.sunglasses {
      width: 78%;             /* 画像自体の横幅比率 */
      left: 50%; transform: translateX(-50%);
      top: 36%;               /* 目の高さ（必要ならここを微調整） */
      height: auto;
    }

    /* ====== Buttons ====== */
    .buttons {
      grid-area: buttons;
      display: grid; gap: 12px;
      align-content: center;
    }
    .btn {
      appearance: none; border: none; cursor: pointer;
      padding: 14px 16px; border-radius: 14px;
      font-size: clamp(14px, 2.6vw, 18px); font-weight: 700;
      transition: transform .06s ease, box-shadow .2s ease, opacity .2s ease;
      color: #101010;
      background: linear-gradient(180deg, #fff, #e9eef6);
      box-shadow: 0 4px 12px rgba(0,0,0,.24);
    }
    .btn:active { transform: translateY(2px) scale(.99); }
    .btn.secondary { background: linear-gradient(180deg, #e6f6ff, #d7ecff); }
    .btn.ghost {
      color: #fff; background: rgba(0,0,0,.28); border: 1px solid rgba(255,255,255,.2);
    }
    .hint {
      grid-area: foot; text-align: center; opacity: .85; font-size: 12px;
    }

    /* 小さめ端末の余白最適化 */
    @media (max-width: 360px) {
      .panel { gap: 14px; }
      .btn { padding: 12px 14px; }
    }
  </style>
</head>
<body>
  <div class="bg" aria-hidden="true"></div>

  <main class="wrap">
    <section class="panel">
      <header class="logo">
        <h1>WHO VQ</h1>
        <p>スタート／続きから／研究について</p>
      </header>

      <!-- キャラ＋アクセサリーのプレビュー（約半分サイズ） -->
      <div class="preview">
        <div class="charStage" aria-label="選択中キャラクタープレビュー">
          <img id="charImg" class="charImg" alt="character" src="public/assets/stage1/blue_open.png">
          <!-- サングラス：必要時のみ表示 -->
          <img id="accGlasses" class="accImg sunglasses" alt="sunglasses" src="public/assets/accessories/sunglasses.png" style="display:none;">
        </div>
      </div>

      <!-- 操作ボタン -->
      <div class="buttons">
        <button id="btnStart" class="btn">スタート</button>
        <button id="btnContinue" class="btn secondary">続きから</button>
        <button id="btnAbout" class="btn ghost">研究について</button>
      </div>

      <p class="hint">※「続きから」は直前のゲーム画面へ遷移します（about は対象外）。</p>
    </section>
  </main>

  <script>
    // ========= 設定 =========
    const FALLBACK_GAME_ENTRY = 'char.html'; // 続きからの最終フォールバック
    const ALLOWED_GAME_PAGES = [
      'char.html', 'asari.html', 'collection.html', 'accessory.html',
      'whoai_talk.html', 'macaron_select.html', 'appearance.html'
      // 必要に応じて追記
    ];

    // ========= 要素取得 =========
    const btnStart = document.getElementById('btnStart');
    const btnContinue = document.getElementById('btnContinue');
    const btnAbout = document.getElementById('btnAbout');

    const charImg = document.getElementById('charImg');
    const accGlasses = document.getElementById('accGlasses');

    // ========= 画像パス解決（規約：必ず public/ 起点） =========
    function charSpriteFromStorage() {
      // 互換性：以前のキー who_character / whoai_character をどちらも見る
      const raw =
        localStorage.getItem('whoai_character') ??
        localStorage.getItem('who_character');

      // 既定は blue
      let color = 'blue';
      try {
        if (raw) {
          const v = JSON.parse(raw);
          // 文字列だった場合（例: "blue"）
          if (typeof v === 'string') color = v;
          // オブジェクトの場合（{ color: "blue", ... }）
          else if (v && typeof v.color === 'string') color = v.color;
        }
      } catch(e) {
        // 文字列保存などに備え、失敗時は既定値
      }
      // 既存ルール：stage1/{color}_open.png
      return `public/assets/stage1/${color}_open.png`;
    }

    function accessoriesFromStorage() {
      // 互換性：whoai_accessories or who_accessories
      const raw =
        localStorage.getItem('whoai_accessories') ??
        localStorage.getItem('who_accessories');
      try {
        return raw ? JSON.parse(raw) : {};
      } catch(e) {
        return {};
      }
    }

    // ========= 続きからページ判定 =========
    function resolveContinueTarget() {
      const last = (localStorage.getItem('whoai_lastPage') || '').trim();
      // index.html / about.html / 空は除外
      const invalid = !last ||
        last === 'index.html' ||
        last === '/index.html' ||
        /about\.html$/i.test(last);

      if (invalid) {
        // 直近のゲーム系最終ページを別キーで持っていれば優先
        const lastGame = (localStorage.getItem('whoai_lastGamePage') || '').trim();
        if (ALLOWED_GAME_PAGES.includes(lastGame)) return lastGame;
        return FALLBACK_GAME_ENTRY;
      }
      // パス断片だけが来た想定（/path/xxx.html 対応）
      const file = last.split('/').pop();
      if (ALLOWED_GAME_PAGES.includes(file)) return file;

      // 許可外ならフォールバック
      return FALLBACK_GAME_ENTRY;
    }

    // ========= 画面初期化 =========
    function initPreview() {
      // キャラ本体
      charImg.src = charSpriteFromStorage();

      // サングラス装着可否
      const acc = accessoriesFromStorage();
      const hasGlasses = !!(acc && (acc.sunglasses === true || acc['sunglasses'] === 'true'));
      accGlasses.style.display = hasGlasses ? 'block' : 'none';

      // （必要なら微調整フック：キャラ色によるオフセット差）
      // 例：色ごとに目の位置が違う場合はここで top/width を上書き
      // const color = /stage1\/(.+?)_open\.png/.exec(charImg.src)?.[1] ?? 'blue';
      // if (color === 'pink') { accGlasses.style.top = '35%'; accGlasses.style.width = '76%'; }
    }

    // ========= ボタン挙動 =========
    btnStart.addEventListener('click', () => {
      // スタートはキャラ選択へ
      location.href = 'char.html';
    });

    btnContinue.addEventListener('click', () => {
      const target = resolveContinueTarget();
      location.href = target;
    });

    btnAbout.addEventListener('click', () => {
      location.href = 'about.html';
    });

    // indexはゲーム進行ページではないが、念のため記録を汚さないよう空書き込みはしない
    // 各ページ側で以下を入れてください（例：asari.htmlなど）
    // localStorage.setItem('whoai_lastPage', 'asari.html');
    // さらにゲーム系のみ、直近ゲームページも更新（about除外）
    // localStorage.setItem('whoai_lastGamePage', 'asari.html');

    // 初期化
    initPreview();
  </script>
</body>
</html>
