<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>WHOAI | Index</title>
<meta name="color-scheme" content="light dark" />
<link rel="preload" as="image" href="public/items/bg/sunrise.png" />
<style>
  :root{
    --fg:#ffffff; --shade:rgba(0,0,0,.6); --btn:rgba(255,255,255,.16);
    --btn-h:#ffffff; --muted:rgba(255,255,255,.8); --ring:rgba(255,255,255,.25);
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;overflow:hidden;color:var(--fg);
    font-family:system-ui,"Noto Sans JP","Hiragino Kaku Gothic ProN",Meiryo,sans-serif}
  body{
    background:url("public/assets/bg/sunrise.png") center/cover no-repeat fixed;
    display:flex;align-items:center;justify-content:center;
  }
  .overlay{position:fixed;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.7));
    pointer-events:none; /* ← クリックを邪魔しない */}
  .container{position:relative;z-index:1;text-align:center; padding:24px}
  h1{margin:0 0 32px;font-size:2.4rem;letter-spacing:.02em;text-shadow:0 3px 10px rgba(0,0,0,.6)}
  .menu{display:flex;flex-direction:column;gap:14px;align-items:center}
  .btn{
    appearance:none;border:1px solid var(--ring);cursor:pointer;
    padding:12px 22px;border-radius:14px;background:var(--btn);color:#fff;
    font-size:1.12rem;font-weight:800;letter-spacing:.06em;backdrop-filter:blur(4px);
    box-shadow:0 10px 24px rgba(0,0,0,.35);
    transition:transform .08s ease, filter .18s ease, background .18s ease;
    text-decoration:none; display:inline-flex; align-items:center; gap:.5em;
  }
  .btn:hover{filter:brightness(1.1)}
  .btn:active{transform:translateY(2px)}
  .btn.secondary{background:transparent}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .tips{margin-top:16px;font-size:.92rem;color:var(--muted)}
  /* 小画面 */
  @media (max-width:600px){ h1{font-size:1.9rem} .btn{width:min(82vw,420px)} }
</style>
</head>
<body>
<div class="overlay"></div>
<div class="container" role="main">
  <h1 aria-label="WHOAI タイトル">WHOAI</h1>

  <div class="menu" role="navigation" aria-label="メインメニュー">
    <!-- スタート：JSなしでも遷移できるように a 要素 -->
    <a class="btn" id="startBtn" href="char.html">▶ スタート</a>

    <!-- 続きから：JSで lastPage を解決。未設定時はdisabled -->
    <button class="btn" id="continueBtn" type="button">⟳ 続きから</button>

    <!-- 研究について -->
    <a class="btn secondary" id="aboutBtn" href="about.html">ℹ 研究について</a>
  </div>

  <div class="tips" id="lastInfo" aria-live="polite"></div>

  <noscript>
    <p class="tips">JavaScriptが無効になっています。<br>
      <a href="char.html" class="btn">スタート</a>
      <a href="about.html" class="btn secondary">研究について</a>
    </p>
  </noscript>
</div>

<script>
/* ====== 安全な LS 読み取り（JSON/生文字 両対応）====== */
function safeGetLastPage(){
  try{
    const raw = localStorage.getItem('who_last_page');
    if(!raw) return null;

    // JSON.parse できればそれを、だめなら生文字を使う
    let val;
    try{ val = JSON.parse(raw); }catch{ val = raw; }

    if(typeof val !== 'string') return null;
    val = val.trim().replace(/^"+|"+$/g,''); // 両端の余計なダブルクォート除去

    // 想定外のパスを弾く（ホワイトリスト）
    const allowed = new Set([
      'index.html','char.html','asari.html','night.html',
      'collection.html','accessory.html','about.html'
    ]);
    if(!allowed.has(val)) return null;

    return val;
  }catch(e){
    console.warn('[who_last_page] 読み取りエラー:', e);
    return null;
  }
}

/* ====== UI 初期化 ====== */
(function init(){
  const continueBtn = document.getElementById('continueBtn');
  const startBtn = document.getElementById('startBtn');
  const aboutBtn = document.getElementById('aboutBtn');
  const lastInfo = document.getElementById('lastInfo');

  // 最終ページ表示 & ボタン状態
  const last = safeGetLastPage();
  if(last){
    lastInfo.textContent = `前回のページ: ${last}`;
    continueBtn.removeAttribute('disabled');
  }else{
    lastInfo.textContent = '前回のページは未保存です。「スタート」から始められます。';
    continueBtn.setAttribute('disabled','true');
  }

  // クリック（ガード付き）
  startBtn.addEventListener('click', ()=>{ /* a要素なのでそのまま遷移 */ }, {passive:true});
  aboutBtn.addEventListener('click', ()=>{ /* a要素なのでそのまま遷移 */ }, {passive:true});

  continueBtn.addEventListener('click', ()=>{
    if(continueBtn.hasAttribute('disabled')) return;
    const dest = safeGetLastPage() || 'char.html';
    // 二重クリック防止
    continueBtn.setAttribute('disabled','true');
    location.href = dest;
  });
})();
</script>
</body>
</html>
